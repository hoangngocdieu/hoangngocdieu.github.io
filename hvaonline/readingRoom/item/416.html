<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta name="description" content="HVA Reading Room">
<meta name="keywords" content=", reading room, hva, hvaonline, hvazone, hvaforum">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="robots" content="index,follow">
<meta name="rating" content="general">
<style type="text/css">
<!-- 
@import url( "http://www.hvaonline.net/hvaonline/templates/viet/styles/style.css");
-->
</style>
<style type="text/css">
<!--
@import url("http://www.hvaonline.net/hvaonline/templates/viet/styles/en_US.css");
-->
</style>
<title> - .:: HVAOnline ::.</title>

</head>
<body class="en_US">


<!--
Original theme from phpBB (http://www.phpbb.com) subSilver
Created by subBlue design
http://www.subBlue.com
Modifications by JForum Team 
Extended and customised by HVA Team
Added more features and Black Silver theme designed by HVA
-->
<table width="100%" border="0" cols="2">
	<tr align="right">
		<td class="copyright">
			English
			| 
			<a href="/hvaonline/jforum.html?module=forums&amp;action=setLang&amp;lang=vi_VN" rel="nofollow">Vietnamese</a>
		</td>
	</tr>
</table>
<table width="100%" border="0" align="center">
	<tr>
        <td width="100%" align="center" valign="middle">
			<a href="http://www.hvaonline.net" title="[Logo]"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/hvabanner-final.gif" alt="banner" /></a>
		</td>
	</tr>

	<tr>
		<td>
<table cellspacing="0" cellpadding="0" width="80%" align="center" border="0">

		<tr height="15">
			<th colspan="2" class="thportal" align="left"><span class="readingheader">&nbsp;.::*nix::.</span></th>
		    <th class="thportal" align="center">
				<span class="readingheader">
					 Kiện Toàn Bảo Mật Cho Apache - Phần 1 <a name="topPage" id="topPage"></a>
				</span>
			</th>
		    <th class="thportal" align="right">
				<a href="/hvaonline/posts/list/0/107.html#416" target="_blank">
				<img src="/hvaonline/templates/viet/images/goright.gif" align="absbottom" border="0" alt="Go to original post" title="Go to original post"/></a> 
				<img src="/hvaonline/templates/viet/images/what.gif" align="absbottom" border="0" alt="Author: Hoàng Ngọc Diêu (conmale) - Translator:  - Entry Date: 24/02/2009 15:37:34" title="Author: Hoàng Ngọc Diêu (conmale) - Translator:  - Entry Date: 24/02/2009 15:37:34"/>
			</th>
		</tr>
</table>

<table cellspacing="0" cellpadding="5" width="80%" align="center" border="0">
		<tr>
		    <td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
							<div class="postbody"><b>Kiện Toàn Bảo Mật Cho Apache - Phần 1</b><br/> <br/> Bảo mật Apache: từng bước.<br/> Artur Maj<br/> <br/> Tài liệu này theo dạng chỉ dẫn từng bước cách cài đặt và chỉnh lý Apache 1.3.x web server với mục đích xử lý và phòng tránh các trường hợp đột nhập lúc những yếu điểm của chương trình này được khám phá.<br/> <br/> <b>Chức năng</b><br/> Trước khi bắt đầu kiện toàn bảo mật Apache, chúng ta phải xác định rõ chức năng cần thiết nào của server sẽ được xử dụng. Tính đa năng của Apache tạo ra những khó khăn để thực hiện một mô thức tổng quát với mục đích kiện toàn bảo mật cho server trong mọi trường hợp có thể được. Ðây là lý do tài liệu này dựa trên các chức năng sau:<br/> <br/>     * Web server có thể truy cập từ Internet; và,<br/>     * Chỉ những trang HTML tĩnh (static HTML pages) sẽ được phục vụ,<br/>     * Server hỗ trợ tên miền cho cơ chế dịch vụ ảo,<br/>     * Các trang web đã ấn định chỉ có thể truy cập từ các cụm IP addresses hoặc người dùng (khai báo căn bản),<br/>     * Server sẽ tường trình trọn bộ các thỉnh cầu (bao gồm những thông tin về các web browsers).<br/> <br/> Ðiều đáng nhấn mạnh ở đây là mô hình trên không hỗ trợ PHP, JSP, CGI hoặc bất cứ công nghệ nào khác có thể tạo cơ hội tương tác đến các dịch vụ Web. Ứng dụng cho những công nghệ trên có thể dẫn đến những đe dọa to lớn cho vấn đề bảo mật, dù chỉ là một đoạn script nhỏ, kín đáo cũng có thể giảm thiểu mức triệt để bảo mật của server. Tại sao? trước hết, các ứng trình ASP/CGI có thể chứa những yếu điểm bảo mật (ví dụ SQL injection, cross-site-scripting). Kế tiếp, chính các kỹ nghệ ấy có thể nguy hiểm (các yếu điểm trong PHP, các module của Perl v..v..). Ðó là lý do tại sao tôi mạnh mẽ đề nghị xử dụng những công nghệ ấy chỉ khi nào nhu cầu tương tác với một web site hoàn toàn cần thiết mà thôi.<br/> <br/> <b>Lời bàn và mở rộng:</b><br/> Việc kiện toàn bảo mật cho một web server liên quan đến nhiều thủ thuật ở nhiều mức độ khác nhau. Tác giả chuộng nguyên tắc &quot;tối thiểu&quot; để giảm thiểu những lỗ hổng bảo mật có thể hiện diện trên một web server. Lý thuyết mà nói, nguyên tắc này đưa đến những ứng dụng và chỉnh định chặt chẽ hơn cho vấn đề bảo mật. Tuy nhiên, hoạt tính và nhu cầu làm việc của một web server không thể dừng lại ở khuôn khổ &quot;tối thiểu&quot; và bị áp đặt trong giới hạn các trang static HTML được. Thiết kế một chương trình làm việc cho web với yêu cầu đa năng và đa hoạt là một trong những yêu cầu hàng đầu. Một web site chỉ chuyên chú ở khuôn khổ các trang static HTML không những giới hạn tính năng của các trang web này một cách đáng kể, mà còn sa lầy trên mặt thực dụng và giá trị kinh tế lẫn giá thành xây dựng và bảo trì cho website. Giải pháp tối ưu có lẽ là sự cân bằng giữa kiến thức kiện toàn bảo mật cho web server cộng với khả năng thiết kế web một cách khoa học và vững chãi về mặt tính năng, hoạt động lẫn mặt giảm thiểu lỗi thiết kế, lỗi lập trình.<br/> <br/> Một trong những hạn chế hay đúng hơn là lối mòn thường gặp trong các thiết kế ứng dụng web là việc pha trộn lẫn lộn các phân đoạn làm việc với nhau. Nói một cách khác, các thiết kế gia và các lập trình viên không đầu tư đủ thời gian để nghiên cứu, phân tích và áp dụng các mẫu thiết kế hợp lý cho công trình của mình mà thường đi thẳng vào bước thực hiện. Các bước &quot;đi thẳng&quot; thường thiếu độ chín chắn trong bước thiết kế, dẫn đến tính năng hạn hẹp và mở cửa cho các lỗi bảo mật nghiêm trọng. Trên thực tế, sự khác biệt giữa việc làm cho một web site chạy được và làm cho một web site chạy được, chạy có hiệu xuất, có khả năng mở rộng và bảo đảm mật tính là chuyện khác nhau một trời một vực. Thói quen &quot;xào nấu&quot; các lệnh điều tác cho một hệ điều hành hoặc các lệnh tương tác đến database trực tiếp từ một trang html trần trụi, nhúng các lệnh điều tác vào php, jsp, asp... là chuyện rất thường gặp. Ðây là một ví dụ điển hình cho cái gọi là &quot;chạy được nhưng thiếu hiệu xuất, thiếu khả năng mở rộng và mở cửa cho các lỗi bảo mật quan trọng&quot;.<br/> <br/> Vì khuôn khổ bài viết không tiện đi sâu vào các mẫu thiết kế cho những ứng dụng web, các bạn nên nghiên cứu thêm về những thiết kế này ở một số url sau tùy theo công nghệ bạn đang dùng:<br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.object-arts.com/EducationCentre/Overviews/MVC.htm</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.enode.com/x/markup/tutorial/mvc.html</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.phppatterns.com/index.php/article/articleview/19/1/1/</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.dmbcllc.com/asp_mvc.aspx</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.jdance.com/jsparchitecture.shtm</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.redbooks.ibm.com/abstracts/sg245755.html</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.redbooks.ibm.com/abstracts/sg245754.html</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/> Bạn có thể dùng google để search thêm các tài liệu về MVC với keyword: &quot;MVC Pattern&quot; hoặc tham khảo một số tài liệu chuyên ngành từ các website lớn như<span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://java.sun.comhoặc</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.ibm.com.</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/> <br/> <b>Những trù bị bảo mật</b><br/> Một trong những nhân tố quan trọng nhất cho mọi công trình điện toán là việc xác thực các trù bị bảo mật. Ðiều này phải được thoả mãn trước khi công trình được ứng tạo. Các trù bị bảo mật cho web server của chúng ta như sau:<br/> <br/>     * Hệ điều hành phải được kiện toàn càng chặt chẽ càng tốt, bao gồm việc phòng bị cho những tấn công từ bên ngoài lẫn bên trong,<br/>     * Server không được cung cấp bất cứ dịch vụ nào khác ngoại trừ HTTP: (80/TCP),<br/>     *<br/>       Truy cập từ xa đến server phải được khiển tác bởi tường lửa, thiết bị này chặn trọn bộ những tiếp nối cho lối ra và cho phép những tiếp nối cho lối vào đến cổng 80/TCP của web server mà thôi,<br/>     *<br/>       Web server Apache là dịch vụ duy nhất hiện hữu trên hệ thống,<br/>     *<br/>       Chỉ có những modules nào tuyệt đối cần thiết mới được cho phép hoạt động,<br/>     *<br/>       Các trang web dùng cho công tác chẩn xét và tự động hoá mục lục phải được tắt bỏ,<br/>     *<br/>       Srver nên giảm thiểu tối đa vấn đề tiết lộ những thông tin của chính server (mật tính qua ẩn tính),<br/>     *<br/>       Apache server phải chạy bằng UID/GID riêng biệt (tín chỉ cá nhân, tín chỉ nhóm), không được dùng bất cứ process nào khác của hệ thống,<br/>     *<br/>       Các process của Apache phải có giới hạn nhất định đến hệ thư mục (chrooting); và,<br/>     *<br/>       Không có bất cứ chương trình dạng shell nào hiện hữu trong môi trường chrooted (/bin/sh, /bin/csh, v..v..).<br/> <br/> <b>Lời bàn và mở rộng:</b><br/> Một lần nữa tác giả đẩy mạnh tính &quot;tối thiểu&quot;. Tuy nhiên, điểm khác biệt trong tính &quot;tối thiểu&quot; ở phần này thuộc bình diện môi trường hơn là giảm thiểu hoạt tính của web server Apache.<br/> <br/> Bước kiện toàn bằng cách chỉ cho phép port 80/TCP trên server chạy Apache là thao tác căn bản cần phải làm vì nếu tấn công, tin tặc chỉ có một cổng để tấn công và để phòng thủ, người bảo vệ chỉ tập trung đến một cổng. Hơn thế, với cơ chế kiểm soát của tường lửa như tác giả đề nghị, tính bảo mật chắc chắn sẽ được nâng cao. Ở đây tác giả không đề cập một cách cụ thể loại tường lửa nào nên dùng vì quy trình chọn lựa, chỉnh định một tường lửa cho thích hợp phụ thuộc vào nhiều yếu tố khá phức tạp. Ðể mở rộng chi tiết này, tôi tin rằng sự hiện diện của một stateful firewall vừa có khả năng kiểm soát state ở tầng IP vừa có khả năng kiểm soát nội dung ở tầng application là cách tốt nhất. Nếu điều kiện tài chính cho phép, một stateful firewall như CheckPoint FW-1 hoặc Cisco PIX có thể đóng vai trò quan trọng này. Nếu điều kiện tài chính không cho phép, phương pháp tích hợp một số chương trình mở nguồn để đạt được khả năng tương tự vẫn có thể được, tuy nhiên sẽ mất nhiều nhân lực và thời gian hơn để điều chỉnh và thử nghiệm nếu chưa có nhiều kinh nghiệm trong lĩnh vực này.<br/> <br/> <b>Cài đặt hệ điều hành</b><br/> Trước khi cài đặt Apache, chúng ta phải chọn lấy một hệ điều hành, đó là môi trường Apache sẽ hoạt động. Ở đây chúng ta có khá nhiều chọn lựa vì Apache có thể được biên dịch và cài đặt trên hầu hết các hệ điều hành. Phần còn lại của tài liệu này chỉ dẫn cách bảo mật Apache server trên nền FreeBSD (4.7), tuy nhiên các phương pháp được mô tả ở đây có thể ứng dụng trong hầu hết các hệ điều hành UNIX/LINUX. Chỉ có một hệ điều hành duy nhất tôi không giới thiệu là MS Windows - lý do chính là vì hệ điều hành này bị giới hạn khả năng kiện toàn bảo mật cho Apache.<br/> <br/> Bước đầu tiên trong vấn đề bảo mật Web server là kiện toàn hệ điều hành. Các thảo luận kiện toàn hệ điều hành vượt quá khuôn khổ tài liệu này. Tuy vậy, có rất nhiều tài liệu trên Net miêu tả cách thực hiện vấn đề ấy. Ðộc giả được khuyến khích khai phá các vấn đề liên hệ đến phạm vi này.<br/> <br/> Sau khi hệ thống được cài đặt và kiện toàn, chúng ta cần thêm một nhóm và một người dùng thông thường gọi là &quot;apache&quot; tương tự như thế này (một ví dụ từ FreeBDS):<br/> <br/> pw groupadd apache<br/> pw useradd apache -c &quot;Apache Server&quot; -d /dev/null -g apache -s /sbin/nologin<br/> <br/> Theo mặc định, các process thuộc Apache chạy với chủ quyền của người dùng nobody (ngoại trừ process chính phải chạy với chủ quyền root) và GID thuộc nhóm nogroup. Ðiều này có thể dẫn đến những đe dọa bảo mật nghiêm trọng. Trong trường hợp đột nhập thành công, tin tặc có thể lấy được quyền truy dụng đến những process khác chạy cùng UID/GID. Bởi thế, giải pháp tối ưu là cho Apache chạy bằng UID/GID từ nhóm riêng biệt, chuyên chú đến software ấy thôi.<br/> <br/> <b>Lời bàn và mở rộng:</b><br/> Ðối với những ai quen dùng *nix hẳn không lạ gì với khái niệm UID/GID thuộc chế độ &quot;file permission&quot;. Tuy nhiên, chi tiết này nên mở rộng một tí cho những bạn đọc chưa quen thuộc với UID/GID. Phần tạo nhóm (group) và người dùng (user) riêng cho Apache ở trên có hai chi tiết cần chú ý là:<br/> -d /dev/null: không cho phép user Apache có thư mục $HOME nhưng những user bình thường khác<br/> -s /sbin/nologin: không cho user Apache dùng bất cứ một shell nào cả. Có một số trường hợp dùng -s /bin/true thay vì nologin ở trên, true là một lệnh không thực thi gì cả và hoàn toàn vô hại.<br/> <br/> Lý do không cho phép user Apache có thư mục $HOME và không được cấp một &quot;shell&quot; nào cả vì nếu account Apache này bị nhân nhượng, tin tặc cũng không có cơ hội tiếp cận với system ở mức độ cần thiết cho thủ thuật gia tăng chủ quyền. Trên môi trường *nix nói chung, &quot;shell&quot; là giao diện giữa người dùng và hệ thống, không có shell thì không có cơ hội tiếp cận xa hơn.<br/> <br/> <b>Chuẩn bị software</b><br/> Bước kế tiếp là bước tải phiên bản Apache mới nhất từ web site Apache <span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://httpd.apache.org</span></span></span></span></span></span></span></span></span></span></span></span></span></span>). Chỉ có một số chọn lựa tiện ích được phép hoạt động trong quá trình biên dịch mà thôi, bởi thể, quyết định tải mã nguồn về biên dịch thay vì tải bản nhị phân (binary) là điều hết sức quan trọng.<br/> <br/> Sau khi tải software về, chúng ta phải xả nén. Kế tiếp, chúng ta quyết định modules nào được phép hoạt động. Bản tường trình tổng quan về các modules hiện hữu cho phiên bản mới nhất của Apache 1.3.x (1.3.27 [1]) có ở:<span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://httpd.apache.org/docs/mod/</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/> <br/> <b>Những modules của Apache</b><br/> Chọn lựa các modules là một trong những bước quan trọng nhất trong vấn đề bảo mật Apache. Chúng ta nên theo luật: càng ít càng tốt. Ðể thoả mãn chức năng và những trù bị bảo mật, các modules sau cần được cho phép:<br/> <br/> Tên module<br/> <b>httpd_core</b>: Chứa các chức năng cốt lõi của Apache, cần thiết cho bất cứ Apache nào.<br/> <br/> <b>mod_access</b>: Cung cấp chế độ khiển tác dựa trên tên máy, địa chỉ IP, hoặc các tính chất yêu cầu thuộc về các clients. Bởi vì module này cần cho các chỉ phối (directive) &quot;order&quot;, &quot;allow&quot; và &quot;deny&quot;, nó cần được cho phép.<br/> <br/> <b>mod_auth</b>: Cần thiết để ứng dụng vấn đề khai báo người dùng cho việc sử dụng các hồ sơ nguyên bản (khai báo căn bản cho HTTP), được chỉ định trong chức năng trù bị.<br/> <br/> <b>mod_dir</b>: Cần thiết để tìm kiếm và phục vụ các hồ sơ thư mục: &quot;index.html&quot;, &quot;default.htm&quot;, v..v..<br/> <br/> <b>mod_log_config</b>: Cần thiết để ứng hiệu báo cáo những yêu cầu thực hiện đến server.<br/> <br/> <b>mod_mime</b>: Cần thiết để chỉnh lý nhóm chữ cái, mã hoá nội dung, tùy tác, ngôn ngữ nội dung và các loại MIME đại diện cho các loại tài liệu.<br/> <br/> Tất cả các modules khác của Apache phải được tắt bỏ. Chúng ta có thể tắt bỏ chúng một cách an toàn bởi vì chúng ta không cần đến chúng. Do tắt bỏ những modules không cần thiết, chúng ta tránh được trường hợp có thể bị đột phá khi những yếu điểm bảo mật vừa được khám phá thuộc về một trong những modules này.<br/> <br/> Cũng nên nhắc đến là có hai modules của Apache có thể nguy hiểm hơn các modules khác là: mod_autoindex và mod_info. Module thứ nhất cung cấp chức năng tự động sắp xếp thư mục và module này được phép chạy theo mặc định. Có thể dễ dàng dùng nó để xác định xem Apache được dùng trên một server nào đó hay không (ví dụ:<span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://server_name/icons/</span></span></span></span></span></span></span></span></span></span></span></span></span></span>) và để lấy nội dung của các thư mục trên Web server dẫu không có các mục lục trong những thư mục này. Module thứ nhì, mod_info không nên cho phép truy cập từ Internet chính vì lý do nó tiết lộ cấu hình của Apache.<br/> <br/> Câu hỏi kế tiếp là làm sao biên dịch các modules. Phương pháp tĩnh được xem là lựa chọn tốt hơn hết. Nếu những yếu điểm của Apache vừa được khám phá, có lẽ chúng ta sẽ không những tái biên dịch các modules bị lỗi mà sẽ tái biên dịch trọn bộ software. Chọn phương pháp tĩnh, chúng ta triệt tiêu nhu cầu của thêm một module nữa - mod_so.<br/> <br/> <b>Lời bàn và mở rộng:</b><br/> Chọn lựa các modules cho Apache server thích hợp với từng nhu cầu là một việc khó khăn và mất thời gian. Chọn lựa đúng module và bảo đảm tính bảo mật lại càng khó khăn hơn. Ðể xác định module nào cần thiết và bảo đảm, việc chọn lựa và theo dõi &quot;bug track&quot; cho từng module là một điều rất cần thiết. Hiện nay có trên 200 modules lớn nhỏ, đủ loại chức năng cho Apache server. Bạn nên tham khảo thông tin ở website này cho công tác lựa chọn:<span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://modules.apache.org/</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/> <br/> Website trên có sẵn search engine giúp bạn trong việc khảo sát và lựa chọn modules.<br/> <br/> <b>Biên dịch software</b><br/> Trước tiên - nếu có bất cứ miếng vá (patch) nào cho bảo mật thì phải thực hiện ngay. Sau đó, server được biên dịch và cài đặt như sau:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>./configure --prefix=/usr/local/apache --disable-module=all --server-uid=apache --server-gid=apache --enable-module=access --enable-module=log_config --enable-module=dir --enable-module=mime --enable-module=auth</pre><br/> 		</div><br/> (lệnh trên trải dài trong 1 dòng, không tách rời ra thành nhiều dòng)<br/> <br/> <b>make<br/> su<br/> umask 022<br/> make install<br/> chown -R root:sys /usr/local/apache</b><br/> <br/> <b>Lời bàn và mở rộng:</b><br/> Ðối với các bạn chưa làm quen hoặc chỉ mới bắt đầu làm quen đến *nix, khái niệm biên dịch software có lẽ khá mới mẻ và lạ lẫm. Tuy nhiên, cảm giác này chỉ ở bước đầu trong quá trình làm quen mà thôi. Hầu như các bước trong phân đoạn &quot;biên dịch software&quot; cho các software khác nhau đều tương tự như nhau.<br/> <br/> Ðiều lý thú trong vấn đề &quot;biên dịch software&quot; trên phương diện bảo mật ở đây, ngoài cơ hội có thể xem mã nguồn, tìm lỗi, tìm lổ hổng từ mã nguồn, bạn còn có cơ hội thiết lập và biên dịch software mình cần theo ý muốn. Trong đoạn lệnh ./configure ở trên minh hoạ cụ thể tính &quot;tự do&quot; ở chỗ bạn có toàn quyền muốn thêm hoặc bớt module tùy thích. Tính linh động trong vấn đề biên dịch software và tính đóng kín khi dùng một &quot;installshield&quot; trở nên hiển nhiên khi đem ra so sánh. Khi bạn phải cài một software gồm các binaries đã được biên dịch (theo khuôn khổ nào đó) sẵn, bạn không có nhiều cơ hội quyết định hoặc chọn lựa theo ý muốn nữa. Ðây là một trong những nguyên tắc khá quan trọng cho những ai quan tâm hoặc làm việc trực tiếp đến vấn đề bảo mật.<br/> <br/> Ðổi &quot;root&quot; của server<br/> Bước kế tiếp giới hạn các process của Apache truy dụng vào các hệ thống hồ sơ. Chúng ta có thể thực hiện vấn đề này bằng cách &quot;chrooting&quot; phần daemon chính của server (httpd). Tổng thể mà nói, thủ thuật &quot;chrooting&quot; có nghĩa là tạo một cấu trúc nguồn thư mục mới, dời chuyển các hồ sơ daemon vào đó và chạy các daemon thích ứng trong môi trường mới này. Nhờ vào đó, daemon (và cái process con) chỉ sẽ truy dụng đến cấu trúc thư mục mới.<br/> <br/> Chúng ta bắt đầu chu trình này bằng cách tạo ra một thư mục mới bên trong thư mục /chroot/httpd:<br/> <br/> <b>mkdir -p /chroot/httpd/dev<br/> mkdir -p /chroot/httpd/etc<br/> mkdir -p /chroot/httpd/var/run<br/> mkdir -p /chroot/httpd/usr/lib<br/> mkdir -p /chroot/httpd/usr/libexec<br/> mkdir -p /chroot/httpd/usr/local/apache/bin<br/> mkdir -p /chroot/httpd/usr/local/apache/logs<br/> mkdir -p /chroot/httpd/usr/local/apache/conf<br/> mkdir -p /chroot/httpd/www</b><br/> <br/> Chủ nhân của các thư mục trên phải là root và quyền truy dụng nên chỉnh lý ở mức 0755. Kế tiếp, chúng ta tạo hồ sơ thiết bị đặc biệt /dev/null:<br/> <br/> <b>ls -al /dev/null<br/>           (crw-rw-rw- 1 root wheel 2, 2 Mar 14 12:53 /dev/null)<br/> mknod /chroot/httpd/dev/null c 2 2<br/> chown root:sys /chroot/httpd/dev/null<br/> chmod 666 /chroot/httpd/dev/null</b><br/> <br/> Một phương pháp khác cần dùng để tạo thiết bị /chroot/httpd/dev/log, thiết bị này cần thiết để server làm việc đúng mức. Trong trường hợp hệ thống FreeBSD, cần thêm dòng sau đây vào /etc/rc.conf:<br/> <br/> <b>syslogd_flags=&quot;-l /chroot/httpd/dev/log&quot;</b><br/> <br/> Chúng ta phải tái khởi động hệ thống hoặc chính syslogd daemon để ứng tác các thay đổi. Ðể tạo thiết bị /chroot/httpd/dev/log trên các hệ điều hành khác, chúng ta phải xem các phần chỉ dẫn thích đáng (man syslogd).<br/> <br/> Bước kế tiếp là bước sao chép chương trình httpd chính vào cấu trúc cây mới tạo ở trên, bao gồm các hồ sơ nhị phân và các thư viện cần thiết. Ðể thực hiện bước này, chúng ta phải chuẩn bị danh sách của các hồ sơ cần thiết. Chúng ta có thể tạo nên danh sách ấy bằng cách sử dụng lệnh như sau (tùy theo mỗi hệ điều hành mà các hồ sơ này hiện diện hay không):<br/> <br/> Lệnh<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>ldd &#40;All&#41;: lists dynamic dependencies of executable files or shared libraries<br/> ktrace/ktruss/kdump &#40;*BSD&#41;: Enables kernel process tracing, Displays kernel trace data<br/> sotruss &#40;Solaris&#41;: Traces shared library procedure calls<br/> strace/ltrace &#40;Linux&#41;: Traces system calls and signals<br/> strings &#40;All&#41;: Finds the printable strings in binary files<br/> trace &#40;AIX&#41;: Records selected system events<br/> trace &#40;freeware&#41; &#40;HP-UX &lt;10.20&#41;: Print system call and kernal traces of processes<br/> truss &#40;FreeBSD, Solaris, AIX 5L, SCO Unixware&#41;: Traces system calls and signals<br/> tusc &#40;freeware&#41; &#40;HP-UX&gt;11&#41;: Traces the system calls a process invokes in HP-UX 11</pre><br/> 		</div><br/> <br/> Ví dụ dùng các lệnh ldd, strings và truss như sau:<br/> <br/> <b>localhost# ldd /usr/local/apache/bin/httpd<br/> /usr/local/apache/bin/httpd:<br/>      libcrypt.so.2 =&gt; /usr/lib/libcrypt.so.2 (0x280bd000)<br/>      libc.so.4 =&gt; /usr/lib/libc.so.4 (0x280d6000)<br/> <br/> localhost# strings /usr/local/apache/bin/httpd | grep lib<br/> /usr/libexec/ld-elf.so.1<br/> libcrypt.so.2<br/> libc.so.4<br/> <br/> localhost# truss /usr/local/apache/bin/httpd | grep open<br/> (...)<br/> open(&quot;/var/run/ld-elf.so.hints&quot;,0,00) = 3 (0x3)<br/> open(&quot;/usr/lib/libcrypt.so.2&quot;,0,027757775370) = 3 (0x3)<br/> open(&quot;/usr/lib/libc.so.4&quot;,0,027757775370) = 3 (0x3)<br/> open(&quot;/etc/spwd.db&quot;,0,00) = 3 (0x3)<br/> open(&quot;/etc/group&quot;,0,0666) = 3 (0x3)<br/> open(&quot;/usr/local/apache/conf/httpd.conf&quot;,0,0666) = 3 (0x3)<br/> (...)<br/> </b><br/> Các lệnh trên nên được áp dụng không cho chương trình httpd mà còn cho trọn bộ các thư viện và các nhị phân cần thiết (các thư viện thường đòi hỏi các thư viện khác). Ðối với trường hợp hệ thống FreeBSD, các hồ sau cần được sao chép vào cấu trúc thư mục mới:<br/> <br/> <b>cp /usr/local/apache/bin/httpd /chroot/httpd/usr/local/apache/bin/<br/> cp /var/run/ld-elf.so.hints /chroot/httpd/var/run/<br/> cp /usr/lib/libcrypt.so.2 /chroot/httpd/usr/lib/<br/> cp /usr/lib/libc.so.4 /chroot/httpd/usr/lib/<br/> cp /usr/libexec/ld-elf.so.1 /chroot/httpd/usr/libexec/</b><br/> <br/> Bằng cách sử dụng lệnh truss, chúng ta cũng có thể khám phá được các hồ sơ chỉnh dụng sau cần được hiện diện trong môi trường chrooted:<br/> <br/> <b>cp /etc/hosts /chroot/httpd/etc/<br/> cp /etc/host.conf /chroot/httpd/etc/<br/> cp /etc/resolv.conf /chroot/httpd/etc/<br/> cp /etc/group /chroot/httpd/etc/<br/> cp /etc/master.passwd /chroot/httpd/etc/passwords<br/> cp /usr/local/apache/conf/mime.types /chroot/httpd/usr/local/apache/conf/</b><br/> <br/> Nên nhớ rằng từ hồ sơ /chroot/httpd/etc/passwords, chúng ta phải tháo bỏ hết các dòng ngoại trừ &quot;nobody&quot; và &quot;apache&quot;. Tương tự, chúng ta cũng phải tháo bỏ hết các dòng ngoại trừ &quot;nobody&quot; và &quot;apache&quot; trong /chroot/httpd/etc/group. Kế tiếp chúng ta phải dựng database cho mật mã như sau:<br/> <br/> <b>cd /chroot/httpd/etc<br/> pwd_mkdb -d /chroot/httpd/etc passwords<br/> rm -rf /chroot/httpd/etc/master.passwd</b><br/> <br/> Bước kế tiếp dùng để thử nghiệm httpd server xem nó chạy đúng mức trong môi trường chroot mới. Ðể thao tác vấn đề này, chúng ta phải sao chép hồ sơ chỉnh dụng mặc định của Apache và bản mẫu index.html:<br/> <br/> <b>cp /usr/local/apache/conf/httpd.conf /chroot/httpd/usr/local/apache/conf/<br/> cp /usr/local/apache/htdocs/index.html.en /chroot/httpd/www/index.html</b><br/> <br/> Sau khi sao chép các hồ sơ đề cập trên, chúng ta phải thay đổi chỉ phối DocumentRoot như được trình bày bên dưới (trong /chroot/httpd/usr/local/apache/conf/httpd.conf):<br/> <br/> <b>DocumentRoot &quot;/www&quot;</b><br/> <br/> Tiếp theo chúng ta có thể thử chạy server:<br/> <br/> <b>chroot /chroot/httpd /usr/local/apache/bin/httpd</b><br/> <br/> Nếu có trở ngại gì, tôi đề nghị phương thức phân tích log của Apache một cách sâu sát (/chroot/httpd/usr/local/apache/logs). Một cách khác là dùng lệnh sau:<br/> <br/> <b>truss chroot /chroot/httpd /usr/local/apache/bin/httpd</b><br/> <br/> Chương trình truss chắc chắn sẽ chỉ ra nguyên nhân của các trở ngại. Sau khi triệt tiêu những lỗi còn lại, chúng ta có thể thiết lập Apache server.<br/> <br/> <b>Lời bàn và mở rộng:</b><br/> Trên tinh thần bảo mật, đoạn trên là một trong những đoạn có thể cho là quan trọng nhất trong quá trình thiết lập một Apache web server. Câu hỏi được đặt ra: &quot;tại sao chroot lại quan trọng đến thế?&quot;<br/> <br/> Ðối với những ai đã quen thuộc với cấu trúc filesystem trên một *nix nào đó, thì trả lời cho câu hỏi này khá dễ dàng. Tuy nhiên, đối với những ai chưa nắm rõ cấu trúc này thì hơi khó hơn một tí. Từ câu nói ở trên &quot;Tổng thể mà nói, thủ thuật &quot;chrooting&quot; có nghĩa là tạo một cấu trúc nguồn thư mục mới, dời chuyển các hồ sơ daemon vào đó và chạy các daemon thích ứng trong môi trường mới này. Nhờ vào đó, daemon (và cái process con) chỉ sẽ truy dụng đến cấu trúc thư mục mới.&quot; có thể diễn giải như sau:<br/> <br/> - cấu trúc filesystem của *nix nói chung (có những điểm tương đồng và dị biệt, nhưng ở đây chỉ đề cập đến những điểm khái quát mà thôi), root của filesystem là điểm khởi đầu của một cấu trúc &quot;cây&quot; (tree hierachy):<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>/<br/>  |--bin<br/>  |--boot<br/>  |--dev<br/>  |--etc<br/>  |--lib<br/>  |--mnt<br/>  |--opt<br/>  |--sbin<br/>  |--tmp<br/>  |--usr<br/>  |--var<br/>  |......</pre><br/> 		</div><br/> trong đó / (root của filesystem) chứa các thư mục khác và trong các thư mục này chứa các loại software, công cụ, thông tin, cấu hình... cho cả một *nix system.<br/> <br/> - nếu một user có quyền truy cập đến / (root của filesystem) thì user ấy có cơ hội truy dụng các thông tin và công cụ trong những thư mục thuộc /. Ðể giảm thiểu và quản lý quyền truy cập của một user như Apache ở trên là điều rất khó kiện toàn cho nên &quot;chroot&quot; là phương tiện để ép người dùng chỉ được quyền truy cập và hoạt động trong một vùng nhất định nào đó, loại bỏ các trường hợp thiếu sót trong cơ chế quản lý quyền truy dụng.<br/> <br/> - sau khi áp đặt &quot;chroot&quot; cho user Apache, thay vì &quot;hắn&quot; có thể thấy và truy cập vào các thư mục thuộc loại &quot;cấm kị&quot;, &quot;hắn&quot; chỉ có thể làm việc trong khuôn khổ:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>/apache-root<br/>  |--httpd<br/>   |--dev<br/>   |--etc<br/>   |--var<br/>   |  |--run<br/>   |--usr<br/>   |  |--lib<br/>   |  |--libexec<br/>   |  |--local<br/>   |  |  |--apache<br/>   |  |  |  |--bin<br/>   |  |  |  |--logs<br/>   |  |  |  |--conf<br/>   |--www</pre><br/> 		</div><br/> như quá trình xác định trong phần bài viết trên. User Apache không có cơ hội truy cập vào các thư mục quan trọng như /etc, /bin, /sbin... sau khi đã được &quot;chroot&quot;. User Apache chỉ có thể xử dụng những thông tin nào cần thiết và vừa đủ để web server này hoạt động mà thôi. Thủ thuật &quot;chroot&quot; đôi khi còn được gọi là &quot;jail&quot; (cầm tù) theo đúng tinh thần chroot.<br/> <br/> Mọi góp ý xin gởi lên Diễn Đàn Tin Học - VNInformatics.<br/> Hẹn gặp lại các bạn!<br/> <br/>    1. &quot;Phiên bản mới nhất&quot; được tính vào thời điểm bài viết được đăng.<br/> </div>
						</td>
					</tr>

					<tr>
						<td align="left"><a href="http://digg.com/submit?phrase=2&url=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/digg.gif" align="texttop" alt="[digg]" title="[digg]"></a>
<a href="http://del.icio.us/post?url=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/delicious.gif" align="texttop" alt="[delicious]" title="[delicious]"></a>
<a href="http://www.google.com/bookmarks/mark?op=edit&output=popup&bkmk=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/google.gif" align="texttop" alt="[google]" title="[google]"></a>
<a href="http://bookmarks.yahoo.com/toolbar/savebm?opener=tb&u=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/yahoo.gif" align="texttop" alt="[yahoo]" title="[yahoo]"></a>
<a href="http://technorati.com/faves?add=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/technorati.gif" align="texttop" alt="[technorati]" title="[technorati]"></a>
<a href="http://reddit.com/submit?url=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/reddit.gif" align="texttop" alt="[reddit]" title="[reddit]"></a>
<a href="http://www.stumbleupon.com/submit?url=http://www.hvaonline.net/hvaonline/readingRoom/item/416.html"><img src="/hvaonline/templates/viet/images/stumbleupon.gif" align="texttop" alt="[stumbleupon]" title="[stumbleupon]"></a></td>
					</tr>
				</table>
			</td>
		</tr>

		<tr>
			<td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
						<div class="postbody"><b>Other posts in the same group:</b></div><br />
									<div class="gen"><b>Kiện Toàn Bảo Mật Cho Apache - Phần 1</b></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/417.html">Kiện Toàn Bảo Mật Cho Apache - Phần 2</a></div>
						</td>
					</tr>
				</table>
			</td>
		</tr>


		<tr>
			<td align="left" valign="top">
				<a href="#topPage"><img src="/hvaonline/templates/viet/images/goup.gif" align="absbottom" border="0" alt="Go to top" title="Go to top"></a>
				<a href="/hvaonline/posts/list/0/107.html#416" target="_blank"><img src="/hvaonline/templates/viet/images/goright.gif" border="0" align="absbottom" alt="Go to original post" title="Go to original post"></a> 
				&nbsp;
			</td>
			<td align="right">	<table cellspacing="0" cellpadding="0" border="0">
		<tr>			  
			<td nowrap="nowrap">
				<form action="" name="f" id="f" accept-charset="UTF-8">
					<select onchange="if(this.options[this.selectedIndex].value > 0){ document.location = '/hvaonline/readingRoom/show/'+ this.options[this.selectedIndex].value +'.html'; }" name="select">
						<option value="0" selected="selected">Go to Category</option>	
						<option value="0">------------------------</option>	
								<option value="1">Defense</option>
								<option value="2">Exploit</option>
								<option value="3">Reverse Engineering</option>
								<option value="4">*nix</option>
								<option value="5">Windows</option>
								<option value="6">Networking</option>
								<option value="7">Others</option>
					</select>
				</form>
			</td>
		</tr>
	</table>
</td>
		</tr>
</table>
<script type="text/javascript">
		var ctlTop = false;
		var ctlBt = false;

		function activateControllerTop()
		{
			ctlTop = !ctlTop;
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");

			if (ctlTop) {
				document.location = document.location + "#ctlTop";
			}
		}

		function activateControllerBottom()
		{
			ctlBt = !ctlBt;
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");

			if (ctlBt) {
				document.location = document.location + "#ctlBt";
			}
		}
</script>

	<tr>	
		<td align="center">
		<br>
					</td>
	</tr>

	<tr>
		<td align="center">
			<span class="copyright">Powered by JForum - Extended by <a href="MailTo:lienlac@hvaonline.net">HVAOnline</a><br>
			&nbsp;hvaonline.net&nbsp; | &nbsp;hvaforum.net&nbsp; | &nbsp;hvazone.net&nbsp; | &nbsp;hvanews.net&nbsp; | &nbsp;vnhacker.org<br>
			1999 - 2013 &copy;
			v2012|0504|218|
		  </span>
	  </td>
	</tr>
<iframe src="/hvaonline/templates/ping_session.jsp" height="0" width="0" frameborder="0" scrolling="no"></iframe>
</body>
</html>
