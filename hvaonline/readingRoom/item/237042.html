<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta name="description" content="HVA Reading Room">
<meta name="keywords" content=", reading room, hva, hvaonline, hvazone, hvaforum">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="robots" content="index,follow">
<meta name="rating" content="general">
<style type="text/css">
<!-- 
@import url( "/hvaonline/templates/viet/styles/style.css");
-->
</style>
<style type="text/css">
<!--
@import url("/hvaonline/templates/viet/styles/en_US.css");
-->
</style>
<title> - .:: HVAOnline ::.</title>

</head>
<body class="en_US">


<!--
Original theme from phpBB (http://www.phpbb.com) subSilver
Created by subBlue design
http://www.subBlue.com
Modifications by JForum Team 
Extended and customised by HVA Team
Added more features and Black Silver theme designed by HVA
-->
<table width="100%" border="0" cols="2">
	<tr align="right">
		<td class="copyright">
			English
			| 
			<a href="/hvaonline/jforum.html?module=forums&amp;action=setLang&amp;lang=vi_VN" rel="nofollow">Vietnamese</a>
		</td>
	</tr>
</table>
<table width="100%" border="0" align="center">
	<tr>
        <td width="100%" align="center" valign="middle">
			<a href="" title="[Logo]"><img src="/hvaonline/templates/viet/images/hvabanner-final.gif" alt="banner" /></a>
		</td>
	</tr>

	<tr>
		<td>
<table cellspacing="0" cellpadding="0" width="80%" align="center" border="0">

		<tr height="15">
			<th colspan="2" class="thportal" align="left"><span class="readingheader">&nbsp;.::Defense::.</span></th>
		    <th class="thportal" align="center">
				<span class="readingheader">
					 Bảo mật web server Apache với mod Security - Phần 2.1 <a name="topPage" id="topPage"></a>
				</span>
			</th>
		    <th class="thportal" align="right">
				<a href="/hvaonline/posts/list/0/38690.html#237042" target="_blank">
				<img src="/hvaonline/templates/viet/images/goright.gif" align="absbottom" border="0" alt="Go to original post" title="Go to original post"/></a> 
				<img src="/hvaonline/templates/viet/images/what.gif" align="absbottom" border="0" alt="Author: tanviet12 - Translator:  - Entry Date: 16/05/2011 08:48:08" title="Author: tanviet12 - Translator:  - Entry Date: 16/05/2011 08:48:08"/>
			</th>
		</tr>
</table>

<table cellspacing="0" cellpadding="5" width="80%" align="center" border="0">
		<tr>
		    <td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
							<div class="postbody">---------------------------------------------------------------------------------------------------------------------<br/> Xem các phần khác tại<br/> Phần 1:<span class="link"> /hvaonline/posts/list/38687.html</span><br/> Phần 3:<span class="link"> /hvaonline/posts/list/38694.html</span><br/> ---------------------------------------------------------------------------------------------------------------------<br/> <font size='+2'><b><font color='orange'>PHẦN 2: MODSECURITY</font></b></font><br/> <br/> <font color='orange'><font size='+1'><b>2.1.  GIỚI THIỆU MODSECURITY</b></font></font><br/> <br/> ModSecurity là một Opensource web application firewall được Ivan Ristic phát triển dành cho Web Server Apache. Ivan Ristic cũng là tác giả quyển sách “Mod Security Handbook”. Ông là một người có rất nhiều kinh nghiệm trong bảo vệ Web Server Apache. Ông đã có nhiều thời gian nghiên cứu Web Application Security, Web Intrusion Detection, và Security Patterns. Trước khi chuyển sang lĩnh vực security, Ivan đã có nhiều năm làm việc như một Developer, System Architect, Technical Director trong phát triển phần mềm. Ông là người sáng lập ra công ty ThinkingStone làm các dịch vụ liên quan đến web application security. <br/> Hiện tại ModSecurity sử dụng giấy phép GPL, hoàn toàn miễn phí <br/> <br/> <font size='+1'><font color='orange'><b>2.2.  CÁC KHẢ NĂNG CỦA MODSECURITY </b></font></font><br/> <br/>  <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/1.jpg' border="0"  /></div><br/> Hình  2.1 Mô hình tổng quan của ModSecurity<br/> <br/> -	<b>Request filtering</b>: Tất cả các request gửi đến web server đều được phân tích và cản lọc (filter) trước khi chúng được đưa đến các modules khác để xử lý<br/> -	<b>Understanding of the HTTP protocol:</b> ModSecurity là một tường lửa ứng dụng nên nó có khả năng hiểu được giao thức HTTP. ModSecurity có khả năng cản lọc dựa trên các thông tin ở HTTP Header hay có thể xem xét đến từng thông số hay cookies của các request...vv<br/> -	<b>POST payload analysis</b>: Ngoài việc cản lọc dựa trên HTTP Header, ModSecurity có thể dựa trên nội dung (payload) của POST requests.<br/> -	<b>Audit logging</b>: Mọi requests đều có thể được ghi lại (bao gồm cả POST) để người quản trị có thể theo dõi nếu cần.<br/> -	<b>HTTPS filtering:</b> ModSecurity có thể phân tích HTTPS.<br/> -	Compressed content filtering: ModSecurity sẽ phân tích sau khi đã giải nén các các dữ liệu được yêu cầu.<br/>  <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/2.jpg' border="0"  /></div><br/> Hình  2.2 Quá trình xử lý các request của Apache và ModSecurity<br/> <br/> Modsecurity cho phép chúng ta đặt rule tại một trong năm thời điểm trong chu kỳ xử lý của Apache như sau:<br/> <br/> 1.	<b>Phase Request Header:</b> Rule được đặt tại đây sẽ được thực hiện ngay say khi Apache đọc request header, lúc này phần request body vẫn chưa được đọc.<br/> 2.	<b>Phase Request Body:</b> Đây là thời điểm các thông tin chức năng chung đưa vào vào được phân tích và xem xét, các rule mang tính ứng dụng hướng kết nối (application-oriented) thường được đặt ở đây. Ở thời điểm này, Server đã nhận đủ các thông số của request  và phần request body đã được đọc. Modsecurity hỗ trợ ba loại mã hoá request body<br/> +	<b>application/x-www-form-urlencoded:</b> Dùng để truyền form dữ liệu<br/> +	<b>multipart/form-data</b>: Dùng để truyền file<br/> +	<b>text/xml</b>: Dùng để phân tích dữ liệu XML <br/> 3.	<b>Phase Response Header:</b> Đây là thời điểm ngay sau khi phần response header được gửi trả về cho client. Chúng ta đặt rule ở đây nếu muốn giám sát quá trình sau khi phần response được gửi đi.<br/> 4.	<b>Phase Response Body</b>: Đây là thời điểm chúng ta muốn kiểm tra những dữ liệu HTML gửi trả về.<br/> 5.	<b>Phase logging: </b>Là thời điểm các hoạt động log được thực hiện, các rules đặt ở đây sẽ định rõ việc log sẽ như thế nào, nó sẽ kiểm tra các error message log của Apache. Đây cũng là thời điểm cuối cùng để chúng ta chặn các kết nối không mong muốn, kiểm tra các response header mà chúng ta không thể kiểm tra ở phase 3 và phase 4.<br/> <br/> <font size='+1'><b><font color='orange'>2.3.  CÀI ĐẶT VÀ CẤU HÌNH</font></b></font><br/> <br/> (phần cài đặt được tham khảo từ một bài viết của forum ceh.vn, có một số chỉnh sửa cho phù hợp...)<br/> <br/> Trước khi cài đặt, chúng ta phải đảm bảo web server Apache đã hoạt động tốt. Distro Linux sử dụng là CentOS5 và phiên bản ModSecurity sử dụng là 2.5. Có thể thực hiện trên các Distro khác như Ubuntu, Fedora...<br/> -	Thực hiện tải mã nguồn về<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>wget<span class="link"> http://www.modsecurity.org/download/modsecurity-apache_2.5.11.tar.gz</span><br/> .......<br/> 01:52:06 &#40;161 KB/s&#41; - `modsecurity-apache_2.5.11.tar.gz' saved &#91;1338425/1338425&#93;</pre><br/> 		</div><br/> <br/> -	Thực hiện tra tính toàn vẹn của mã nguồn (việc này không bắt buộc nhưng chúng ta nên có thói quen kiểm tra để đảm bảo rằng mã nguồn đã không bị can thiệp vào dưới bất kỳ hình thức nào). Có thể sử dụng MD5 hay PGP để làm việc này. Ở đây sử dụng PGP<br/> +	Đầu tiên cần download chữ ký :<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>wget<span class="link"> http://www.modsecurity.org/download/modsecurity-apache_2.5.11.tar.gz.asc</span><br/> ......<br/> 02:04:38 &#40;14.8 MB/s&#41; - `modsecurity-apache_2.5.11.tar.gz.asc' saved &#91;189/189&#93;</pre><br/> 		</div><br/> <br/> +	Download Publick Key:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>gpg --keyserver pgp.mit.edu --recv-key E77B534D<br/> .....<br/> gpg: Total number processed: 1<br/> gpg:               imported: 1</pre><br/> 		</div><br/> <br/>  <br/> +	Kiểm tra chữ ký:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>gpg --verify modsecurity-apache_2.5.11.tar.gz.asc<br/> ......<br/> gpg: Good signature from "Brian Rectanus &#40;work&#41; &lt;brian.rectanus@breach.com&gt;"<br/> gpg:                 aka "Brian Rectanus &lt;brian@rectanus.net&gt;"<br/> gpg:                 aka "Brian Rectanus &#40;personal&#41; &lt;brectanu@gmail.com&gt;"</pre><br/> 		</div><br/> <br/> -	Kiểm tra thành công. Thực hiện giải nén mã nguồn:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>tar xfvz modsecurity-apache_2.5.11.tar.gz</pre><br/> 		</div><br/> <br/> -	<b>Kiểm tra các gói thư viện cần thiết, ModSecurity yêu cầu có 4 thành phần sau trước khi biên dịch :</b><br/> <br/> +	<b>apxs</b> : Kiểm tra bằng cách :<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>whereis -b apxs<br/> ......<br/> apxs: /usr/sbin/apxs</pre><br/> 		</div><br/> <br/> Nếu chưa có, chúng ta phải cài thêm gói httpd-devel (hay apache2-dev đối với dòng debian,ubuntu.. )<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>yum install httpd-devel    &#40;hoặc apt-get install apache2-dev&#41;</pre><br/> 		</div><br/> <br/> +	<b>libxml2: </b>Kiểm tra bằng cách :<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>whereis -b libxml2<br/> ......<br/> libxml2: /usr/lib/libxml2.a /usr/lib/libxml2.so /usr/include/libxml2</pre><br/> 		</div><br/> <br/> Nếu chưa có, chúng ta phải cài thêm gói libxml2-devel (hay libxml2-dev đối với debian,ubuntu...)<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>yum install libxml2-devel &#40;hoặc apt-get install libxml2-dev&#41;</pre><br/> 		</div><br/> <br/> +	<b>pcre: </b>Kiểm tra bằng cách :<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>whereis pcre<br/> ......<br/> pcre: /usr/include/pcre.h /usr/share/man/man3/pcre.3.gz</pre><br/> 		</div><br/> <br/> Nếu chưa có thì chúng ta phải cài thêm gói pcre-devel :<br/> yum install pcre-devel (hoặc apt-get install pcre-dev)<br/> <br/> +	<b>mod_unique_id:</b> Là mod thường đã được biên dịch cùng Apache. Có thể kiểm tra lại bằng cách tìm trong httpd.conf dòng:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>LoadModule unique_id_module modules/mod_unique_id.so</pre><br/> 		</div><br/> <br/> Nếu chưa có, chúng ta phải thêm vào với nội dung như trên.<br/> -	Chuyển vào thư mục chứa mã nguồn và tiến hành biên dịch :<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>cd modsecurity-apache_2.5.11/apache2/</pre><br/> 		</div><br/> <br/> +	Tạo Make file :<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>./configure<br/> ......<br/> configure: creating ./config.status<br/> config.status: creating Makefile<br/> config.status: creating build/apxs-wrapper<br/> config.status: creating mlogc-src/mlogc-batch-load.pl<br/> config.status: creating t/run-unit-tests.pl<br/> config.status: creating t/run-regression-tests.pl<br/> config.status: creating t/gen_rx-pm.pl<br/> config.status: creating t/csv_rx-pm.pl<br/> config.status: creating t/regression/server_root/conf/httpd.conf<br/> config.status: creating ../tools/rules-updater.pl<br/> config.status: creating mlogc-src/Makefile<br/> config.status: creating mod_security2_config.h</pre><br/> 		</div><br/> <br/> +	Tiến hành  biên dịch<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>make</pre><br/> 		</div><br/> <br/> Sau khi biên dịch thành công file mod_security2.so sẽ được tạo ra trong thư mục libs.<br/> <br/> -	Tích hợp ModSecurity vào Apache<br/> <br/> Để Apache nhận ra sự tồn tại của ModSecurity chúng ta cần copy mod_security2.so đến thư mục chứa <br/> modules của apache, đối với distro CentOS là /etc/httpd/modules<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>cp /libs/mod_security2.so /etc/httpd/modules/</pre><br/> 		</div><br/> <br/> Sửa lại file httpd.conf để thực hiện load module ModSecurity:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>vi  /etc/httpd/conf/httpd.conf</pre><br/> 		</div><br/> <br/> Thêm dòng<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>LoadModule security2_module modules/mod_security2.so</pre><br/> 		</div><br/> <br/> -	Quy định file cấu hình ModSecurity<br/> <br/> Chúng ta có thể cấu hình trực tiếp các thông số và rule của ModSecurity vào file httpd.conf. Nhưng để cho rõ ràng và đảm bảo không sai sót trong quá trình thực hiện - gây ảnh hưởng Apache, Chúng ta nên tạo một file cấu hình riêng và sau đó include vào.<br/> Trong CentOS các file cấu hình riêng mặc định chứa trong /etc/httpd/conf.d/<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>vi /etc/httpd/conf.d/modsecurity.conf</pre><br/> 		</div><br/> <br/> Thêm vào các thông số cấu hình cơ bản<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>&lt;IfModule security2_module&gt; <br/>  <br/> # Bat che do loc cua Modsecurity<br/> SecRuleEngine On <br/> # Thiet lap action mac dinh<br/> SecDefaultAction "phase:2,deny,log,status:404"<br/> <br/> # rule thu nghiem block tat ca request co uri chua "hacker"<br/> SecRule REQUEST_URI "hacker"<br/>  <br/> &lt;/IfModule&gt;</pre><br/> 		</div><br/> <br/> Thực hiện thử nghiệm để kiểm tra hoạt động của ModSecurity. Tiến hành tạo 2 file trong thư mục web, hacker.html và index.html chẳng hạn. Khi chúng ta truy cập vào file index.html thì trình duyệt trả về kết quả bình thường<br/> Còn khi truy cập vào hacker.html thì trình duyệt báo lỗi :<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>404 – Forbidden</pre><br/> 		</div><br/> <br/> Đó là kết quả do ModSecurity đã chặn những URI có chứa chuỗi hacker và cũng đồng nghĩa với việc ModSecurity đã hoạt động.<br/>  <br/> <font size='+1'><b><font color='orange'>2.4.  VIẾT RULES</font></b></font><br/> <br/> <font size='+1'><font color='orange'><b>2.4.1. Cú pháp SecRule</b></font></font><br/> <br/> SecRule được sử dụng để tạo các rule cho ModSecurity . Cú pháp rất đơn giản<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule Target Operator &#91;Actions&#93;</pre><br/> 		</div><br/> <br/> <b>Target (mục tiêu)</b>: Quy định cụ thể mục tiêu của request hoặc response mà chúng ta muốn kiểm tra. Trong ví dụ kiểm cơ bản được đưa ra trong phần trước, sử dụng biến có tên <b>REQUEST_URI</b>, trong đó có các URI được request trên server, để nhận diện và chặn bất cứ Client nào truy cập vào các vị trí <i>/hacker.html</i>. Hiện có hơn 70 biến có thể được sử dụng để tạo rule. <br/> <br/> Ngoài ra còn có một loại biến đặc biệt được gọi là biến collection có thể chứa nhiều đối số. Một ví dụ về collection là <b>ARGS</b>, trong đó có chứa tất cả các đối số được truyền trong một chuỗi truy vấn hoặc thông qua một request POST. <br/> <br/>  Phần <b>Operator</b> xác định phương pháp và so sánh khớp dữ liệu để kích hoạt Action. Với Operator, mặc định  là <i>@rx</i><br/> <br/> Cuối cùng, <b>Actions </b>(hành động) là một danh sách các hành động được thực hiện nếu phù hợp (matching) rule. Action có thể là allow (cho phép) hoặc deny (từ chối) các request; và quy định cụ thể các mã trạng thái (status code) khi trả về (response) cho client. Nếu không có action nào được quy định, các action mặc định của action SecDefaultAction sẽ được sử dụng (rule chứa action này thường được khai báo đầu tiên).<br/> <br/> Để làm rõ hơn, chúng ta xem ví dụ. Giả sử chúng ta là một chủ doanh nghiệp nhỏ bán sách dạy nấu ăn ở định dạng file PDF trên website. Để lôi kéo khách hàng mua sách, chúng ta cung cấp một chương mẫu có chứa các công thức nấu ăn ngon nhất trong cuốn sách, mà họ có thể tải về miễn phí để xem trước khi quyết định mua.<br/> <br/> Công việc kinh doanh đang ổn định, nhưng sau đó đột nhiên chúng ta nhận được đơn khiếu nại qua email nói rằng trang web của chúng ta rất chậm hoặc không truy cập được. <br/> <br/> Khi nhìn vào log chúng ta nhận thấy rằng, một IP kết nối tới server web tràn ngập với các request cho các chương mẫu. Các chuỗi user-agent thấy được có tên <font color='yellow'>Red Bullet Downloader </font>. <b>User-agent</b> này của các chương trình Download nhanh.<br/> <br/> Giải pháp đưa ra để giải quyết vấn đề này là dùng Mod Securiry để ngăn chặn các user-agent này download. Rules được viết như sau.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_HEADERS:User-Agent "Red Bullet" "deny,nolog"</pre><br/> 		</div><br/> <br/> Trong ví dụ trên, <b>REQUEST_HEADERS</b> là một Collection chứa tất cả các  trường trong thông điệp header (message header) được gởi đến bởi client và trong header này chứa User-agent. Vì vậy, ta sử dụng từ khoá cho user-agent là “Red Bullet” vì từ Red Bullet này thường xuyên xuất hiện trong các header được gởi đển từ client. Và Action là deny – là từ chối và nolog là không ghi lại log<br/> <br/> <font color='orange'><b>2.4.1.1. Biến và bộ chọn lọc Collection</b></font><br/> <br/> Hiện khoản hơn 70 biến có sẵn. ModSecurity sử dụng hai loại biến: biến Standard,  đơn giản chỉ chứa một giá trị duy nhất, và biến Collection, có thể chứa nhiều hơn một giá trị. Một ví dụ về một Collection là REQUEST_HEADERS, trong đó chứa tất cả các trường trong thông điệp header mà Client gởi tới Server, chẳng hạn như User-agent hoặc Referer.<br/> <br/> Để truy cập vào một trường trong collection, chúng ta ghi tên collection, tiếp theo là dấu hai chấm và sau đó là tên của trường hoặc tuỳ chọn mà chúng ta muốn truy cập. Ví dụ:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_HEADERS:Referer "bad-referer.com"</pre><br/> 		</div><br/> <br/> Trong trường hợp kiểm tra toàn bộ dữ liệu trên tất cả các collection. Ví dụ, nếu chúng ta muốn kiểm tra sự hiện diện của chuỗi script có thể sử dụng rules sau đây:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS "script"</pre><br/> 		</div><br/> <br/> Nếu muốn kiểm tra thêm các chuỗi truy vấn được gửi là <i>username=john&login=yes</i> , chúng ta có thể mở rộng rule bằng cách.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS:john|ARGS:login "script"</pre><br/> 		</div><br/> <br/> Các collection có sẵn trong ModSecutity 2.5 <br/> -	ARGS<br/> -	ENV<br/> -	FILES<br/> -	FILES_NAMES<br/> -	FILES_SIZES<br/> -	FILES_TMPNAMES<br/> -	GEO<br/> -	IP<br/> -	REQUEST_COOKIES<br/> -	REQUEST_COOKIES_NAMES<br/> -	REQUEST_HEADERS<br/> -	REQUEST_HEADERS_NAMES<br/> -	RESPONSE_HEADERS<br/> -	RESPONSE_HEADERS_NAMES<br/> -	SESSION<br/> -	TX<br/> -	USER<br/> <br/> <font color='orange'><b>2.4.1.2. Chuyển đổi giữa các Collection</b></font><br/> <br/> TX Collection còn được gọi là các Transaction collection. Chúng ta có thể sử dụng nó để tạo ra các biến phục vụ riêng cho mình.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_URI “passwd” “pass,setvar:tx.hackscore=+5”<br/> SecRule TX:HACKSCORE “@gt 10” deny</pre><br/> 		</div><br/> <br/> Trong hai rule đầu tiên sử dụng action setvar để thiết lập các biến collection. Thực hiện tạo biến hackscore và tăng giá trị lên 5 nếu rule được thực thi (matching rule).  Đến khi biến hackscore có giá trị bằng 10 thì thực thi rule thứ hai sẽ được thực thi với action là deny.<br/> <br/> (Có thể loại bỏ biến bằng cách sử dụng setvar cú pháp setvar:!tx.hackscore)<br/> <br/> <font color='orange'><b>2.4.1.3. Lưu trữ các Request</b></font><br/> <br/> Có ba loại collection trong ModSecurity được sử dụng để lưu trữ liên tục( persistent storage). Như phần trước đã trình bày, setvar giúp tạo ra một biến và gán giá trị cho nó. Tuy nhiên, biến sẽ hết hạn và không còn nữa khi các request hiện tại đã được xử lý. Trong một số trường hợp chúng ta muốn lưu trữ giá trị biến và truy cập nó cho các request sau này, có thể sử dụng kiểu lưu trữ này.<br/> <br/> Có ba collection có thể được sử dụng cho mục đích này:<br/> -	IP<br/> -	SESSION<br/> -	USER<br/> <br/> Collection <b>IP </b>được sử dụng để lưu trữ thông tin về IP của người sử dụng. Nó có thể được sử dụng để lưu trữ IP ở các trường hợp như: Số lần truy cập không thành công vào tài nguyên trên server, hoặc số lượng các request của người dùng…<br/> Trước khi sử dụng một trong các collection, chúng ta cần khởi tạo nó. Điều này được thực hiện bằng cách sử dụng các action <font color='yellow'>initcol</font>:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecAction initcol:ip=%{REMOTE_ADDR},nolog,pass</pre><br/> 		</div><br/> <br/> Để thực hiện được rule trên, phải chắc chắn đã khai báo  đường dẫn đến thư mục lưu trữ cho ModSecurity<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecDataDir /var/log/httpd/modsec_data</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.1.4. Kiểm tra nhiều biến</b></font><br/> <br/> ModSecurity có thể kiểm tra nhiều biến cùng một lúc, mục đích để kết hợp so sánh (matching) một chuỗi.<br/> Ví dụ: <br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS|REQUEST_HEADERS "park" deny</pre><br/> 		</div><br/> <br/> Dấu (|) được sử dụng để tách các tên biến. Nó cũng có nhiều chức năng logic giống như  “or” trong lập trình.<br/> <br/> <font color='orange'><b>2.4.1.5. Sử dụng dấu “ khi viết rule</b></font><br/> <br/> Chúng ta xem xét các rule sau<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_URI "secret" "deny"<br/> SecRule REQUEST_URI secret deny<br/> SecRule REQUEST_URI "secret place" deny</pre><br/> 		</div><br/> <br/> Hai rule đầu đều đúng và có tác dụng như nhau. Dấu (“) được sử dụng để chứa các cụm từ cách nhau bởi có dấu space. Các đơn từ  thì có thể dùng hoặc không dùng.<br/> Sử dụng (“) còn để nhóm các thông điệp ghi log.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_URI "secret place" "deny,log,msg:'Someone tried to access the secret place!'"</pre><br/> 		</div><br/> <br/> Nếu chúng ta muốn đặt dấu (‘) trong thông điệp cần ghi log. Thực hiện chèn dấu (\) trước dấu (‘).<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_URI "secret place"  "deny,log,msg:'Someone\'s trying to hack us!'"</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.1.6. Tạo rule kết chuỗi – chain</b></font><br/> <br/> Để kết hợp nhiều rule hoạt động liên tiếp với nhau, ta sử dụng chain.<br/> <br/> Ví dụ: Người quản trị web server muốn chặn một số người download nhiều file gây ảnh  hưởng đến web server, nhưng một số khách hàng khác cũng download mà không gây ảnh hưởng đến webserver bởi họ chỉ download vài file là xong và ta không chặn những người này. Và người quản trị server quyết định chặn những người có user-agent có chứa “Red Bullet” và IP của người này nằm trong dãy IP của một ISP xác định. Với từ chain trong action. Sử dụng nó, chúng ta có thể tạo ra một chain rule mà nếu phù hợp tất cả các rule trong chain thì action của chain sẽ được thực hiện. <br/> <br/> Ví dụ đây là rule cấm người dùng với user-agent có từ “Red Bullet”<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_HEADERS:User-agent “Red Bullet” deny</pre><br/> 		</div><br/> <br/> Rule thứ hai là chỉ những client nằm trong dãy IP  192.168.1.0-192.168.1.255:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REMOTE_ADDR “^192\.168\.1\.”</pre><br/> 		</div><br/> <br/> Để thoả mãn điều kiện đặt ra như trên, ta sử dụng rule chain để kết hợp hai rule trên:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_HEADERS:User-agent “Red Bullet” “chain,deny” SecRule REMOTE_ADDR “^192\.168\.1\.”</pre><br/> 		</div><br/> <br/> Có thể thêm nhiều rule vào chain rule. Nếu chúng ta muốn thêm điều kiện là các rule chỉ hoạt động trước 6:00 giờ tối, ta sẽ thêm một rule thứ ba <br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_HEADERS:User-agent “Red Bullet” “chain,deny”<br/> SecRule REMOTE_ADDR “^192\.168\.1\.” “chain”<br/> SecRule TIME_HOUR “@lt 18”</pre><br/> 		</div><br/> <br/> Từ<font color='yellow'> @lt</font> viết tắt của “less-than” là nhỏ hơn. Thuộc cú pháp so sánh số (matching number), sẽ được trình bày chi tiết ở phần 2.4.3.<br/> <br/> <b><font color='orange'>2.4.1.7. Rule IDs</font></b><br/> <br/> Chúng ta có thể quản lý các rule bằng cách đặt ID cho mỗi rule.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS "login" "deny,id:1000"</pre><br/> 		</div><br/> <br/> Một số cú pháp thông thường<br/> -	SecRuleRemoveById:Gỡ bỏ rule có ID là<br/> -	SecRuleUpdateActionById: Cập nhật rule có ID là<br/> </div>
						</td>
					</tr>

					<tr>
						<td align="left"><a href="http://digg.com/submit?phrase=2&url=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/digg.gif" align="texttop" alt="[digg]" title="[digg]"></a>
<a href="http://del.icio.us/post?url=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/delicious.gif" align="texttop" alt="[delicious]" title="[delicious]"></a>
<a href="http://www.google.com/bookmarks/mark?op=edit&output=popup&bkmk=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/google.gif" align="texttop" alt="[google]" title="[google]"></a>
<a href="http://bookmarks.yahoo.com/toolbar/savebm?opener=tb&u=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/yahoo.gif" align="texttop" alt="[yahoo]" title="[yahoo]"></a>
<a href="http://technorati.com/faves?add=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/technorati.gif" align="texttop" alt="[technorati]" title="[technorati]"></a>
<a href="http://reddit.com/submit?url=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/reddit.gif" align="texttop" alt="[reddit]" title="[reddit]"></a>
<a href="http://www.stumbleupon.com/submit?url=/hvaonline/readingRoom/item/237042.html"><img src="/hvaonline/templates/viet/images/stumbleupon.gif" align="texttop" alt="[stumbleupon]" title="[stumbleupon]"></a></td>
					</tr>
				</table>
			</td>
		</tr>

		<tr>
			<td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
						<div class="postbody"><b>Other posts in the same group:</b></div><br />
									<div class="gen"><a href="/hvaonline/readingRoom/item/237029.html">Bảo mật web server Apache với mod Security - Phần 1</a></div>
									<div class="gen"><b>Bảo mật web server Apache với mod Security - Phần 2.1</b></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/237061.html">Bảo mật web server Apache với mod Security - Phần 3.1</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/237044.html">Bảo mật web server Apache với mod Security - Phần 2.2</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/237063.html">Bảo mật web server Apache với mod Security - Phần 3.2</a></div>
						</td>
					</tr>
				</table>
			</td>
		</tr>


		<tr>
			<td align="left" valign="top">
				<a href="#topPage"><img src="/hvaonline/templates/viet/images/goup.gif" align="absbottom" border="0" alt="Go to top" title="Go to top"></a>
				<a href="/hvaonline/posts/list/0/38690.html#237042" target="_blank"><img src="/hvaonline/templates/viet/images/goright.gif" border="0" align="absbottom" alt="Go to original post" title="Go to original post"></a> 
				&nbsp;
			</td>
			<td align="right">	<table cellspacing="0" cellpadding="0" border="0">
		<tr>			  
			<td nowrap="nowrap">
				<form action="" name="f" id="f" accept-charset="UTF-8">
					<select onchange="if(this.options[this.selectedIndex].value > 0){ document.location = '/hvaonline/readingRoom/show/'+ this.options[this.selectedIndex].value +'.html'; }" name="select">
						<option value="0" selected="selected">Go to Category</option>	
						<option value="0">------------------------</option>	
								<option value="1">Defense</option>
								<option value="2">Exploit</option>
								<option value="3">Reverse Engineering</option>
								<option value="4">*nix</option>
								<option value="5">Windows</option>
								<option value="6">Networking</option>
								<option value="7">Others</option>
					</select>
				</form>
			</td>
		</tr>
	</table>
</td>
		</tr>
</table>
<script type="text/javascript">
		var ctlTop = false;
		var ctlBt = false;

		function activateControllerTop()
		{
			ctlTop = !ctlTop;
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");

			if (ctlTop) {
				document.location = document.location + "#ctlTop";
			}
		}

		function activateControllerBottom()
		{
			ctlBt = !ctlBt;
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");

			if (ctlBt) {
				document.location = document.location + "#ctlBt";
			}
		}
</script>

	<tr>	
		<td align="center">
		<br>
					</td>
	</tr>

	<tr>
		<td align="center">
			<span class="copyright">Powered by JForum - Extended by <a href="MailTo:lienlac@hvaonline.net">HVAOnline</a><br>
			&nbsp;hvaonline.net&nbsp; | &nbsp;hvaforum.net&nbsp; | &nbsp;hvazone.net&nbsp; | &nbsp;hvanews.net&nbsp; | &nbsp;vnhacker.org<br>
			1999 - 2013 &copy;
			v2012|0504|218|
		  </span>
	  </td>
	</tr>
<iframe src="/hvaonline/templates/ping_session.html" height="0" width="0" frameborder="0" scrolling="no"></iframe>
</body>
</html>
