<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta name="description" content="HVA Reading Room">
<meta name="keywords" content=", reading room, hva, hvaonline, hvazone, hvaforum">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="robots" content="index,follow">
<meta name="rating" content="general">
<style type="text/css">
<!-- 
@import url( "/hvaonline/templates/viet/styles/style.css");
-->
</style>
<style type="text/css">
<!--
@import url("/hvaonline/templates/viet/styles/en_US.css");
-->
</style>
<title> - .:: HVAOnline ::.</title>

</head>
<body class="en_US">


<!--
Original theme from phpBB (http://www.phpbb.com) subSilver
Created by subBlue design
http://www.subBlue.com
Modifications by JForum Team 
Extended and customised by HVA Team
Added more features and Black Silver theme designed by HVA
-->
<table width="100%" border="0" cols="2">
	<tr align="right">
		<td class="copyright">
			English
			| 
			<a href="/hvaonline/jforum.html?module=forums&amp;action=setLang&amp;lang=vi_VN" rel="nofollow">Vietnamese</a>
		</td>
	</tr>
</table>
<table width="100%" border="0" align="center">
	<tr>
        <td width="100%" align="center" valign="middle">
			<a href="" title="[Logo]"><img src="/hvaonline/templates/viet/images/hvabanner-final.gif" alt="banner" /></a>
		</td>
	</tr>

	<tr>
		<td>
<table cellspacing="0" cellpadding="0" width="80%" align="center" border="0">

		<tr height="15">
			<th colspan="2" class="thportal" align="left"><span class="readingheader">&nbsp;.::Defense::.</span></th>
		    <th class="thportal" align="center">
				<span class="readingheader">
					 Bảo mật web server Apache với mod Security - Phần 2.2 <a name="topPage" id="topPage"></a>
				</span>
			</th>
		    <th class="thportal" align="right">
				<a href="/hvaonline/posts/list/0/38690.html#237044" target="_blank">
				<img src="/hvaonline/templates/viet/images/goright.gif" align="absbottom" border="0" alt="Go to original post" title="Go to original post"/></a> 
				<img src="/hvaonline/templates/viet/images/what.gif" align="absbottom" border="0" alt="Author: tanviet12 - Translator:  - Entry Date: 17/05/2011 20:15:35" title="Author: tanviet12 - Translator:  - Entry Date: 17/05/2011 20:15:35"/>
			</th>
		</tr>
</table>

<table cellspacing="0" cellpadding="5" width="80%" align="center" border="0">
		<tr>
		    <td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
							<div class="postbody"><font size='+1'><b><font color='orange'>2.4.2. Giới thiệu về biểu thức chính quy – Regular expressions</font></b></font><br/> <font color='orange'><b>2.4.2.1. Ví dụ về các biểu thức chính quy</b><br/> </font><br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/3.jpg' border="0"  /></div><br/> Bảng  2.1 Các biểu thức chính quy<br/> <br/> Trong trường hợp muốn cả từ  <font color='yellow'>favorite</font> và  <font color='yellow'>favourite</font> đều đúng thì có thể dùng dấu chấm hỏi <font color='yellow'>?</font>để quy định có thể có hoặc có thể không ký tự <font color='yellow'>u</font>. Cú pháp sẽ là <font color='yellow'>favou?rite</font><br/> <br/> Trường hợp trên đối với một ký tự u, nếu có nhiều hơn một ký tự chúng ta có thể nhóm lại bởi hai dấu ngoặc đơn (). Ví dụ với hai từ<font color='yellow'> previous</font> và <font color='yellow'>previously</font>. Cú pháp sẽ là <font color='yellow'>previous(ly)?</font><br/> <br/> <font color='orange'><b>2.4.2.2. Các biểu thức chính quy khác</b></font><br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/4.jpg' border="0"  /></div><br/> Bảng  2.2 Các biểu thức chính quy khác<br/> <br/> Vd: <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REMOTE_USER "@within tim,john,alice"</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.2.3. Sử dụng @ rx để chặn một server từ xa </b></font><br/> <br/> Ví dụ chúng ta có 2 rule như sau<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre># Rule 1 <br/> SecRule REMOTE_HOST "@rx \.microsoft\.com$" deny<br/> # Rule 2 <br/> SecRule REMOTE_HOST "\.microsoft\.com$" deny</pre><br/> 		</div><br/> <br/> Cả hai rule đề có tác dụng như sau là chặn các host truy cập từ xa từ tập đoàn Microsoft. Mục tiêu của <font color='yellow'>@rx</font> mà bỏ qua rule thứ hai bởi hai rule đều có mục đích như nhau.<br/> <br/> <font color='orange'><b>2.4.3. So sánh số (matching number)</b></font><br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/5.jpg' border="0"  /></div><br/> Bảng  2.3 So sánh số<br/> <br/> <font color='orange'><b>2.4.4. Phases và sắp xếp rule</b></font><br/> <br/> Điều quan trọng là hiểu được việc sắp xếp rule của ModSecurity. Điều này tránh các tình huống mà mọi phương thức, hoạt động đều bất ngờ bị chặn(deny) hoặc cho phép (allow) trái với ý định.<br/> <br/> Có 5 giai đoạn (phase) <br/> <br/> 1.	REQUEST_HEADERS (phase 1)<br/> 2.	REQUEST_BODY (phase 2)<br/> 3.	RESPONSE_HEADERS (phase 3)<br/> 4.	RESPONSE_BODY (phase 4)<br/> 5.	LOGGING (phase 5)<br/> <br/> Một rule được thực hiện đúng từng phase theo thứ tự . Điều này có nghĩa là ModSecurity duyệt tất cả các rule trong phase 1 ("REQUEST_HEADERS"). Sau đó, đến phase 2…<br/> <br/> Trong mỗi phase, rule được xử lý theo thứ tự mà chúng xuất hiện trong các tập tin cấu hình. Chúng ta có thể hiểu  khi có action, ModSecurity sẽ duyệt các tập tin năm lần, một lần cho từng phase.<br/> <br/> Trong thời gian xử lý ModSecurity chỉ xem xét rule thuộc pha hiện đang xử lý, và những rule được áp dụng theo thứ tự chúng xuất hiện trong các tập tin cấu hình.<br/> <br/> Phase LOGGING đặc biệt ở chỗ nó luôn luôn được thực hiện cả khi request đã được cho phép hay từ chối trong các phase trước đó. Ngoài ra, một khi phase LOGGING bắt đầu, chúng ta không thể thực hiện bất kỳ action ngăn chặn nào vì response đã được gửi cho người truy cập.<br/> <br/> Vì vậy, chúng ta phải cẩn thận không để cho bất kỳ action nào trái quy định được truyền vào rule ở phase 5. Nếu không sẽ gây lỗi làm Apache không khởi động được. Nếu chúng ta đặt rule sau đây trước các rule thuộc phase 5 sẽ ngăn chặn được lỗi này xảy ra. (nhưng phải đặt sau các rule của phase trước đó).<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecDefaultAction "phase:5,pass"</pre><br/> 		</div><br/> <br/> <b><font color='orange'>2.4.5. Chức năng chuyển đổi</font></b><br/> <br/> ModSecurity cung cấp một số chức năng chuyển đổi mà chúng ta có thể áp dụng cho các biến và các collection. Những biến đổi được thực hiện trên một bản sao của dữ liệu được kiểm tra, có nghĩa là các HTTP request hoặc response ban đầu vẫn được giữ nguyên, không thay đổi.<br/> <br/> Chức năng này rất quan trọng. Nếu chúng ta muốn phát hiện tấn công XSS (cross-site scripting), chúng ta phải phát hiện mã JavaScript bất kể trường hợp nó được viết in hay viết thường. Để làm điều này, chức năng chuyển đổi có thể được áp dụng để so sánh một chuỗi viết hoa với chuỗi viết thường.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS "&lt;script" "deny,t:lowercase"</pre><br/> 		</div><br/> <br/> Rule trên sẽ chặn tất cả các URL chứa chuỗi <font color='yellow'>&gt;</font>;<font color='yellow'>&lt;</font>;<font color='yellow'>script</font> bất kể chữ hoa thường, vd<font color='yellow'> sCript</font>; <font color='yellow'>&gt;</font>;<font color='yellow'>&lt;</font>;<font color='yellow'>scripT</font> ..<br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/6.jpg' border="0"  /></div><br/> Bảng  2.4 Một số chức năng chuyển đổi của ModSecurity<br/> <br/> <font color='orange'>2.4.5.1. Thiết lập so sánh với @pm và @pmFromFile</font><br/> <br/> Vd: thay vì sử dụng <font color='yellow'>red|blue|green</font> ta có thể sử dụng <br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS "@pm red green blue" deny</pre><br/> 		</div><br/> <br/> Nếu có quá nhiều chuỗi muốn đặt vào, ta có thể liệt kê các chuỗi này vào một file và dùng <font color='yellow'>@pmFromFile</font><br/> <br/> Vd: Trong file /usr/log/alo.txt chứa nội dung <font color='yellow'>red green blue yellow magenta cyan orange maroon pink black white gray grey violet purple brown tan olive</font>.  Ta có rule:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS “@pmFromFile /usr/log/alo.txt”</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.6. Khoá một số request thông thường</b></font><br/> <br/> Giả sử một website khai báo thuế của chính phủ muốn tăng độ bảo mật, website này chỉ mở cửa vào ban ngày (từ 8 giờ sáng đến 5 giờ chiều). Chúng ta có thể sử dụng  biến TIME_HOUR cùng với biểu thức chính quy để thực hiện rule này.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule TIME_HOUR !^&#40;8|9|10|11|1213|14|15|16|17&#41;$ deny</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.7. Khoá một số request không thông thường</b></font><br/> <br/> Ba phương thức (method) HTTP thường được sử dụng cho request là GET, POST và HEAD. Chúng ta có thể ngạc nhiên khi biết rằng HTTP thực sự thực có rất nhiều phương thức, nếu một web server hỗ trợ WebDAV (Web-based Distributed Authoring và Versioning), tổng số method trở nên gần như 30. <br/> <br/> Ví dụ, ở đây là những phương thức request thực hiện bởi phiên bản mới nhất của Apache:<br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/7.jpg' border="0"  /></div><br/> Bảng  2.5 Các phương thức request của Apache<br/> <br/> Trừ khi chúng ta có một lý do nào đó để cho phép một số phương thức không phổ biến được vận hành. Các phương thức không phổ biến còn lại nên ngăn chặn để đề phòng các lỗ hổng trong Apache gây ra bở các phương thức này.<br/> <br/> Ví dụ: về ngăn chặn tất cả phương thức request không thông thường, chỉ để lại <b>GET, POST, HEAD</b>.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_METHOD “!^&#40;GET|POST|HEAD&#41;” “deny,status:405”</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.8. Phát hiện rò rỉ thẻ tín dụng</b></font><br/> <font color='orange'><b>2.4.8.1. Phát hiện rò rỉ thẻ tín dụng</b></font><br/> <br/> Giả sử website bán hàng của chúng ta có chứa thông tin nhạy cảm của khách hàng như địa chỉ, số thẻ tín dụng… mà họ cung cấp khi mua hàng. Sẽ rất nguy hiểm nếu hacker có thể khai thác các lỗ hổng của website và xem được những thông tin này.<br/> <br/> Cụ thể, một số lỗi như SQL injection, hacker có thể làm cho các thông tin này hiển thị trên website. Rất may mắn, ModSecurity có thể giải quyết vấn đề trên.<br/> <br/> Ý tưởng là viết rule để kiểm tra HTTP response. ModSecurity có chứa một toán tử gọi là @verifiCC dùng để kiểm tra một chuỗi số có phải là số thẻ tín dụng hay không. Nếu toán tử trả về true, chúng ta có thể chặn các response không cho gởi đến hacker, bởi vì nó có thể chứa số thẻ tín dụng. Ví dụ một rule như sau<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecResponseBodyAccess On<br/> SecRule RESPONSE_BODY "@verifyCC \d{13,16}" "phase:4,deny,t:removeWhitespace,log,msg:'Possible  credit card number leak detected'"</pre><br/> 		</div><br/> <br/> Chú thích: <font color='yellow'>{13,16}</font> nghĩa là kiểm tra các dãy số từ 13 đến 16 chữ số (số thẻ tín dụng từ 13 đến 16 số)<br/> <br/> <font color='orange'><b>2.4.8.2. Thuật toán Luhn – Kiểm tra số thẻ tín dụng</b></font><br/> <br/> ModSecurity sử dụng thuật toán Luhn để kiểm tra một dãy số liệu có phải là số thẻ tín dụng hay không<br/> Thuật toán này rất đơn giản. Chúng ta có một dãy số được xem xét có phải là số thẻ tín dụng hay không. Thực hiện đảo ngược dãy số, rồi lần lượt nhân số thứ nhất với 1, số thứ hai với 2, số thứ ba với 1, số thứ tư với 2…. Nhân đến khi hết dãy số. Sau đó tách các kết quả thu được thành các số riêng biệt có một chữ số. Rồi cộng các số này lại. Nếu kết quả đạt được chia hết cho 10 thì dãy số đó là số thẻ tín dụng.<br/> Để rõ hơn chúng  ta xem một ví dụ. Xét số thẻ tín dụng <font color='yellow'>4012888888881881</font>. Thực hiện đảo ngược dãy số thành <font color='yellow'> 1  8  8  1  8  8  8  8  8  8  8  8  2  1  0  4</font><br/>  <br/>  <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/8.jpg' border="0"  /></div><br/> <br/> Kết quả đạt được là chuỗi <font color='yellow'>116828168168168162208</font>. Cộng từng chữ số lại ta được kết quả 90<br/> <font color='yellow'>1+1+6+8+2+8+1+6+8+1+6+8+1+6+8+1+6+2+2+0+8 = 90</font><br/> <br/> Kết quả 90 chia hết cho 10, vì vậy dãy số <font color='yellow'>4012888888881881</font> là số thẻ tín dụng.<br/> <br/> <font color='orange'><b>2.4.9. Theo dõi vị trí địa lý của khách truy cập</b></font><br/> <br/> Một địa chỉ IP  có thể cung cấp thông tin về địa điểm của người truy cập vào web server trên bản đồ thế giới. Với phiên bản 2.5, ModSecurity hỗ trợ kiểm tra vị trí địa lý của khách truy cập bằng cách tham chiếu đến một cơ sở dữ liệu địa lý (cụ thể là quốc gia). <br/> <br/> Điều này rất hữu ích cho nhiều ứng dụng. Nếu như chúng ta xử lý thanh toán thẻ tín dụng và muốn vị trí người truy cập phải phù hợp với vị trí địa lý (các quốc gia) mà thẻ tín dụng đã được ban hành. Nếu một thẻ tín dụng Việt Nam đột nhiên được sử dụng tại Đài Loan, chúng ta có thể nghi ngờ và từ chối đơn đặt hàng này. <br/> ModSecurity sử dụng GEO collection để lưu trữ thông tin địa lý. Chúng ta hãy xem xét kỹ hơn collection này và các trường mà nó hỗ trợ.<br/> <br/> <b><font color='orange'>2.4.9.1. Các trường trong collection GEO</font></b><br/> <br/> -	COUNTRY_CODE<br/> -	COUNTRY_CODE3<br/> -	COUNTRY_NAME<br/> -	COUNTRY_CONTINEN<br/> -	REGION<br/> -	CITY<br/> -	POSTAL_CODE<br/> -	LATITUDE<br/> -	LONGITUDE<br/> -	DMA_CODE (US only)<br/> -	AREA_CODE (US only)<br/> <br/> Trường COUNTRY_CODE là mã quốc gia gồm hai chữ cái theo  tiêu chuẩn ISO 3166. Ví dụ, mã quốc gia của Hoa Kỳ là US. COUNTRY_CODE3 chứa mã quốc gia ba ký tự, ví dụ Hoa Kỳ là USA. Trường COUNTRY_CONTINENT chứa châu lục, ví dụ như EU cho người sử dụng từ châu Âu và AS cho châu Á.<br/> <br/> <b><font color='orange'>2.4.9.2. Cấm các người dùng từ các quốc gia được chỉ định</font></b><br/> <br/> Đầu tiên, chúng ta cần download GEO database. Thực hiện theo các bước<br/> 1.  Truy cập vào<span class="link"> http://www.maxmind.com</span> và click vào GeoLocation Technology.<br/> 2.  Click vào GeoLite Country, với phiên bản miễn phí của database.<br/> 3.  Copy link các phiên bản nhị phân (binary)của  GeoLite database.<br/> <br/> Sử dụng wget để download về,<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>wget <span class="link"> http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz</span><br/>  gunzip GeoIP.dat.gz<br/>  mkdir /usr/local/geoip<br/>  mv GeoIP.dat /usr/local/geoip</pre><br/> 		</div><br/> <br/> Ví dụ. Viết rule để chặn các khách truy cập từ Nga(RU) Pakistan(PK) và Trung Quốc(TQ)<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecGeoLookupDb "/usr/local/geoip/GeoIP.dat"<br/> SecRule REMOTE_ADDR “@geoLookup” “deny,nolog,chain,status:500”<br/> SecRule GEO:COUNTRY_CODE “@pm RU PK CN”</pre><br/> 		</div><br/> <br/> Để chặn nhiểu quốc gia hơn, có thể dùng @pmFromFile thay cho @pm<br/> <br/> <font color='orange'><b>2.4.9.3. Cân bằng tải giữa các server trên các châu lục khác nhau</b></font><br/> <br/> Nếu chúng ta đang cung cấp dữ liệu cho khách truy cập download, chúng ta sẽ tính đến bài toán để người truy cập có được tốc độ download tốt nhất có thể. Giả sử chúng ta có một Server ở Mỹ và một Server ở châu Âu. Bằng cách sử dụng ModSecurity với operator là @geoLookup, ta có thể xác định nơi khách truy cập và chuyển vị trí download đến server gần nhất, vì vậy tốc độ download sẽ cải thiện cũng như cân bằng tải cho Server. Rule trong trường hợp này được viết như sau:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule REQUEST_URI “^/download/&#40;.*&#41;$” “phase:1,capture,chain, wwwect:http://sveu.example.com/download/%{TX.1}”<br/> SecRule REMOTE_ADDR “@geoLookup” “chain”<br/> SecRule GEO:COUNTRY_CONTINENT “@streq EU”</pre><br/> 		</div><br/> <br/> Rule đầu tiên sẽ phù hợp với bất kỳ request nào đến thư mục<font color='yellow'> /download/.</font> Sử dụng dấu chấm(.) và dấu sao<img src="/hvaonline/images/smilies/76ec624536d56442d32f4d929544379e.gif" border="0" alt="smilie" align="absbottom"> để đại diện cho tất cả các file có trong thư mục. ModSecurity sẽ nắm bắt tất cả các giá trị này và lưu nó vào trong biến <font color='yellow'>TX:1</font>. Nếu người truy cập từ Châu Âu, ModSecurity sẽ chuyển hướng request đến server sveu.example.com với đường dẫn thư mục và file request như  REQUEST _URI ở rule đầu tiên.<br/> <br/> <font color='orange'><b>2.4.10. Thực hiện các shell scripts với ModSecurity</b></font><br/> <br/> ModSecurity có thể thực thi một shell scripts khi khớp (math) với một rule. Điều này được thực hiện thông qua actions <font color='yellow'>exec()</font> . Đây là một kỹ thuật rất mạnh cho phép chúng ta sử dụng toàn bộ sức mạnh của shell scripts khi một rules được kích hoạt.<br/> <br/> Các file shell scripts phải được thực thi bởi user Apache, vì vậy phải chắc chắn rằng user Apache có quyền thực thi scripts. Nếu thực hiện shell scripts không thành công, ModSecurity sẽ ghi lỗi vào file log lỗi của Apache. Dưới đây là một số ứng dụng thông thường khi sử dụng Modsecurity thực hiện Shell scripts.<br/> <br/> <b><font color='orange'>2.4.10.1. Giởi email cảnh báo</font></b><br/> <br/> Ví dụ, giả sử rằng chúng ta muốn thực hiện một script để gởi cho người quản trị web server email cảnh báo ModSecurity phát hiện hacker đang khai thác lỗi SQL injection. Để làm điều này, chúng ta cần hai bước:<br/> <br/> 1.  Viết một file script có khả năng gởi email cảnh báo đến một địa chỉ email chỉ định.<br/> 2. Một rule có tác dụng sẽ gọi script khi phát hiện tấn công.<br/> Đối với script, chúng ta có thể sử dụng một standard shell script gọi /bin/sh, (có thể sử dụng Perl script hoặc bất kỳ ngôn ngữ khác). Vd ở đây sử dụng standard shell script và gửi email thông báo cho <a href="mailto:tanviet12@example.com">tanviet12@example.com</a><br/> Tạo một file có tên email.sh trong thư mục /usr/local/bin có nội dung<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>#!/bin/sh<br/> echo "Mot cuoc tan cong sql injection da bi chan"|mail –s "ModSecurity Alert" &lt;a href="mailto:tanviet12@example.com"&gt;tanviet12@example.com&lt;/a&gt;<br/> echo Done.</pre><br/> 		</div><br/> <br/> Nếu được kích hoạt, script sẽ gởi email đến địa chỉ <a href="mailto:tanviet@example.com">tanviet@example.com</a> với tiêu đề <font color='yellow'>ModSecurity Alert.</font> Cuối script là chuỗi <font color='yellow'>Done </font> để ModSecurity nhận biết đã thực thi script thành công.<br/> <br/> Tiếp theo, viết rule để kích hoạt script khi có tấn công sql injection<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS “drop table” “deny,exec:/usr/local/bin/email.sh”</pre><br/> 		</div><br/>  <br/> Bây giờ chúng ta có thể thử nghiệm rule bằng cách truy cập vào đường dẫn<span class="link"> http://example.com/test=drop%20table.</span> <br/> <br/> <b><font color='orange'>2.4.10.2. Gởi nhiều thông tin hơn đến email</font></b><br/> <br/> Email cảnh báo có thể rất hữu ích cho người quản trị web server để nhanh chóng khắc phục được sự cố khi gặp tấn công…Tuy nhiên, chúng ta có thể làm cho các email được gởi chứa nhiều thông tin hơn về cuộc tấn công (các thông tin như IP, request URI,..). <br/> <br/> ModSecurity cho phép chúng ta thiết lập các biến môi trường thông qua action setenv. Giả sử chúng ta muốn thu thập các thông tin sau khi phát hiện tấn công SQL injection:<br/> <br/> -	Tên máy của server nơi xảy ra cảnh báo<br/> -	Địa chỉ IP và tên máy của hacker<br/> -	Các request URI<br/> -	Các giá trị của tất cả các đối số, cho dù được gửi bằng phương thức GET hay POST<br/> -	Các ID của request để chúng ta dễ dàng tìm thấy đoạn request trong file log, <br/> <br/> Đặt các thông tin trên vào sáu biến môi trường riêng biệt: <b>HOSTNAME, REMOTEIP, REMOTEHOST, REQUESTURI, ARGS, và UNIQUEID</b>.<br/>  <br/> Rule được viết như sau:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule ARGS "drop table"  "deny,t:lowercase,setenv:HOSTNAME=%{SERVER_NAME},   setenv:REMOTEIP=%{REMOTE_ADDR},setenv:REQUESTURI=%{REQUEST_URI},setenv:ARGS=%{ARGS}, setenv:UNIQUEID={%UNIQUE_ID},exec:/usr/local/bin/email.sh"</pre><br/> 		</div><br/> <br/> File shell script được viết lại như sau<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>#!/bin/sh<br/> echo "Mot cuoc tan cong sql injection da bi chan:<br/> Server: $HOSTNAME<br/> Attacking IP: $REMOTEIP<br/> Attacking host: $REMOTEHOST<br/> Request URI: $REQUESTURI<br/> Arguments: $ARGS<br/> Unique ID: $UNIQUEID<br/> Time: `date '+%D %H:%M'`<br/> "|mail –s 'ModSecurity Alert' &lt;a href="mailto:tanviet12@example.com"&gt;tanviet12@example.com&lt;/a&gt;<br/> echo Done.</pre><br/> 		</div><br/> <br/> <font color='orange'><b>2.4.10.3. Chặn tấn công đoán mật khẩu – brute-force</b></font><br/> <br/> Bây giờ chúng ta sẽ dùng collection IP để chặn tấn công brute-force. Dưới đây là một rule viết để chặn tấn công brute-fore.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre># Khoi tao ip collection<br/> SecAction "initcol:ip=%{REMOTE_ADDR},pass,phase:1"<br/> # kiem tra truy cap den thu muc administrator<br/> SecRule REQUEST_URI "^/administrator/" "pass,phase:1,setvar:ip.attempts=+1,expirevar:ip.attempts=600"<br/> # Da duoc xac thuc hay chua?<br/> SecRule REQUEST_URI "^/administrator/" "chain,pass,phase:3"<br/> # Neu da duoc xac thu, set counter to 0  <br/> SecRule RESPONSE_STATUS "^2..$" "setvar:ip.attempts=0"<br/> # Deny neu 5 lan xac thuc khong thanh cong<br/> SecRule IP:ATTEMPTS "@gt 5" "phase:1,deny"</pre><br/> 		</div><br/> <br/> <b><font color='orange'>2.4.11. Chèn dữ liệu vào response</font></b><br/> <br/> ModSecurity cho phép chúng ta đưa dữ liệu vào response gửi lại cho client nếu SecContentInjection được thiết lập On. Được sử dụng để đưa ra một lời cảnh báo cho hacker khi hành động tấn công được phát hiện. <br/> Với ví dụ dưới đây, chúng ta sẽ đưa ra thông báo “Hoc di dung hack nua!” khi ModSecurity phát hiện tấn công XSS.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecContentInjection  On<br/> SecRule ARGS:username "%" "phase:1,allow,t:urlDecode,append:'&gt;&lt;script type=text/javascript&gt;alert&#40;\"Hoc di dung hack nua!\"&#41;;&lt;/script&gt;',log,msg:'phat hien tan cong'"</pre><br/> 		</div><br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='http://i483.photobucket.com/albums/rr193/buitanviet/shareforum/phan2/9.jpg' border="0"  /></div><br/> Hình  2.3 Ví dụ về chèn dữ liệu vào Response<br/> <br/> <b> <font color='orange'>2.4.12. Kiểm tra các tập tin được upload lên</font></b><br/> <br/> Một tính năng rất hữu ích ModSecurity là khả năng kiểm tra các file đã được upload lên thông qua một POST request. <br/> Vì vậy, chỉ cần thiết lập <font color='yellow'>RequestBodyBuffering On</font> là chúng ta có thể kiểm tra chúng bằng cách sử dụng toán tử <font color='yellow'>@inspectFile</font>.<br/> <br/> Cần viết một shell script chặn các file được upload lên và quét chúng bằng ClamAV. ClamAV là một antivirus được sử dụng rất phổ biến trên môi trường Unix <span class="link"> http://clamav.net</span>) Khi ClamAV đã được cài đặt, sử dụng lệnh <font color='yellow'>clamscan &lt;tenfile&gt;</font> để quét file. <br/> <br/> Đầu tiên cần thiết lập vị trí thư mục lưu file tạm<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecUploadDir “/tmp/mosecurity”<br/> SecTmpDir “/tmp/mosecurity”</pre><br/> 		</div><br/> <br/> Lưu ý: User apache phải có quyền read và write trên thư mục trên<br/> <br/> Tiếp theo viết script /usr/local/bin/filescan.sh để thực hiện quét mã độc khi có file upload lên server.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>#!/bin/sh<br/> /usr/bin/clamscan $1 &gt; /dev/null 2&gt;&1<br/> if &#91; "$?" -eq "1" &#93;; then<br/>   echo "An infected file was found!"<br/> fi</pre><br/> 		</div><br/> <br/> Dòng đầu tiên của script để kích hoạt ClamAV quét thư mục /tmp/ModSecurity. Câu lệnh tiếp theo sẽ kiểm tra giá trị trả về của lệnh thực hiện trước.  ClamAV sẽ trả về 1 nếu virus được tìm thấy và 0 nếu ngược lại.<br/> Dưới đây là Rule để chặn các file được upload lên và kích hoạt script quét virus.<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>SecRule  FILES_TMPNAMES “@inspectFile /usr/local/bin/filescan.sh” “phase:2,deny,status:418”</pre><br/> 		</div><br/> <br/> <font color='orange'><b>Kết thúc Phần 2</b></font><br/> </div>
						</td>
					</tr>

					<tr>
						<td align="left"><a href="http://digg.com/submit?phrase=2&url=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/digg.gif" align="texttop" alt="[digg]" title="[digg]"></a>
<a href="http://del.icio.us/post?url=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/delicious.gif" align="texttop" alt="[delicious]" title="[delicious]"></a>
<a href="http://www.google.com/bookmarks/mark?op=edit&output=popup&bkmk=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/google.gif" align="texttop" alt="[google]" title="[google]"></a>
<a href="http://bookmarks.yahoo.com/toolbar/savebm?opener=tb&u=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/yahoo.gif" align="texttop" alt="[yahoo]" title="[yahoo]"></a>
<a href="http://technorati.com/faves?add=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/technorati.gif" align="texttop" alt="[technorati]" title="[technorati]"></a>
<a href="http://reddit.com/submit?url=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/reddit.gif" align="texttop" alt="[reddit]" title="[reddit]"></a>
<a href="http://www.stumbleupon.com/submit?url=/hvaonline/readingRoom/item/237044.html"><img src="/hvaonline/templates/viet/images/stumbleupon.gif" align="texttop" alt="[stumbleupon]" title="[stumbleupon]"></a></td>
					</tr>
				</table>
			</td>
		</tr>

		<tr>
			<td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
						<div class="postbody"><b>Other posts in the same group:</b></div><br />
									<div class="gen"><a href="/hvaonline/readingRoom/item/237029.html">Bảo mật web server Apache với mod Security - Phần 1</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/237042.html">Bảo mật web server Apache với mod Security - Phần 2.1</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/237061.html">Bảo mật web server Apache với mod Security - Phần 3.1</a></div>
									<div class="gen"><b>Bảo mật web server Apache với mod Security - Phần 2.2</b></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/237063.html">Bảo mật web server Apache với mod Security - Phần 3.2</a></div>
						</td>
					</tr>
				</table>
			</td>
		</tr>


		<tr>
			<td align="left" valign="top">
				<a href="#topPage"><img src="/hvaonline/templates/viet/images/goup.gif" align="absbottom" border="0" alt="Go to top" title="Go to top"></a>
				<a href="/hvaonline/posts/list/0/38690.html#237044" target="_blank"><img src="/hvaonline/templates/viet/images/goright.gif" border="0" align="absbottom" alt="Go to original post" title="Go to original post"></a> 
				&nbsp;
			</td>
			<td align="right">	<table cellspacing="0" cellpadding="0" border="0">
		<tr>			  
			<td nowrap="nowrap">
				<form action="" name="f" id="f" accept-charset="UTF-8">
					<select onchange="if(this.options[this.selectedIndex].value > 0){ document.location = '/hvaonline/readingRoom/show/'+ this.options[this.selectedIndex].value +'.html'; }" name="select">
						<option value="0" selected="selected">Go to Category</option>	
						<option value="0">------------------------</option>	
								<option value="1">Defense</option>
								<option value="2">Exploit</option>
								<option value="3">Reverse Engineering</option>
								<option value="4">*nix</option>
								<option value="5">Windows</option>
								<option value="6">Networking</option>
								<option value="7">Others</option>
					</select>
				</form>
			</td>
		</tr>
	</table>
</td>
		</tr>
</table>
<script type="text/javascript">
		var ctlTop = false;
		var ctlBt = false;

		function activateControllerTop()
		{
			ctlTop = !ctlTop;
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");

			if (ctlTop) {
				document.location = document.location + "#ctlTop";
			}
		}

		function activateControllerBottom()
		{
			ctlBt = !ctlBt;
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");

			if (ctlBt) {
				document.location = document.location + "#ctlBt";
			}
		}
</script>

	<tr>	
		<td align="center">
		<br>
					</td>
	</tr>

	<tr>
		<td align="center">
			<span class="copyright">Powered by JForum - Extended by <a href="MailTo:lienlac@hvaonline.net">HVAOnline</a><br>
			&nbsp;hvaonline.net&nbsp; | &nbsp;hvaforum.net&nbsp; | &nbsp;hvazone.net&nbsp; | &nbsp;hvanews.net&nbsp; | &nbsp;vnhacker.org<br>
			1999 - 2013 &copy;
			v2012|0504|218|
		  </span>
	  </td>
	</tr>
<iframe src="/hvaonline/templates/ping_session.html" height="0" width="0" frameborder="0" scrolling="no"></iframe>
</body>
</html>
