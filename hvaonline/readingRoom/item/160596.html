<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta name="description" content="HVA Reading Room">
<meta name="keywords" content=", reading room, hva, hvaonline, hvazone, hvaforum">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="robots" content="index,follow">
<meta name="rating" content="general">
<style type="text/css">
<!-- 
@import url( "/hvaonline/templates/viet/styles/style.css");
-->
</style>
<style type="text/css">
<!--
@import url("/hvaonline/templates/viet/styles/en_US.css");
-->
</style>
<title> - .:: HVAOnline ::.</title>

</head>
<body class="en_US">


<!--
Original theme from phpBB (http://www.phpbb.com) subSilver
Created by subBlue design
http://www.subBlue.com
Modifications by JForum Team 
Extended and customised by HVA Team
Added more features and Black Silver theme designed by HVA
-->
<table width="100%" border="0" cols="2">
	<tr align="right">
		<td class="copyright">
			English
			| 
			<a href="/hvaonline/jforum.html?module=forums&amp;action=setLang&amp;lang=vi_VN" rel="nofollow">Vietnamese</a>
		</td>
	</tr>
</table>
<table width="100%" border="0" align="center">
	<tr>
        <td width="100%" align="center" valign="middle">
			<a href="" title="[Logo]"><img src="/hvaonline/templates/viet/images/hvabanner-final.gif" alt="banner" /></a>
		</td>
	</tr>

	<tr>
		<td>
<table cellspacing="0" cellpadding="0" width="80%" align="center" border="0">

		<tr height="15">
			<th colspan="2" class="thportal" align="left"><span class="readingheader">&nbsp;.::Defense::.</span></th>
		    <th class="thportal" align="center">
				<span class="readingheader">
					 Ký sự các vụ DDoS đến HVA - Phần 24 <a name="topPage" id="topPage"></a>
				</span>
			</th>
		    <th class="thportal" align="right">
				<a href="/hvaonline/posts/list/0/26431.html#160596" target="_blank">
				<img src="/hvaonline/templates/viet/images/goright.gif" align="absbottom" border="0" alt="Go to original post" title="Go to original post"/></a> 
				<img src="/hvaonline/templates/viet/images/what.gif" align="absbottom" border="0" alt="Author: Hoàng Ngọc Diêu (conmale) - Translator:  - Entry Date: 13/02/2009 14:58:01" title="Author: Hoàng Ngọc Diêu (conmale) - Translator:  - Entry Date: 13/02/2009 14:58:01"/>
			</th>
		</tr>
</table>

<table cellspacing="0" cellpadding="5" width="80%" align="center" border="0">
		<tr>
		    <td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
							<div class="postbody"><b>Chiều 30/8/2008</b><br/> Chiều hôm ấy rảnh rang, tôi đăng nhập vào firewall của HVA và tiếp tục táy máy. <br/> <br/> Cả ngày hôm ấy, vừa làm việc linh tinh tôi vừa suy nghĩ về giải pháp "/dev/null".<br/> <br/> Một gói UDP đi vào, nếu muốn đưa nó vào /dev/null cần phải hội đủ những điều kiện nào? Phải làm gì? Thực hiện chi tiết thế nào? Tôi không được cái tiện nghi để ngồi xuống bàn với mảnh giấy và cây bút để hí hoáy nên đành phải nghĩ ngợi và sắp xếp trong đầu ở mức độ cho phép. Những câu hỏi và trả lời tôi tự đặt ra như sau:<br/> <br/> - Để cho gói UDP vào /dev/null, điều đầu tiên phải làm gì với nó? Nếu không DROP (-j DROP) <font color='orange'>-77-</font> trên netfilter thì tất nhiên là phải cho vào (-j ACCEPT) <font color='orange'>-77-</font>.<br/> - Nếu cho vào (-j ACCEPT) thì nó đi đâu? Nó vào thẳng IP : DESTINATION_PORT (ở đây là IP của HVA và HTTP port 80 nhưng qua UDP).<br/> - Nếu vậy, ở điểm nào nó bị tóm và đưa vào /dev/null <font color='orange'>-76-</font>? Chưa rõ.<br/> - /dev/null là một device đặc biệt dùng để wwwect stdout, stderr đến để huỷ bỏ. Vậy một gói UDP làm sao trở thành stdout để có thể vào /dev/null? Phải cần một công đoạn để thực hiện.<br/> - Nếu tạo một công đoạn thực hiện, liệu nó có gia tăng khối lượng công việc cho firewall và tạo thêm trì trệ ở tình trạng 20 ngàn gói 1 giây? Chắc chắn là vậy rồi?<br/> - Nếu thế, so sánh mức độ trì trệ khi dùng -j DROP như cũ và mức độ trì trệ khi đi xuyên qua một công đoạn nào đó để cho nó vào /dev/null thì cái nào trì trệ hơn? Chưa rõ.<br/> - Có cách nào khác hơn là cách ứng dụng một công đoạn biến packet thành stdout để vào /dev/null? Tại sao phải luộm thuộm như thế? Chắc là có, trên *nix có discard <font color='orange'>-78-</font> service. Ngoài ra còn có thể tạo một dịch vụ "giả" bằng netcat <font color='orange'>-79-</font> rồi chuyển nó vào /dev/null.<br/> - Nếu dùng netcat, liệu nó có bền chăng? Hay nó sẽ chết sau vài trăm ngàn cú dội và xử lý không kịp? Chưa biết.<br/> - Nếu dùng discard service có sẵn liệu nó có bền chăng? Hay nó sẽ chết sau vài trăm ngàn cú dội và xử lý không kịp? Chưa biết.<br/> - So sánh giữa netcat và discard, cái nào tốt hơn? Có lẽ discard tốt hơn vì nó gọn và có sẵn. Vả lại nó được xinetd điều tác.<br/> - Nếu thử ứng dụng discard, cần phải làm những gì? Tất nhiên là phải sắp xếp và khởi tạo dịch vụ discard (chuyện nhỏ).<br/> - Đã có discard rồi, cần làm gì trên iptables? Nếu gói tin đi vào thì tất nhiên hành động wwwect phải ở POSTROUTING table <font color='orange'>-77-</font>.<br/> ..v...v......<br/> <br/> Đã đến giờ phải kèm thằng bé môn toán nên tôi đành xếp máy lại vả lại anh chàng chủ nhân UDP kia sẵn sàng chờ đợi cơ mà. Thôi thì tạm ngưng.<br/> <br/> <b>Chiều 1/9/2008</b><br/> Hôm nay thứ Hai, công việc lại hết sức dồn dập. Loay hoay đủ thứ việc nên mãi đến tối mới có thể ngồi vào bàn, giở laptop ra và tiếp tục... táy máy.<br/> <br/> Tôi nhớ trước đây tôi đã tạo dịch vụ discard trên firewall của HVA và đã thử nghiệm qua khoản này nhưng chưa đi sâu bởi vì nạn DDoS x-flash ngày ấy (cuối 2005, đầu 2006) không nhằm mục đích saturate đường dẫn như dạng UDP DDoS lần này. Dịch vụ "discard" chỉ có thể access từ trên chính firewall nên không có gì phải ngại. Hơn nữa, nó được chính firewall bảo vệ. Bởi thế, có lẽ nó vẫn còn đó vì tôi nhớ mình chưa hề tắt bỏ nó.<br/> <br/> Đăng nhập vào firewall của HVA, tôi thử:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>&#91;conmale@hva&#93;# netstat -nau | grep 9<br/> udp        0      0 0.0.0.0:9                   0.0.0.0:*</pre><br/> 		</div><br/> Quả thật "discard" vẫn còn đó. Tôi kiểm tra lại config của dịch vụ này cho bảo đảm:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>&#91;conmale@hva&#93;# cat /etc/xinetd.d/discard-udp<br/> # default: off<br/> # description: An xinetd internal service which discard any UDP packet sent to it. \<br/> # This is the udp version.<br/> service discard<br/> {<br/>         disable         = no<br/>         type            = INTERNAL<br/>         id              = discard-dgram<br/>         socket_type     = dgram<br/>         protocol        = udp<br/>         user            = root<br/>         wait            = yes<br/> }</pre><br/> 		</div><br/> <br/> Restart lại một phát cho chắc ăn. Ngon lành! Tôi bắt tay vào "ngâm" công đoạn làm sao để các UDP packets đi vào sẽ được "match" và được chuyển đến cổng dịch vụ của discard.<br/> <br/> Thử nghĩ xem, một packet đi đến firewall, nếu điểm đích của nó chính là firewall thì nó sẽ được "route" đến bảng (table) INPUT sau khi đi xuyên qua một loạt các bước trong kernel <font color='orange'>-80-</font>. Trong trường hợp các gói UDP đang tấn công HVA, chắc chắn điểm đích tôi không muốn (hoặc sẽ không cho phép nó đến) là firewall bởi vì tình trạng trì trệ nó tạo ra. Tôi muốn "đẩy" chúng đi đến nơi khác rồi "xử" chúng sau. Ở đây, tôi đang có ý định "đẩy" chúng đến một dịch vụ gọi là discard. Bởi thế, ngay khi gói tin này đi đến firewall, nó phải được "PREROUTE" để chuyển đến "discard".<br/> <br/> Một luật như sau:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>iptables -A INPUT -i $IF -p udp -s 0/0 -d $IP -j DROP</pre><br/> 		</div><br/> sẽ ấn định rằng một gói UDP từ bất cứ nơi nào mà đi xuyên qua "interface" IF (trong trường hợp này là eth0) và có điểm đích là $IP (trong trường hợp này chính là pubic IP của HVA firewall) thì DROP nó. Điều này có nghĩa, công đoạn PREROUTING trước đó đã xong và gói tin này quả thật có điểm đích chính là HVA firewall. Tất nhiên, các gói UDP dùng để tấn công kia sẽ bị DROP nhưng tình trạng trì trệ không được giải quyết.<br/> <br/> Trong khi đó, một luật như sau:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>iptables -t nat -A PREROUTING -i $IF -p udp -s 0/0 -j REDIRECT --to-ports 9</pre><br/> 		</div><br/> sẽ ấn định rằng một gói UDP từ bất cứ nơi nào mà đi xuyên qua "interface" IF thì sẽ được chuyển (REDIRECT) đến cổng 9. Với netfilter / iptables, "REDIRECT" có một vai trò hết sức cụ thể, nó dùng để direct gói tin đến một cổng dịch vụ khác cũng ở <b>ngay cùng</b> một host (trong trường hợp này, nó wwwect bất cứ gói UDP nào đi vào đến cổng 9 cũng ở ngay trên firewall).<br/> <br/> Nhìn vào dòng luật trên, tôi nhận ra nó quá rộng và có thể tạo "false negative", hoặc nói một cách khác, nó sẽ cản luôn những gói UDP cần thiết. Ví dụ như ngay chính firewall cần liên hệ với một DNS server nào đó bên ngoài để lấy thông tin, DNS server ấy trả lời bằng một gói UDP; gói UDP ấy cũng sẽ có cùng.... số phận là biến mất trong '/dev/null' (vào discard service).<br/> <br/> Nếu bạn đã dùng qua netfilter / iptables, có lẽ bạn sẽ thắc mắc tại sao tôi không dùng "state machine" (--m state) để ấn định rằng nếu chính firewall gởi một gói UDP ra ngoài thì hãy cho phép gói trả lời đi vào? Trên mặt nguyên tắc, đây là cách thông thường cho hoàn cảnh bình thường. Tuy nhiên, thử hình dùng cái "state machine" sẽ như thế nào nếu cứ mỗi giây có khoảng 20 ngàn packets dội vào? Bởi thế, tôi điều chỉnh dòng luật ở trên thành:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>iptables -t nat -A PREROUTING -i $IF -p udp -s 0/0 ! --sport 53 -j REDIRECT --to-ports 9</pre><br/> 		</div><br/> <br/> Dòng luật trên tạo một ngoại lệ mới, đó là chọn lựa <b>! --sport 53</b>. Dấu ! biểu thị cho "negation", sự ngược lại. Dòng luật này có thể hiểu nôm na rằng, một gói UDP từ bất cứ nơi nào mà đi xuyên qua "interface" IF nhưng không có source port là 53 thì sẽ được chuyển (REDIRECT) đến cổng 9. Điều này có nghĩa nếu trong đám 20 ngàn packets trong mỗi giây kia có vài UDP packets với cổng nguồn (source port) là 53 thì có lẽ chúng là những gói tin trả lời từ DNS nào đó, không "wwwect" chúng vào '/dev/null'.<br/> <br/> Vậy, bạn có thể tiếp tục thắc mắc rằng, nếu chủ nhân UDP DDoS kia có thể tạo hoàn toàn các UDP packets đều có cổng nguồn (source port) là 53 thì sao? Câu trả lời là: nếu thế thì tất nhiên dòng luật ở trên vô dụng vì chúng sẽ không đi vào '/dev/null' mà sẽ đi đến INPUT chain và đi thẳng vào trong. Tuy nhiên, xét theo nội dung của các gói tin sniff được thì thấy rằng, cá zombies dùng để tấn công đều tạo cổng nguồn là các cổng &gt; 1024. Điều này dễ hiểu vì chương trình nào đó "ra lệnh" cho các zombies tạo UDP packets để gởi đi không thể ấn định packets phải có cổng nguồn là 53 mà hoàn toàn dựa vào quyết định của kernel trên mỗi máy con (của zombie) quyết định cổng nguồn sẽ là gì. Bởi thế, cơ hội gói tin dùng để tấn công có cổng nguồn (source port) là 53 là cơ hội cực kỳ hiếm hoi.<br/> <br/> Việc điều chỉnh firewall và chuẩn bị "sẵn sàng tư thế" là chuyện đơn giản sau khi đã hoàn thành quá trình phân tích ở trên. Để bảo đảm, tôi restart lại firewall và quyết định... tự DoS vào firewall của HVA xem sao. Trên laptop, tôi chuẩn bị một cái script đơn giản để tạo UDP packets gởi đến địa chỉ IP của HVA. Trên firewall của HVA, tôi tạo ra 2 consoles, một để theo dõi logs do netfilter tường trình, một để theo dõi packets đi vào. Tôi chạy cái script và bắt đầu quan sát. Quả thật hàng loạt UDP packets do tôi tạo ra lũ lượt đi vào. tcpdump cho thấy:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>18:12:23.527862 IP conmale-laptop.33125 &gt; www1.hvaonline.net.1018: UDP, length 79<br/> 18:12:23.529068 IP conmale-laptop.33131 &gt; www1.hvaonline.net.2785: UDP, length 1070<br/> 18:12:23.533279 IP conmale-laptop.33134 &gt; www1.hvaonline.net.2819: UDP, length 73<br/> 18:12:23.536421 IP conmale-laptop.33135 &gt; www1.hvaonline.net.3227: UDP, length 88<br/> 18:12:23.538983 IP conmale-laptop.33154 &gt; www1.hvaonline.net.3749: UDP, length 2315<br/> 18:12:23.543338 IP conmale-laptop.33162 &gt; www1.hvaonline.net.4412: UDP, length 1890<br/> 18:12:23.545516 IP conmale-laptop.33166 &gt; www1.hvaonline.net.4531: UDP, length 1763<br/> 18:12:23.546163 IP conmale-laptop.33172 &gt; www1.hvaonline.net.4678: UDP, length 2217<br/> 18:12:23.549723 IP conmale-laptop.33173 &gt; www1.hvaonline.net.5125: UDP, length 127</pre><br/> 		</div><br/> <br/> và chúng.... biến mất ở đâu đó. tcpdump không thể sniff giai đoạn các packets trên đuợc wwwect đến cổng discard (9) nên tôi đoán rằng chúng đi đến cổng ấy. Tôi xoa tay thoả mãn và log vào Pidgin để xem có anh chàng chủ nhân UDP DDoS ở đó hay không để thử một phát xem sao.<br/> <br/> Vào Pidgin, nick của anh chàng ấy xám xịt nên tôi đành gởi một cái offline message để nhắn khi nào tiện thì cho tôi biết để mình thử nghiệm tiếp. Không ngờ anh chàng "ẩn" trên YIM nên tôi nghĩ anh chàng offline mà thật ra anh chàng đang online. Chúng tôi trao đổi vài thông điệp và anh chàng cho biết đã sẵn sàng. Thế là chúng tôi bắt đầu. <br/> <br/> Chẳng mấy chốc, trên console của tcpdump hiện ra hàng loạt gói tin UDP. Chúng lũ lượt đi vào với vận tốc hết sức dồn dập. Tôi phóng ngay một console tiếp theo để theo dõi tình hình tài nguyên (memory, CPU, disk...) trên server. Không như tôi dự đoán rằng anh chàng sẽ vận dụng y hệt phương thức mấy hôm trước, lần này các gói tin có độ ngẫu nhiên cao hơn rất xa:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>18:26:17.636521 IP 195-97-201-234.onyx.net.64735 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.639083 IP 195-97-201-234.onyx.net.64744 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.643438 IP 195-97-201-234.onyx.net.64752 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.645616 IP 195-97-201-234.onyx.net.64736 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.647163 IP 195-97-201-234.onyx.net.64732 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.649823 IP 195-97-201-234.onyx.net.64733 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.664263 IP 196.0.11.70.2232 &gt; www1.hvaonline.net.http: UDP, length 1540<br/> 18:26:17.667220 IP 209.88.89.114.1852 &gt; www1.hvaonline.net.http: UDP, length 655<br/> 18:26:17.693101 IP 196.0.11.70.2224 &gt; www1.hvaonline.net.http: UDP, length 1530<br/> 18:26:17.717768 IP 196.0.11.70.2230 &gt; www1.hvaonline.net.http: UDP, length 1605<br/> 18:26:17.750330 IP 196.0.11.70.2233 &gt; www1.hvaonline.net.http: UDP, length 1535<br/> 18:26:17.790318 IP modemcable112.18-130-66.mc.videotron.ca.63099 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.820790 IP 196.0.11.70.2228 &gt; www1.hvaonline.net.http: UDP, length 1560<br/> 18:26:17.853920 IP 196.0.11.70.2236 &gt; www1.hvaonline.net.http: UDP, length 1615<br/> 18:26:17.875106 IP 195-97-201-234.onyx.net.64743 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.877136 IP 196.0.11.70.2230 &gt; www1.hvaonline.net.http: UDP, length 1610<br/> 18:26:17.880909 IP 195-97-201-234.onyx.net.64748 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.886715 IP 195-97-201-234.onyx.net.64750 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.888505 IP 195-97-201-234.onyx.net.64742 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.889472 IP 195-97-201-234.onyx.net.64756 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.893003 IP 195-97-201-234.onyx.net.64757 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.900113 IP 195-97-201-234.onyx.net.64761 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.903401 IP 195-97-201-234.onyx.net.64762 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.906156 IP 195-97-201-234.onyx.net.64763 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.907154 IP 195-97-201-234.onyx.net.64749 &gt; www1.hvaonline.net.http: UDP, length 50<br/> 18:26:17.908575 IP 196.0.11.70.2234 &gt; www1.hvaonline.net.http: UDP, length 1560</pre><br/> 		</div><br/> <br/> Vẫn như trước, các gói tin UDP đi vào IP của HVA ở cổng 80 nhưng lần này chúng thay đổi kích thước chiều dài ngẫu nhiên. Dường như có một số zombies bị gắn chặt với "length" nhất định, các zombies khác lại thay đổi.<br/> <br/> Qua lần trao đổi trước, tôi có đề cập đến khía cạnh lợi và hại của việc gởi gói tin kích thước lớn và gói tin kích thước nhỏ. Dường như anh chàng nghĩ rằng gói tin kích thước nhỏ lợi hại hơn vì chúng được gởi đi nhanh hơn và có lẽ anh chàng nghĩ rằng tôi sẽ cản các gói tin có kích thước nhất định nên mới hình thành các gói tin có kích thước lớn bé khác nhau.<br/> <br/> Tôi thử truy cập vào diễn đàn HVA: vẫn bình thường! Vậy là có vẻ ổn rồi.<br/> <br/> Thử xem: iptables -t nat -L -v -n | grep PREROUTING<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>Chain PREROUTING &#40;policy ACCEPT 35074 packets, 71831552 bytes&#41;<br/>  pkts bytes target     prot opt in     out     source               destination <br/>  35074  71831552  REDIRECT   udp  --  *      *       0.0.0.0/0            0.0.0.0/0           udp spt:!53 www ports 9</pre><br/> 		</div><br/> <br/> Tôi định gởi cho anh chàng một thông điệp để thông báo tình hình thì đã nhận được một dòng gởi đến: "Anh ơi, hình như mấy con bots của em không có tác dụng gì hay sao đó. Để em coi còn được mấy con."<br/> <br/> Tôi đáp: "Còn nhiều lắm, anh tính khoảng trên 200 con nhưng tình hình có vẻ không mấy tác dụng vì anh đã thay đổi một số điểm trong cơ chế chống UDP DDoS này rồi."<br/> <br/> Cậu ta đáp: "À ra vậy. Để em coi lại thử xem sao."<br/> <br/> Tôi ngồi đó, tiếp tục quan sát. Càng lúc càng có nhiều UDP đi vào nhưng tình hình có vẻ không thay đổi. Hồi lâu, chẳng thấy anh chàng lên tiếng, tôi bèn gởi một thông điệp báo rằng tôi phải logoff để đi ngủ và tôi logoff, không quên kiểm tra mọi thứ một lần nữa trước khi tắt máy.<br/> <br/> <b>Chiều 2/9/2008</b><br/> Hôm nay tôi được nghỉ bù nên làm loanh quanh vài việc lặt vặt rồi vào bàn ngồi. Tôi login Pidgin để kiểm tra offline messages đồng thời xem thử anh chàng chủ nhân UDP DDoS có online hay không để tiếp tục. Thật may là anh chàng đang online. Cu cậu cho biết là hắn đã thử đổi chiến thuật vài lần và gia tăng một số bots nhưng có vẻ tình hình không khả quan nhưng đã có sáng kiến mới. Tôi hăm hở hồi đáp rằng tôi sẵn sàng thử nghiệm.<br/> <br/> Cũng như lần trước, tôi phóng ra mấy cái console và ngồi chờ. Không lâu, hàng loạt UDP packets tuôn vào và lạ thật, chúng malform (bất hợp lệ) đến mức kỳ quái nhưng không hiểu sao vẫn vượt qua bao nhiêu là routers trước khi đụng đến firewall của HVA. Chúng có dạng như sau:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>14:01:31.201097 IP 83.142.226.76 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201219 IP 83.142.226.76 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201221 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201350 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201436 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201438 IP 83.142.226.76 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201455 IP 83.142.226.78.2543 &gt; www1.hvaonline.net.http: UDP, length 4000<br/> 14:01:31.201457 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201594 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201681 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201683 IP 83.142.226.78.2547 &gt; www1.hvaonline.net.http: UDP, length 4000<br/> 14:01:31.201836 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201837 IP 83.142.226.78 &gt; www1.hvaonline.net: udp<br/> 14:01:31.201932 IP 83.142.226.78 &gt; www1.hvaonline.net: udp</pre><br/> 		</div><br/> <br/> Ngoài mấy dòng có "length 4000", các dòng còn lại (biểu thị cho các packets) hoàn toàn bất hợp lệ. Thật tình trước giờ tôi chưa bao giờ mục kích gói tin UDP kỳ quái đến thế. Bạn có nhận ra chúng kỳ quái thế nào không?<br/> <br/> Chúng vào nhanh như vũ bão và kỳ lạ thay, cơ chế phòng thủ '/dev/null' lúc này không còn mấy tác dụng. Thống kê các packets xuyên qua tcpdump và xuyên qua số lượng 'match' mà netfilter đã cho vào 'discard' service thì thấy chúng chênh lệch khá xa. Điều này khiến tôi tin rằng vì lý do nào đó, netfilter không 'thấy' được các gói tin UDP không có cổng nguồn (source port) và cổng đích (destination port) nên chúng không chuyển chúng đến 'discard' service. Bởi thế, tình trạng trì trệ lại xảy ra như trước.<br/> <br/> Anh chàng chủ nhân UDP gởi tôi một thông điệp báo rằng hình như tấn công kỳ này có kết quả. Tôi báo rằng đúng là HVA đang bị trì trệ. Tôi còn bảo: <i>"Em dùng packet gì mà lộ liễu thế? Gói tin gì mà chẳng có source port, destination port gì hết. Mấy cái này nhận diện chúng quá sức là dễ dàng!"</i><br/> <br/> Anh chàng chỉ trả lời vỏn vẹn một biểu tượng mặt cười: " <img src="/hvaonline/images/smilies/8f173d0eaffc4b90c0c0361b8f37cc17.gif" border="0" alt="smilie" align="absbottom">"<br/> <br/> Tôi vò đầu ngồi suy nghĩ.  Có lẽ anh chàng nhận định về điểm yếu và điểm mạnh của packets có kích thước lớn và bé mà tôi trình bày với anh chàng vào ngày trước nên chàng ta quyết định lột bỏ luôn kích thước. Tiện tay, lột bỏ luôn source port và destination port để tôi có filter port cụ thể thì toi. Chẳng lẽ netfilter bị bug? Hay kernel có quy định nào đó về các packets thiếu hợp lệ như thế và đã lặng lẽ 'xử' chúng? Hãy thử xét lại vấn đề trên phương diện IP routing xem sao.<br/> <br/> Rõ ràng, gói tin như:<br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>14:01:31.201097 IP 83.142.226.76 &gt; www1.hvaonline.net: udp</pre><br/> 		</div><br/> được định tuyến qua nhiều routers, đi từ địa chỉ 83.142.226.76 đến www1.hvaonline.net. Trên phương diện IP routing, router chỉ có biết IP address và cứ việc forward datagram đến hop kế tiếp cho đến khi packet này đến đích. Khi host www1.hvaonline.net (là đích) nhận được IP này, nó tiếp nhận và bắt đầu thực thi demultiplexing <font color='orange'>-81-</font> từ network layer (IP) lên transport layer (UDP). Ở giai đoạn depmultiplexing này, kernel nhận thấy datagram không có thông tin ấn định gói tin này sẽ đi vào cổng dịch vụ nào nên nó tự động hủy bỏ. Đây là thái độ xử lý bình thường và hoàn toàn đúng quy cách. Tuy nhiên, việc xử lý này trở nên bị trì trệ vì có quá nhiều "vụ" để "xử". Nếu kernel tự động xử lý chúng thay vì chuyển chúng đến một chỗ nào đó (như discard service) và không còn phí tài nguyên + thời gian để lo thì chắc chắn tình trạng trì trệ này sẽ giảm.<br/> <br/> Tôi lục lại mớ packet dumps mấy ngày trước và xem lại thật kỹ. Rà từng dòng cho đến khi đụng đến các gói tin không có source port mà tôi bắt được mấy ngày trước đây, tôi tự vỗ vào đầu mình một phát và lẩm nhẩm: "đúng là lú lẫn". Quả thật, tôi bị cuốn vào mớ UDP có tính chất mới (biến thiên từ dạng có chiều dài 4000 bytes và đi vào HTTP UDP port đến dạng có chiều dài ngẫu nhiên) mà quên mất rằng ngay từ đầu mình đã bị "chơi" bằng các gói UDP không có source port và desination port. Rõ ràng netfilter không có ấn định cụ thể nào cho việc "match" các gói tin không có source port hoặc destination port hoặc cả hai. Bởi thế, tôi đành thử thêm một rule mới đi theo sau rule trước:<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/><br/> 		<div class="coded""><br/> 		<pre>iptables -t nat -A PREROUTING -i $IF -p udp -s 0/0 ! --m length 47:0xffff ! --dport 65431 -j REDIRECT --to-ports 9</pre><br/> 		</div><br/> <br/> Rule này ấn định rằng bất cứ gói UDP nào đi vào mà không có kích thước từ 47 đến 65535 bytes và không đi đến cổng đích là 65431 thì đưa nó đến cổng số 9 (discard). <br/> <br/> Tại sao phải ấn định luật như thế này? Bởi vì, tất cả các gói UDP dùng để tấn công không có kích thước thì chúng nằm bên ngoài biên độ cho phép ở trên, chúng bị wwwect. Nếu chúng có kèm kích thước nhưng không kèm cổng đích cũng không nằm trong biên độ cho phép nên cũng bị wwwect. <br/> <br/> Tại sao chọn 65431? Bởi vì đó chỉ là một port ngẫu nhiên (làm sao anh chàng tấn công có thể đoán ra rằng nếu gói UDP đi vào mà không đến cổng đích thì bị wwwect?).<br/> <br/> Tại sao chọn kích thước từ 47 đến 65535 bytes? Bởi vì 1 gói IP hợp lệ hiếm khi nào nhỏ hơn 47 bytes.<br/> <br/> Tôi restart lại fireall có thêm dòng luật trên và tiếp tục theo dõi thông tin trên tcpdump và matched log của netfilter. Voila! lần này chúng có số lượng tương tự nhau. Tôi mỉm cười, gởi cho anh chàng một thông điệp và báo rằng sáng kiến mới đã bị chế ngự.<br/> <br/> Tình trạng truy cập đến HVA dần dần trở lại bình thường. Sau đó tôi thấy anh chàng chuyển packets sang dạng có cổng nguồn, cổng đích và có kích thước ngẫu nhiên rồi lại tạo hỗn hợp UDP khác nhau để tấn công nhưng đều bị hai rules trên thấy được và cho vào "discard". Sau gần một giờ, anh chàng gởi đến tôi một thông điệp và bảo rằng lối "đánh" UDP đã bị thất bại. Tôi cười và đáp: <i>"Cám ơn em đã giành thời gian cho một cuộc thử nghiệm hết sức lý thú. Có lẽ lần này đáng để đi vào loạt bài Ký sự DDoS HVA rồi đó."</i><br/> <br/> Chúng tôi chào tạm biệt và logoff.<br/> <br/> PS: cho đến lúc này, tôi vẫn chưa tìm ra lý do tại sao netfilter không match các gói UDP không có cổng nguồn và cổng đích.<br/> <br/> <br/> <b>Chú thích:</b><br/> <font color='orange'>-76-</font>: /dev/null<br/> <br/> <font color='orange'>-77-</font>: -j DROP, -j ACCEPT, POSTROUTING là những target và table trên iptables. Đọc thêm ở<span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://www.iptables.org</span></span></span></span></span></span></span></span></span></span></span></span></span> để nắm chi tiết.<br/> <br/> <font color='orange'>-78-</font>: discard là dịch vụ ứng dụng tiêu hủy bất cứ gói tin nào đi vào cổng dịch vụ ấy. Nó tương tự như /dev/null cho stdin, stdout và stderr nhưng đặc biệt dành cho internet protocols (TCP và UDP). Dịch vụ này có sẵn trên hầu hết các hệ điều hành Unix và Linux.<br/> <br/> <font color='orange'>-79-</font>: netcat, một ứng dụng mạng nổi tiếng, được mệnh danh là "Swiss army knife for networking" (dao đa dụng quân đội của Áo dành cho mạng). netcat có trang chủ ở:<span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"><span class="link"> http://netcat.sourceforge.net/</span></span></span></span></span></span></span></span></span></span></span></span></span><br/> <br/> <font color='orange'>-80-</font>: netfilter packet traversal. Một bức minh hoạ được "chôm một cách trắng trợn" từ tài liệu "Iptables Tutorial" của Oskar Andreasson<br/> <br/> <br><br/> 			<div align="center" class="limitview"><img src='/images/tables_traverse.gif' border="0"  /></div><br/> <br/> <font color='orange'>-81-</font>: ở mỗi layer của TCP/IP model, packets được "đóng gói" (encapsulating) trước khi gói tin <b>đi ra</b> và được "mở gói" (multideplexing) trong khi gói tin <b>đi vào</b>. <br/> <br/> Hình dung một gói tin trước khi đi ra ngoài, nó được đóng gói từ tầng cao nhất (application layer) đến tầng thấp nhất (link layer) như thể một hộp nhỏ được cho vào một hộp lớn hơn cho mỗi tầng:<br/> Application layer -- <font color='red'>[hộp A] </font>---&gt; transport layer -- <font color='orange'>[hộp B</font> <font color='red'>[hộp A]</font><font color='orange'>]</font> ---&gt; network layer -- <font color='green'>[hộp C</font> <font color='orange'>[hộp B</font> <font color='red'>[hộp A]</font><font color='orange'>]</font><font color='green'>]</font> ---&gt; link layer --<font color='violet'> [hộp D</font> <font color='green'>[hộp C</font> <font color='orange'>[hộp B</font> <font color='red'>[hộp A]</font><font color='orange'>]</font><font color='green'>]</font><font color='violet'>]</font><br/> <br/> Và khi gói tin đi vào một host, nó được mở gói từ tầng thấp nhất (link layer) đến tầng cao nhất như thể mở hộp lớn nhất có chứa hộp bé hơn và như thế cho đến khi mở hộp cuối cùng:<br/> Link layer -- <font color='violet'> [hộp D</font> <font color='green'>[hộp C</font> <font color='orange'>[hộp B</font> <font color='red'>[hộp A]</font><font color='orange'>]</font><font color='green'>]</font><font color='violet'>]</font> ---&gt; network layer -- <font color='green'>[hộp C</font> <font color='orange'>[hộp B</font> <font color='red'>[hộp A]</font><font color='orange'>]</font><font color='green'>]</font> ---&gt; transport layer -- <font color='orange'>[hộp B</font> <font color='red'>[hộp A]</font><font color='orange'>]</font> ----&gt; application layer -- <font color='red'>[hộp A] </font> <br/> </div>
						</td>
					</tr>

					<tr>
						<td align="left"><a href="http://digg.com/submit?phrase=2&url=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/digg.gif" align="texttop" alt="[digg]" title="[digg]"></a>
<a href="http://del.icio.us/post?url=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/delicious.gif" align="texttop" alt="[delicious]" title="[delicious]"></a>
<a href="http://www.google.com/bookmarks/mark?op=edit&output=popup&bkmk=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/google.gif" align="texttop" alt="[google]" title="[google]"></a>
<a href="http://bookmarks.yahoo.com/toolbar/savebm?opener=tb&u=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/yahoo.gif" align="texttop" alt="[yahoo]" title="[yahoo]"></a>
<a href="http://technorati.com/faves?add=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/technorati.gif" align="texttop" alt="[technorati]" title="[technorati]"></a>
<a href="http://reddit.com/submit?url=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/reddit.gif" align="texttop" alt="[reddit]" title="[reddit]"></a>
<a href="http://www.stumbleupon.com/submit?url=/hvaonline/readingRoom/item/160596.html"><img src="/hvaonline/templates/viet/images/stumbleupon.gif" align="texttop" alt="[stumbleupon]" title="[stumbleupon]"></a></td>
					</tr>
				</table>
			</td>
		</tr>

		<tr>
			<td align="left" colspan="2" class="readingborderBottom">
				<table cellspacing="0" cellpadding="10" width="95%" align="center" border="0">
					<tr>
						<td align="left">
						<div class="postbody"><b>Other posts in the same group:</b></div><br />
									<div class="gen"><a href="/hvaonline/readingRoom/item/429.html">Ký sự các vụ DDoS đến HVA - Phần 1</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/735.html"> Ký sự các vụ DDoS đến HVA - Phần 13</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/589.html">Ký sự các vụ DDoS đến HVA - Phần 2</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/590.html"> Ký sự các vụ DDoS đến HVA - Phần 3</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/591.html"> Ký sự các vụ DDoS đến HVA - Phần 4</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/592.html"> Ký sự các vụ DDoS đến HVA - Phần 5</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/593.html">Ký sự các vụ DDoS đến HVA - Phần 6</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/638.html"> Ký sự các vụ DDoS đến HVA - Phần 11</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/639.html"> Ký sự các vụ DDoS đến HVA - Phần 12</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/594.html"> Ký sự các vụ DDoS đến HVA - Phần 7</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/595.html"> Ký sự các vụ DDoS đến HVA - Phần 8</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/634.html"> Ký sự các vụ DDoS đến HVA - Phần 9</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/637.html"> Ký sự các vụ DDoS đến HVA - Phần 10</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/743.html"> Ký sự các vụ DDoS đến HVA - Phần 14</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/761.html"> Ký sự các vụ DDoS đến HVA - Phần 15</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/802.html"> Ký sự các vụ DDoS đến HVA - Phần 16</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/1491.html"> Ký sự các vụ DDoS đến HVA - Phần 17</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/1499.html"> Ký sự các vụ DDoS đến HVA - Phần 18</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/1505.html"> Ký sự các vụ DDoS đến HVA - Phần 19</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/1510.html">Ký sự các vụ DDoS đến HVA - Phần 20</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/1513.html">Ký sự các vụ DDoS đến HVA - Phần 21</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/153418.html">Ký sự các vụ DDoS đến HVA - Phần 22</a></div>
									<div class="gen"><a href="/hvaonline/readingRoom/item/155387.html">Ký sự các vụ DDoS đến HVA - Phần 23</a></div>
									<div class="gen"><b>Ký sự các vụ DDoS đến HVA - Phần 24</b></div>
						</td>
					</tr>
				</table>
			</td>
		</tr>


		<tr>
			<td align="left" valign="top">
				<a href="#topPage"><img src="/hvaonline/templates/viet/images/goup.gif" align="absbottom" border="0" alt="Go to top" title="Go to top"></a>
				<a href="/hvaonline/posts/list/0/26431.html#160596" target="_blank"><img src="/hvaonline/templates/viet/images/goright.gif" border="0" align="absbottom" alt="Go to original post" title="Go to original post"></a> 
				&nbsp;
			</td>
			<td align="right">	<table cellspacing="0" cellpadding="0" border="0">
		<tr>			  
			<td nowrap="nowrap">
				<form action="" name="f" id="f" accept-charset="UTF-8">
					<select onchange="if(this.options[this.selectedIndex].value > 0){ document.location = '/hvaonline/readingRoom/show/'+ this.options[this.selectedIndex].value +'.html'; }" name="select">
						<option value="0" selected="selected">Go to Category</option>	
						<option value="0">------------------------</option>	
								<option value="1">Defense</option>
								<option value="2">Exploit</option>
								<option value="3">Reverse Engineering</option>
								<option value="4">*nix</option>
								<option value="5">Windows</option>
								<option value="6">Networking</option>
								<option value="7">Others</option>
					</select>
				</form>
			</td>
		</tr>
	</table>
</td>
		</tr>
</table>
<script type="text/javascript">
		var ctlTop = false;
		var ctlBt = false;

		function activateControllerTop()
		{
			ctlTop = !ctlTop;
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");
			document.getElementById("controllerTop").style.display = (ctlTop ? "" : "none");

			if (ctlTop) {
				document.location = document.location + "#ctlTop";
			}
		}

		function activateControllerBottom()
		{
			ctlBt = !ctlBt;
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");
			document.getElementById("controllerBottom").style.display = (ctlBt ? "" : "none");

			if (ctlBt) {
				document.location = document.location + "#ctlBt";
			}
		}
</script>

	<tr>	
		<td align="center">
		<br>
					</td>
	</tr>

	<tr>
		<td align="center">
			<span class="copyright">Powered by JForum - Extended by <a href="MailTo:lienlac@hvaonline.net">HVAOnline</a><br>
			&nbsp;hvaonline.net&nbsp; | &nbsp;hvaforum.net&nbsp; | &nbsp;hvazone.net&nbsp; | &nbsp;hvanews.net&nbsp; | &nbsp;vnhacker.org<br>
			1999 - 2013 &copy;
			v2012|0504|218|
		  </span>
	  </td>
	</tr>
<iframe src="/hvaonline/templates/ping_session.html" height="0" width="0" frameborder="0" scrolling="no"></iframe>
</body>
</html>
