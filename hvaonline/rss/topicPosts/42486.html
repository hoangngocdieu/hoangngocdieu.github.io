<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title><![CDATA[Latest posts for the topic "nginx - No buffer space available (105)"]]></title>
		<link>/hvaonline/posts/list/24.html</link>
		<description><![CDATA[Latest messages posted in the topic "nginx - No buffer space available (105)"]]></description>
		<generator>JForum - http://www.jforum.net</generator>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ Mình có 1 cái vps được cài centos 32bit, disk space 10Gb, RAM 512Mb, 1 core
cài đặt web server theo mô hình: client =&gt; nginx (proxy) =&gt; apache
Mình dùng ab để test performance với thông số <b>-n 2000 -c 300</b> thì gặp phải lỗi
<blockquote>socket: No buffer space available (105)&nbsp;
		</blockquote>
thử giảm xuống <b>-n 2000 -c 200</b> thì request được nhưng truy cập vào web thì báo lỗi 50x (500 502 503 504)
<blockquote>[alert] 32680#0: *1476165 socket() failed (105: No buffer space available) while connecting to upstream, client: <font color='yellow'>x.x.x.x</font>, server: <font color='yellow'>domain.com</font>, request: &quot;GET / HTTP/1.0&quot;, upstream: &quot;http://<font color='yellow'>x.x.x.x</font>:8080/&quot;, host: &quot;<font color='yellow'>domain.com</font>&quot;&nbsp;
		</blockquote>
//Những phần màu vàng là những đoạn đã bị thay đổi

file cấu hình nginx
<blockquote>#######################################################################
#
# This is the main Nginx configuration file.  
#
# More information about the configuration options is available on 
#   * the English wiki -<span class="link"> http://wiki.nginx.org/Main</span>
#   * the Russian documentation -<span class="link"> http://sysoev.ru/nginx/</span>
#
#######################################################################

#----------------------------------------------------------------------
# Main Module - directives that cover basic functionality
#
#  <span class="link"> http://wiki.nginx.org/NginxHttpMainModule</span>
#
#----------------------------------------------------------------------

<font color='red'>user              apache;
</font>worker_processes  1;
error_log  /var/log/nginx/error.log;
#error_log  /var/log/nginx/error.log  notice;
#error_log  /var/log/nginx/error.log  info;

pid        /var/run/nginx.pid;


#----------------------------------------------------------------------
# Events Module 
#
#  <span class="link"> http://wiki.nginx.org/NginxHttpEventsModule</span>
#
#----------------------------------------------------------------------

events {
    worker_connections  1024;
}


#----------------------------------------------------------------------
# HTTP Core Module
#
#  <span class="link"> http://wiki.nginx.org/NginxHttpCoreModule</span> 
#
#----------------------------------------------------------------------

http {
    server_tokens off;
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  0;
    #keepalive_timeout  65;

    #gzip  on;
    
    #
    # The default server
    #
    server {
        listen       80;
        server_name  127.0.0.1;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   /usr/share/nginx/html;
            index  index.php index.html index.htm;
        }

        error_page  404       =      /404.html;
        location = /404.html {
            root   /usr/share/nginx/html;
        }

        # wwwect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504 = /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass  <span class="link"> http://127.0.0.1;</span>
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }

    # Load config files from the /etc/nginx/conf.d directory
    include /etc/nginx/conf.d/default.conf;
    include /etc/nginx/conf.d/virtual/*.conf;
}
&nbsp;
		</blockquote>
//Giải thích luôn phần màu đỏ tại sao mình dùng user apache chứ không mặc định là nginx
Vì mình lọc ra các file tĩnh (hình ảnh, html, zip, rar ... etc ...) và cho tải bằng nginx với expires max
Chỉ có các link nội dung động mới cho chuyển tiếp qua apache (listen ở 1 port khác)
Vậy cách này có ưu nhược gì không, và có nên cho toàn bộ file đều chạy qua proxy hết không ? (vấn đề này đang thắc mắc nhưng chưa có tài liệu gì để tham khảo trả lời)

Thực tế hiện tại là server của mình vẫn luôn gặp phải lỗi này vì lượng truy cập đồng thời cũng khá cao
Bạn nào có thể giúp mình hướng giải quyết hoặc gợi ý cho mình được không.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264253</guid>
				<link>/hvaonline/posts/list/42486.html#264253</link>
				<pubDate><![CDATA[Tue, 29 May 2012 23:03:20]]> GMT</pubDate>
				<author><![CDATA[ jin9x]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ VPS bạn đang dùng cái gì vậy: http://people.redhat.com/~rjones/virt-what/?]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264257</guid>
				<link>/hvaonline/posts/list/42486.html#264257</link>
				<pubDate><![CDATA[Tue, 29 May 2012 23:40:15]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ Có 512Mb Ram mà vừa dùng cho kernel + daemon + nginx + apache (+ mysql) rồi phang nó kiểu đó thì "(105: No buffer space available)" là đúng rồi.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264266</guid>
				<link>/hvaonline/posts/list/42486.html#264266</link>
				<pubDate><![CDATA[Wed, 30 May 2012 00:34:42]]> GMT</pubDate>
				<author><![CDATA[ conmale]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>VPS bạn đang dùng cái gì vậy:<span class="link"> http://people.redhat.com/~rjones/virt-what/?&nbsp;</span>
		</blockquote>
openvz
<p></p>
		<cite class="blockquote">conmale wrote:</cite><br>
		<blockquote>Có 512Mb Ram mà vừa dùng cho kernel + daemon + nginx + apache (+ mysql) rồi phang nó kiểu đó thì "(105: No buffer space available)" là đúng rồi.&nbsp;
		</blockquote>
ban đầu em cũng đã nghĩ là do RAM, nhưng sau 1 thời gian cố gắng theo dõi
thì những lúc có lỗi xảy ra, em dùng lệnh top để kiểm tra thì RAM luôn đạt khoảng 60% (280mb), cao hơn 1 tí so với những lúc ko xảy ra lỗi.
hay cái buffer đó chạy cần 1 lượng RAM trống nào đó ?]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264268</guid>
				<link>/hvaonline/posts/list/42486.html#264268</link>
				<pubDate><![CDATA[Wed, 30 May 2012 01:53:33]]> GMT</pubDate>
				<author><![CDATA[ jin9x]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">jin9x wrote:</cite><br>
		<blockquote><p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>VPS bạn đang dùng cái gì vậy:<span class="link"> http://people.redhat.com/~rjones/virt-what/?&nbsp;</span>
		</blockquote>
openvz
&nbsp;
		</blockquote>
Bạn gửi kết quả `# cat /proc/user_beancounters` lên xem.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264269</guid>
				<link>/hvaonline/posts/list/42486.html#264269</link>
				<pubDate><![CDATA[Wed, 30 May 2012 02:21:40]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote><p></p>
		<cite class="blockquote">jin9x wrote:</cite><br>
		<blockquote><p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>VPS bạn đang dùng cái gì vậy:<span class="link"> http://people.redhat.com/~rjones/virt-what/?&nbsp;</span>
		</blockquote>
openvz
&nbsp;
		</blockquote>
Bạn gửi kết quả `# cat /proc/user_beancounters` lên xem.&nbsp;
		</blockquote>

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>cat /proc/user_beancounters
Version: 2.5
       uid  resource                     held              maxheld              barrier                limit              failcnt
   110148:  kmemsize                  6564392             14133253            134217728            154217728                    0
            lockedpages                     0                    5                  512                  512                    0
            privvmpages                 70601               116635               131072               131072                    0
            shmpages                      643                 3363                24576                24576                    2
            dummy                           0                    0                    0                    0                    0
            numproc                        50                  142                  500                  500                    0
            physpages                   30540                74687                    0  9223372036854775807                    0
            vmguarpages                     0                    0               131072               131072                    0
            oomguarpages                30541                74688               131072               131072                    0
            numtcpsock                     42                  500                  500                  500               250750
            numflock                       12                   33                  400                  600                    0
            numpty                          1                    2                   81                   81                    0
            numsiginfo                      0                   11                  512                  512                    0
            tcpsndbuf                 1048032              8539880              8388608              8888608              8122883
            tcprcvbuf                  559008              3931792              8388608              8888608                    0
            othersockbuf                32448               391552              8388608              8888608                    0
            dgramrcvbuf                     0                16944              8388608              8888608                    0
            numothersock                   36                  186                  500                  500                    0
            dcachesize                 563400              1031433              8388608              8888608                    0
            numfile                      1510                 2570                13056                13056                    0
            dummy                           0                    0                    0                    0                    0
            dummy                           0                    0                    0                    0                    0
            dummy                           0                    0                    0                    0                    0
            numiptent                      28                  500                  500                  500                 6553</pre>
		</div>]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264270</guid>
				<link>/hvaonline/posts/list/42486.html#264270</link>
				<pubDate><![CDATA[Wed, 30 May 2012 02:24:05]]> GMT</pubDate>
				<author><![CDATA[ jin9x]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ Cho server bị lỗi lại và kiểm tra thông tin trong file này xem giá trị `numtcpsock` và `tcpsndbuf` là bao nhiêu.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264273</guid>
				<link>/hvaonline/posts/list/42486.html#264273</link>
				<pubDate><![CDATA[Wed, 30 May 2012 02:46:20]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>Cho server bị lỗi lại và kiểm tra thông tin trong file này xem giá trị `numtcpsock` và `tcpsndbuf` là bao nhiêu.&nbsp;
		</blockquote>
em đã cho chạy <b>ab -n 2000 -c 200</b> (những lần trước dùng với option này đều gây lỗi)
và được nội dung file như sau
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>cat /proc/user_beancounters
Version: 2.5
       uid  resource                     held              maxheld              barrier                limit              failcnt
   110148:  kmemsize                  9732552             14133253            134217728            154217728                    0
            lockedpages                     0                    5                  512                  512                    0
            privvmpages                 87370               116635               131072               131072                    0
            shmpages                     1283                 3363                24576                24576                    2
            dummy                           0                    0                    0                    0                    0
            numproc                        61                  142                  500                  500                    0
            physpages                   46285                74687                    0  9223372036854775807                    0
            vmguarpages                     0                    0               131072               131072                    0
            oomguarpages                46286                74688               131072               131072                    0
            numtcpsock                    490                  500                  500                  500               254579
            numflock                       10                   33                  400                  600                    0
            numpty                          2                    2                   81                   81                    0
            numsiginfo                      0                   11                  512                  512                    0
            tcpsndbuf                 1264032              8539880              8388608              8888608              8122883
            tcprcvbuf                 1222000              3931792              8388608              8888608                    0
            othersockbuf                83552               391552              8388608              8888608                    0
            dgramrcvbuf                     0                16944              8388608              8888608                    0
            numothersock                   53                  186                  500                  500                    0
            dcachesize                 985011              1031433              8388608              8888608                    0
            numfile                      2150                 2570                13056                13056                    0
            dummy                           0                    0                    0                    0                    0
            dummy                           0                    0                    0                    0                    0
            dummy                           0                    0                    0                    0                    0
            numiptent                      28                  500                  500                  500                 6553</pre>
		</div>]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264275</guid>
				<link>/hvaonline/posts/list/42486.html#264275</link>
				<pubDate><![CDATA[Wed, 30 May 2012 03:14:49]]> GMT</pubDate>
				<author><![CDATA[ jin9x]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ Không thấy có dấu hiệu quá giới hạn buffer cho phép như rất gần giới hạn. Khả năng quá giới hạn rất có thể đã xảy ra.

Cách duy nhất là chỉnh nginx và apache để giảm số concurrent connections xuống và keepalive timeout xuống càng thấp càng tốt.

Xài mấy cái openVZ này thường không có mấy quyền tweak kernel parameters cho nên rất kẹt.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264291</guid>
				<link>/hvaonline/posts/list/42486.html#264291</link>
				<pubDate><![CDATA[Wed, 30 May 2012 05:16:52]]> GMT</pubDate>
				<author><![CDATA[ conmale]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">conmale wrote:</cite><br>
		<blockquote>Không thấy có dấu hiệu quá giới hạn buffer cho phép như rất gần giới hạn. Khả năng quá giới hạn rất có thể đã xảy ra.
&nbsp;
		</blockquote>
Nhìn cột `failcnt` thì thấy Nginx, Apache đã "đi quá giới hạn" nhiều lần rồi chứ anh. Cách tốt nhất để xác nhận là mở một cái terminal chia làm 3 regions:
1. tail -f /path/to/logfile | ccze
2. watch 'cat /proc/user_beancounters' 
3. chạy `ab`

là thấy ngay.
<p></p>
		<cite class="blockquote">conmale wrote:</cite><br>
		<blockquote>
Cách duy nhất là chỉnh nginx và apache để giảm số concurrent connections xuống và keepalive timeout xuống càng thấp càng tốt.

Xài mấy cái openVZ này thường không có mấy quyền tweak kernel parameters cho nên rất kẹt.&nbsp;
		</blockquote>
Mình không có OpenVZ ở đây để test, nhưng ngoài việc giảm concurrent connections, ép các unused connections được đóng sớm hơn, bạn thử cách này xem:<span class="link"> http://www.eth0.us/openvz-limits</span><span class="link"> http://zee.balogh.sk/?p=1722</span>
]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264332</guid>
				<link>/hvaonline/posts/list/42486.html#264332</link>
				<pubDate><![CDATA[Wed, 30 May 2012 22:25:41]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ Cách quanta đưa ra theo 2 link ở trên chỉ có thể được thực hiện nếu jin9x có quyền quản trị server chạy openvz hoặc được hỗ trợ từ nhà cung cấp. Ngoài cách sử dụng lệnh vzctl thì bạn có thể sửa trực tiếp trên file config của máy ảo đó.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264338</guid>
				<link>/hvaonline/posts/list/42486.html#264338</link>
				<pubDate><![CDATA[Wed, 30 May 2012 23:07:10]]> GMT</pubDate>
				<author><![CDATA[ somenuchi]]></author>
			</item>
			<item>
				<title>nginx - No buffer space available (105)</title>
				<description><![CDATA[ Sau khi search và đọc nhiều bài viết để cấu hình lại apache và nginx, mình có vài chỉnh sửa sau
nginx.conf
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>events {
    worker_connections  1024;
}
keepalive_timeout  3;</pre>
		</div>
httpd.conf
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 3
&lt;IfModule prefork.c&gt;
StartServers       1
MinSpareServers    1
MaxSpareServers    5
ServerLimit       10
MaxClients        10
MaxRequestsPerChild  200
&lt;/IfModule&gt;</pre>
		</div>
vps mình dùng prefork MPM

vậy có vấn đề gì không, đã thử lại với ab tool nhưng không thay đổi, vấn đề RAM ít nhưng chạy cùng lúc nginx và apache có ảnh hưởng gì lớn đến vấn đề này không ?

cảm ơn các bạn đã giúp. :)

<p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>Mình không có OpenVZ ở đây để test, nhưng ngoài việc giảm concurrent connections, ép các unused connections được đóng sớm hơn, bạn thử cách này xem:<span class="link"> http://www.eth0.us/openvz-limits</span><span class="link"> http://zee.balogh.sk/?p=1722</span>
&nbsp;
		</blockquote>
hình như mình không đủ quyền để chỉnh sửa các cấu hình này.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/42486.html#264357</guid>
				<link>/hvaonline/posts/list/42486.html#264357</link>
				<pubDate><![CDATA[Thu, 31 May 2012 07:26:36]]> GMT</pubDate>
				<author><![CDATA[ jin9x]]></author>
			</item>
	</channel>
</rss>
