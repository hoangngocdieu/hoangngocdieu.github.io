<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title><![CDATA[Latest posts for the topic "Backup database của zimbra mail chạy trên RedHat 5?"]]></title>
		<link>http://www.hvaonline.net/hvaonline/posts/list/24.html</link>
		<description><![CDATA[Latest messages posted in the topic "Backup database của zimbra mail chạy trên RedHat 5?"]]></description>
		<generator>JForum - http://www.jforum.net</generator>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ Cho tớ hỏi chút:

Tớ muốn backup database của zimbra mail chạy trên RedHat 5
Script như sau:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>#!/bin/sh

mySqlPassword=&quot;password&quot;
mySqlUser=&quot;root&quot;

#Start service mySQL if it is not running
mySQLStatus=`su - zimbra -c &quot;mysql.server status&quot; |gawk '{print $3}'`
if &#91; &quot;$mySQLStatus&quot; != &quot;running&quot; &#93;; then
su - zimbra -c 'mysql.server start --socket=/opt/zimbra/db/mysql.sock'
fi

#Backup zimbra mail's database
su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=$mySqlUser --password=$mySqlPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'</pre>
		</div>
Với script này, việc backup không thành công do mysqldump không hiểu tham số $mySqlUser và $mySqlPassword.

Nếu tớ hardcode: 
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=root --password=password --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'</pre>
		</div>
Thi việc backup diễn ra thành công.
Cậu có thể gọi ý cho tớ chỉnh sửa lại script để thực thi việc backup mà không cần hardcode được không?
]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#225915</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#225915</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 04:50:24]]> GMT</pubDate>
				<author><![CDATA[ neverwon]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">neverwon wrote:</cite><br>
		<blockquote>
Với script này, việc backup không thành công do mysqldump không hiểu tham số $mySqlUser và $mySqlPassword.
&nbsp;
		</blockquote>
Nguyên văn câu thông báo thế nào? User, password của bạn có ký tự gì đặc biệt không? Debug thử với <b>sh -x</b> sẽ thấy rõ hơn đấy.]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#225922</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#225922</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 06:23:17]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote><p></p>
		<cite class="blockquote">neverwon wrote:</cite><br>
		<blockquote>
Với script này, việc backup không thành công do mysqldump không hiểu tham số $mySqlUser và $mySqlPassword.
&nbsp;
		</blockquote>
Nguyên văn câu thông báo thế nào? User, password của bạn có ký tự gì đặc biệt không? Debug thử với <b>sh -x</b> sẽ thấy rõ hơn đấy.&nbsp;
		</blockquote>

Khi truyền tham số theo cách này:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>#Backup zimbra mail's database
 su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=$mySqlUser --password=$mySqlPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'</pre>
		</div>
thực thi script thì nhận được báo lỗi:
<blockquote>
[root@mail backup]# ./exportDB.sh
mysqldump: Got error: 1045: Access denied for user 'root'@'localhost' (using password: NO) when trying to connect
&nbsp;
		</blockquote>
 Lỗi này tương đuơng với việc thực thi 
<blockquote>
[root@mail backup]# su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$(date +&quot;%d%m%Y_%H%M%S&quot;).sql'
mysqldump: Got error: 1045: Access denied for user 'root'@'localhost' (using password: NO) when trying to connect
&nbsp;
		</blockquote>
Theo tớ hiểu, khi thực thi script exportDB.sh, tham số &quot;--user=$mySqlUser&quot; và &quot;--password=$mySqlPassword&quot; đã bị bỏ qua.

Tớ modify:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=root --password=$mySqlPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'</pre>
		</div>

<blockquote>
[root@mail backup]# ./exportDB.sh
mysqldump: Got error: 1045: Access denied for user 'root'@'localhost' (using password: NO) when trying to connect
&nbsp;
		</blockquote>

Tham số &quot;--password=$mySqlPassword&quot; đã bị bỏ qua khi thực thi script!!!

Khi hardcode:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=root --password=password --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'</pre>
		</div>
Script thực thi thành công, dữ liệu được backup đầy đủ:
<blockquote>
[root@mail backup]# ./exportDB.sh
[root@mail backup]# ll
total 1212
-rwxr-x--- 1 zimbra zimbra   1422 Nov 30 16:06 autoBackupZimbra.sh
-rw-r--r-- 1 root   root       34 Nov 30 10:46 domain_list.txt
-rwxr-x--- 1 zimbra zimbra   4314 Nov 30 14:20 export-acc-zcs.sh
-rwxr-x--- 1 root   root      500 Dec  1 09:15 exportDB.sh
-rwxr-x--- 1 zimbra zimbra   2017 Nov 30 09:53 import-acc-zcs.sh
-rwxr-x--- 1 root   root       72 Nov 30 14:47 ldapStatus.sh
-rwxr-x--- 1 root   root       98 Nov 30 15:27 mySQLStatus.sh
-rw-r----- 1 zimbra zimbra  15270 Nov 30 16:32 mysqldump.help.txt
-rwxr-x--- 1 root   root      223 Nov 30 11:07 test.sh
-rwxr-x--- 1 zimbra zimbra    404 Nov 30 09:53 uninstall.sh
-rw-r----- 1 zimbra zimbra 584606 Dec  1 09:16 zimbraBackup01122010_091648.sql
-rw-r----- 1 zimbra zimbra 584606 Nov 30 16:58 zimbraBackup30112010_165829.sql
-rwxr-x--- 1 zimbra zimbra     63 Nov 30 09:53 zimbraStatus.sh

&nbsp;
		</blockquote>

<blockquote>
[root@mail backup]# more zimbraBackup01122010_091648.sql
-- MySQL dump 10.11
--
-- Host: localhost    Database:
-- ------------------------------------------------------
-- Server version       5.0.90-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Current Database: `mboxgroup1`
--

CREATE DATABASE /*!32312 IF NOT EXISTS*/ `mboxgroup1` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `mboxgroup1`;

--
-- Table structure for table `appointment`
--

DROP TABLE IF EXISTS `appointment`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `appointment` (
  `mailbox_id` int(10) unsigned NOT NULL,
  `uid` varchar(255) NOT NULL,
  `item_id` int(10) unsigned NOT NULL,
  `start_time` datetime NOT NULL,
  `end_time` datetime default NULL,
  PRIMARY KEY  (`mailbox_id`,`uid`),
  UNIQUE KEY `i_item_id` (`mailbox_id`,`item_id`),
  CONSTRAINT `fk_appointment_item_id` FOREIGN KEY (`mailbox_id`, `item_id`) REFERENCES `mail_item` (`mailbox_id`, `id`) ON DELETE CASCADE,
  CONSTRAINT `fk_appointment_mailbox_id` FOREIGN KEY (`mailbox_id`) REFERENCES `zimbra`.`mailbox` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
&nbsp;
		</blockquote>





]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#225994</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#225994</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 20:23:01]]> GMT</pubDate>
				<author><![CDATA[ neverwon]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ Bạn vẫn chưa trả lời câu hỏi:
<blockquote>password của bạn có ký tự gì đặc biệt không?&nbsp;
		</blockquote>
Chèn thêm một dòng `echo $mySqlPassword` trước mysqldump rồi chạy `sh -x ./exportDB.sh` sẽ rõ hơn đấy.]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#225999</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#225999</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 20:45:34]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>Bạn vẫn chưa trả lời câu hỏi:
<blockquote>password của bạn có ký tự gì đặc biệt không?&nbsp;
		</blockquote>
Chèn thêm một dòng `echo $mySqlPassword` trước mysqldump rồi chạy `sh -x ./exportDB.sh` sẽ rõ hơn đấy.&nbsp;
		</blockquote>

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@mail backup&#93;# sh -x ./exportDB.sh
+ mySqlPassword=password
+ mySqlUser=root
++ su - zimbra -c 'mysql.server status'
++ gawk '{print $3}'
+ mySQLStatus=running
+ '&#91;' running '!=' running '&#93;'
+ echo 'mySQL password: ' password
mySQL password:  password
+ su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=$mySqlUser --password=$mySqlPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'
mysqldump: Got error: 1045: Access denied for user 'root'@'localhost' &#40;using password: NO&#41; when trying to connect</pre>
		</div>

password của user root chỉ bao gồm các ký tự thông thường (chữ cái và chữ số), không có ký tự đặc biệt nào (kiểu như #, % hay &...)

Tuy nhiên, tình huống này, theo như tớ hiểu, câu truy vấn đã được thực thi ở chế độ mặc định (user mặc định là root, không sử dụng password).

Phân biệt với tình huống có nhập password nhưng password không đúng:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@mail backup&#93;# su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=root --password=aaa --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'
mysqldump: Got error: 1045: Access denied for user 'root'@'localhost' &#40;using password: YES&#41; when trying to connect</pre>
		</div>]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226008</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226008</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 21:09:22]]> GMT</pubDate>
				<author><![CDATA[ neverwon]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ Bạn thêm tiếp -v (verbose) vào mysqldump rồi chạy lại sh -x xem nó bắn ra những gì.]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226021</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226021</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 22:00:31]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>Bạn thêm tiếp -v (verbose) vào mysqldump rồi chạy lại sh -x xem nó bắn ra những gì.&nbsp;
		</blockquote>

Để kiểu tham biến:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@mail backup&#93;# sh -x ./exportDB.sh
+ mySqlPassword=password
+ mySqlUser=root
++ su - zimbra -c 'mysql.server status'
++ gawk '{print $3}'
+ mySQLStatus=running
+ '&#91;' running '!=' running '&#93;'
+ echo 'mySQL password: ' password
mySQL password:  password
+ su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump -v --user=$mySqlUser --password=$mySqlPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'
-- Connecting to localhost...
mysqldump: Got error: 1045: Access denied for user 'root'@'localhost' &#40;using password: NO&#41; when trying to connect</pre>
		</div>
Không tạo được kết nối tới DB

Hardcode:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@mail backup&#93;# sh -x ./exportDB.sh
+ mySqlPassword=password
+ mySqlUser=root
++ su - zimbra -c 'mysql.server status'
++ gawk '{print $3}'
+ mySQLStatus=running
+ '&#91;' running '!=' running '&#93;'
+ echo 'mySQL password: ' password
mySQL password:  password
+ su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump -v --user=root --password=password --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql'

-- Retrieving table structure for table jiveExtComponentConf...
-- Sending SELECT query...
-- Retrieving rows...
-- Retrieving table structure for table jiveGroupProp...
-- Sending SELECT query...
-- Retrieving rows...</pre>
		</div>

Kết nối, truy xuất dữ liệu thành công.]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226025</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226025</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 22:33:20]]> GMT</pubDate>
				<author><![CDATA[ neverwon]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ vim có tính năng syntax highlighting, viết script nên chú ý là khi gọi biến sẽ có màu riêng thay vì màu của string bình thường.

Sửa: 
<font color='red'>--user=$mySqlUser --password=$mySqlPassword</font>

thành:
<font color='red'>--user=</font><font color='orange'>'</font><font color='violet'>$mySqlUser</font><font color='orange'>'</font> <font color='red'>--password=</font><font color='orange'>'</font><font color='violet'>$mySqlPassword</font><font color='orange'>'</font>
]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226030</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226030</link>
				<pubDate><![CDATA[Tue, 30 Nov 2010 22:57:37]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>vim có tính năng syntax highlighting, viết script nên chú ý là khi gọi biến sẽ có màu riêng thay vì màu của string bình thường.

Sửa: 
<font color='red'>--user=$mySqlUser --password=$mySqlPassword</font>

thành:
<font color='red'>--user=</font><font color='orange'>'</font><font color='violet'>$mySqlUser</font><font color='orange'>'</font> <font color='red'>--password=</font><font color='orange'>'</font><font color='violet'>$mySqlPassword</font><font color='orange'>'</font>
&nbsp;
		</blockquote>

Tớ switch sang user zimbra và thực thi script:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>#!/bin/sh
mySQLUser=&quot;root&quot;
mySQLPassword=&quot;password&quot;

/opt/zimbra/mysql/bin/mysqldump --user=$mySQLUser --password=$mySQLPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup.sql</pre>
		</div>

Quá trình backup diễn ra thành công!!!

Trong khi đứng ở user root để thực thi script:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>#!/bin/sh
mySQLUser=&quot;root&quot;
mySQLPassword=&quot;password&quot;

su - zimbra -c '/opt/zimbra/mysql/bin/mysqldump --user=$mySQLUser --password=$mySQLPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; /opt/backup/zimbraBackup.sql'</pre>
		</div>

<font color='red'>--user=$mySQLUser</font> và <font color='red'>--password=$mySQLPassword</font> bị bỏ qua!!!

Tớ nghĩ, vấn đề nằm ở trong cặp 'single quote'.
Khi đứng từ root, thực thi câu truy vấn gián tiếp thông qua <font color='yellow'>su - zimbra -c 'command'</font>, tham biến kiểu <font color='red'>--user=$mySQLUser</font> bị bỏ qua.
]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226051</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226051</link>
				<pubDate><![CDATA[Wed, 1 Dec 2010 02:51:01]]> GMT</pubDate>
				<author><![CDATA[ neverwon]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">neverwon wrote:</cite><br>
		<blockquote>
Tớ nghĩ, vấn đề nằm ở trong cặp 'single quote'.
&nbsp;
		</blockquote>
Đúng rồi. Có 2 cách: 1 là enclose tên biến với single quotes, 2 là dùng double quotes cho -c (--command) trong lệnh su.]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226052</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226052</link>
				<pubDate><![CDATA[Wed, 1 Dec 2010 03:11:49]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Backup database của zimbra mail chạy trên RedHat 5?</title>
				<description><![CDATA[ Đây là toàn bộ script <font color='cyan'>autoBackupZimbra.sh</font> của tớ:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>#!/bin/sh
#Stop zimbra service before backup &#40;if it is running&#41;
STATUS=`su - zimbra -c 'zmcontrol status |grep -i &quot;mailbox&quot;' | gawk '{print $2}'`
if &#91; &quot;$STATUS&quot; == &quot;Running&quot; &#93;; then
echo &quot;Stopping Zimbra service....&quot;
su - zimbra -c 'zmcontrol stop'
fi
echo &quot;.... Service Zimbra has been stopped&quot;

SCRIPT_FOLDER=&quot;/opt/backup&quot;
BACKUP_FOLDER=&quot;/opt/backup&quot;

mySqlPassword=`su - zimbra -c 'zmlocalconfig -s | grep &quot;mysql_root_password&quot;' | gawk '{print $3}'`
mySqlUser=&quot;root&quot;

#Start service LDAP if it is not running
ldapStatus=`su - zimbra -c &quot;ldap status | grep slapd&quot; |gawk '{print $2}'`
if &#91; &quot;$ldapStatus&quot; != &quot;running&quot; &#93;; then
echo &quot;Starting LDAP service...........&quot;
su - zimbra -c 'ldap start'
fi
echo &quot;..... Service LDAP has been started&quot;

#Export LDAP users
$SCRIPT_FOLDER/export-acc-zcs.sh

#Stop service LDAP
su - zimbra -c 'ldap stop'

#Start service mySQL if it is not running
mySQLStatus=`su - zimbra -c &quot;mysql.server status&quot; |gawk '{print $3}'`
if &#91; &quot;$mySQLStatus&quot; != &quot;running&quot; &#93;; then
echo &quot;Starting mysql service......&quot;
su - zimbra -c 'mysql.server start --socket=/opt/zimbra/db/mysql.sock'
fi
echo &quot;Service mysql has been started&quot;

#Backup zimbra mail's database
echo &quot;Starting backup database of Zimbra mail....&quot;
/opt/zimbra/mysql/bin/mysqldump --user=$mySqlUser --password=$mySqlPassword --socket=/opt/zimbra/db/mysql.sock --all-databases &gt; $BACKUP_FOLDER/zimbraBackup$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.sql
echo &quot;backup completed&quot;

#Stop mysql service
su - zimbra -c 'mysql.server stop --socket=/opt/zimbra/db/mysql.sock'

#Backup index and store
echo &quot;Starting backup index and store....&quot;
tar -cvf $BACKUP_FOLDER/backupZimbraStore$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.tar /opt/zimbra/store /opt/zimbra/index
echo &quot;... Backup completed&quot;

#Start zimbra service
START=`su - zimbra -c 'zmcontrol status |grep -i &quot;mailbox&quot;' |  gawk '{print $2}'`
if &#91; &quot;$START&quot; != &quot;Running&quot; &#93;; then
su - zimbra -c 'zmcontrol start'
fi
echo &quot;Completed tasks&quot;</pre>
		</div>

Còn đây là script <font color='orange'>export-acc-zcs.sh</font> tớ lấy từ<span class="link"> http://www.vavai.com,</span> có sửa đổi một chút để lấy toàn bộ accounts:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>#!/bin/sh

#Hapus Layar
clear

echo -e &quot;###################################################################################&quot;
echo -e &quot;# Zimbra export-acc-zcs.sh ver 0.0.2                                              #&quot;
echo -e &quot;# Skrip untuk export account Zimbra berikut profile dan password                  #&quot;
echo -e &quot;# Masim 'Vavai' Sugianto - vavai@vavai.com -<span class="link"> http://www.vavai.com</span>                 #&quot;
echo -e &quot;# Untuk saran dan pertanyaan silakan menggunakan Milis Komunitas Zimbra Indonesia #&quot;
echo -e &quot;# Link Komunitas :<span class="link"> http://www.zimbra.web.id</span> -<span class="link"> http://www.opensuse.or.id</span>           #&quot;
echo -e &quot;###################################################################################&quot;

# /* Variable untuk bold */
ibold=&quot;\033&#91;1m&quot;&quot;\n===&gt; &quot;
ebold=&quot;\033&#91;0m&quot;

FOLDER=&quot;/opt/backup&quot;

# /* Parameter */
#echo &quot;&quot;
#echo -n &quot;Enter Domain Name &#40;ex : vavai.com&#41; : &quot;
#read NAME_DOMAIN
#echo -n &quot;Enter path folder for exported account &#40;ex : /home/vavai/&#41; : &quot;
#read FOLDER

# /*export ldap user */
NAME_FILE=&quot;$FOLDER/zcs-acc-add$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.zmp&quot;
LDIF_FILE=&quot;$FOLDER/zcs-acc-mod$&#40;date +&quot;%d%m%Y_%H%M%S&quot;&#41;.ldif&quot;

rm -f $NAME_FILE
rm -f $LDIF_FILE

touch $NAME_FILE
touch $LDIF_FILE

#echo &quot;createDomain $NAME_DOMAIN&quot; &gt;&gt; $NAME_FILE

# /* Check Zimbra version */
VERSION=`su - zimbra -c 'zmcontrol -v'`;
ZCS_VER=&quot;/tmp/zcsver.txt&quot;
# get Zimbra LDAP password
ZIMBRA_LDAP_PASSWORD=`su - zimbra -c &quot;zmlocalconfig -s zimbra_ldap_password | cut -d ' ' -f3&quot;`

touch $ZCS_VER
echo $VERSION &gt; $ZCS_VER

echo -e $ibold&quot;Retrieve Zimbra User..............................&quot;$ebold

grep &quot;Release 5.&quot; $ZCS_VER
if &#91; $? = 0 &#93;; then
USERS=`su - zimbra -c 'zmprov gaa'`;
LDAP_MASTER_URL=`su - zimbra -c &quot;zmlocalconfig -s ldap_master_url | cut -d ' ' -f3&quot;`
fi

grep &quot;Release 6.&quot; $ZCS_VER
if &#91; $? = 0 &#93;; then
USERS=`su - zimbra -c 'zmprov -l gaa'`;
LDAP_MASTER_URL=&quot;ldapi:///&quot;
fi

echo -e $ibold&quot;Processing account, please wait..............................&quot;$ebold
# /* Proses insert account kedalam file hasil export */
for ACCOUNT in $USERS; do
NAME=`echo $ACCOUNT`;
DOMAIN=`echo $ACCOUNT | awk -F@ '{print $2}'`;
ACCOUNT=`echo $ACCOUNT | awk -F@ '{print $1}'`;
ACC=`echo $ACCOUNT | cut -d '.' -f1`

#if &#91; $NAME_DOMAIN == $DOMAIN &#93; ;
#Export all LDAP's users
if &#91; $DOMAIN == $DOMAIN &#93; ;
then
OBJECT=&quot;&#40;&&#40;objectClass=zimbraAccount&#41;&#40;mail=$NAME&#41;&#41;&quot;
dn=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep dn:`


displayName=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep displayName: | cut -d ':' -f2 | sed 's/^ *//g' | sed 's/ *$//g'`


givenName=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep givenName: | cut -d ':' -f2 | sed 's/^ *//g' | sed 's/ *$//g'`

userPassword=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep userPassword: | cut -d ':' -f3 | sed 's/^ *//g' | sed 's/ *$//g'`

cn=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep cn: | cut -d ':' -f2 | sed 's/^ *//g' | sed 's/ *$//g'`

initials=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep initials: | cut -d ':' -f2 | sed 's/^ *//g' | sed 's/ *$//g'`

sn=`/opt/zimbra/bin/ldapsearch -H $LDAP_MASTER_URL -w $ZIMBRA_LDAP_PASSWORD -D uid=zimbra,cn=admins,cn=zimbra -x $OBJECT | grep sn: | cut -d ':' -f2 | sed 's/^ *//g' | sed 's/ *$//g'`

	if &#91; $ACC == &quot;admin&quot; &#93; || &#91; $ACC == &quot;wiki&quot; &#93; || &#91; $ACC == &quot;galsync&quot; &#93; || &#91; $ACC == &quot;ham&quot; &#93; || &#91; $ACC == &quot;spam&quot; &#93;; then
    		echo &quot;Skipping system account, $NAME...&quot;
	else
		echo &quot;createAccount $NAME passwordtemp displayName '$displayName' givenName '$givenName' sn '$sn' initials '$initials' zimbraPasswordMustChange FALSE&quot; &gt;&gt; $NAME_FILE

    		echo &quot;$dn
changetype: modify
replace: userPassword
userPassword:: $userPassword
&quot; &gt;&gt; $LDIF_FILE
    		echo &quot;Adding account $NAME&quot;
	fi
else
	echo &quot;Skipping account $NAME&quot;
fi

done
echo -e $ibold&quot;All account has been exported sucessfully into $NAME_FILE and $LDIF_FILE...&quot;$ebold</pre>
		</div>

Tớ đã backup thành công.]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/36780.html#226054</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/36780.html#226054</link>
				<pubDate><![CDATA[Wed, 1 Dec 2010 04:04:57]]> GMT</pubDate>
				<author><![CDATA[ neverwon]]></author>
			</item>
	</channel>
</rss>
