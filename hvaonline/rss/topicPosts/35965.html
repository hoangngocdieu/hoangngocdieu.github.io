<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title><![CDATA[Latest posts for the topic "Về giới hạn của tham số file-max của kernel"]]></title>
		<link>/hvaonline/posts/list/24.html</link>
		<description><![CDATA[Latest messages posted in the topic "Về giới hạn của tham số file-max của kernel"]]></description>
		<generator>JForum - http://www.jforum.net</generator>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Hi all,

Thỉnh thoảng một con server của mình xuất hiện một loạt thông báo trong /var/log/messages

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>Sep 14 16:57:53 xxxxsrv kernel: VFS: file-max limit 65536 reached</pre>
		</div>

Thông báo này kéo dài trong khoảng 2, 3 phút, server down. Load average trong khoảng thời gian đó vọt lên cỡ 200 - 400. 

Mình đã kiểm tra lại tham số file-max trong /proc

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@xxxxsrv ~&#93;# cat /proc/sys/kernel/file-max
cat: /proc/sys/kernel/file-max: No such file or directory</pre>
		</div>

Dùng sysctl
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@xxxxsrv ~&#93;# sysctl -a | grep file-max
fs.file-max = 65536</pre>
		</div>

Phiên bản của nhân
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;user@xxxxsrv ~&#93;$ uname -ra
Linux db09srv.ho.fpt.vn 2.6.9-67.0.22.ELlargesmp #1 SMP Fri Jul 11 10:59:18 EDT 2008 x86_64 x86_64 x86_64 GNU/Linux</pre>
		</div>

Mình muốn hỏi mấy vấn đề:
- Có thể tăng giá trị file-max lên được không hay đây là giới hạn của hệ thống? Nếu như tăng lên thì lợi hại thế nào, liệu có thể giải quyết được vấn đề này không?

- Hiện tại mình đang nghi là có xảy ra hiện tượng memory leakage trên hệ thống nhưng đang chưa biết xử lý thế nào, debug ra sao?

Rất mong mọi người giúp đỡ.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221076</guid>
				<link>/hvaonline/posts/list/35965.html#221076</link>
				<pubDate><![CDATA[Sun, 19 Sep 2010 22:44:43]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>Hi all,

Thỉnh thoảng một con server của mình xuất hiện một loạt thông báo trong /var/log/messages

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>Sep 14 16:57:53 xxxxsrv kernel: VFS: file-max limit 65536 reached</pre>
		</div>

Thông báo này kéo dài trong khoảng 2, 3 phút, server down. Load average trong khoảng thời gian đó vọt lên cỡ 200 - 400. 
&nbsp;
		</blockquote>
Bạn kiểm tra xem có bị uninterruptible sleep không?
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>$ ps -eo pid,user,state,cmd | awk '$3 ~/&#91;RD&#93;/ { print $0 }'</pre>
		</div>
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
Mình đã kiểm tra lại tham số file-max trong /proc

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;root@xxxxsrv ~&#93;# cat /proc/sys/kernel/file-max
cat: /proc/sys/kernel/file-max: No such file or directory</pre>
		</div>
&nbsp;
		</blockquote>
Nó nằm ở:
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>$ cat /proc/sys/fs/file-max 
204883</pre>
		</div>
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
Mình muốn hỏi mấy vấn đề:
- Có thể tăng giá trị file-max lên được không hay đây là giới hạn của hệ thống? Nếu như tăng lên thì lợi hại thế nào, liệu có thể giải quyết được vấn đề này không?
&nbsp;
		</blockquote>
Câu trả lời là có vì nhìn vào cái output mặc định của mình thì thấy.
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
- Hiện tại mình đang nghi là có xảy ra hiện tượng memory leakage trên hệ thống nhưng đang chưa biết xử lý thế nào, debug ra sao?
&nbsp;
		</blockquote>
Bạn có thể check với valgrind.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221083</guid>
				<link>/hvaonline/posts/list/35965.html#221083</link>
				<pubDate><![CDATA[Mon, 20 Sep 2010 00:13:24]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Hi quanta,

Em muốn hỏi mấy thứ
1. uninterruptible sleep thì ảnh hưởng gì ở đây mà cần kiểm tra, trong trạng thái bình thường cũng có các uninterruptible sleep này cơ mà.

2. Việc tăng file-max lên thì có thể, nhưng đâu thể giải thích chung chung là như vậy được. Cái em quan tâm là việc này ảnh hưởng gì đến tính ổn định của hệ thống hay không?

]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221085</guid>
				<link>/hvaonline/posts/list/35965.html#221085</link>
				<pubDate><![CDATA[Mon, 20 Sep 2010 00:34:17]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Hi,

<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
Em muốn hỏi mấy thứ
1. uninterruptible sleep thì ảnh hưởng gì ở đây mà cần kiểm tra, trong trạng thái bình thường cũng có các uninterruptible sleep này cơ mà.
&nbsp;
		</blockquote>
Ảnh hưởng ở chỗ: nó có thể là nguyên nhân gây nên load average cao như vậy. Đã gọi là trạng thái bình thường thì không có process nào ở D state đâu (hoặc nếu có thì cũng chỉ 1, 2 cái là cùng).
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
2. Việc tăng file-max lên thì có thể, nhưng đâu thể giải thích chung chung là như vậy được. Cái em quan tâm là việc này ảnh hưởng gì đến tính ổn định của hệ thống hay không?
&nbsp;
		</blockquote>
file-max là số lượng file descriptors lớn nhất có thể mở trên hệ thống. Khi gặp tình trạng này, bạn thử dùng lsof xác định xem con số thực là bao nhiêu. Việc tăng nó lên 2^16 * 1.5 hoặc 2^17 chắc chắn là không ảnh hưởng gì đến tính ổn định của hệ thống cả. Vấn đề cần tìm hiểu là tại sao cái process kia nó lại mở nhiều fd đến vậy.

PS: hệ thống của bạn có bao nhiêu RAM vậy?]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221109</guid>
				<link>/hvaonline/posts/list/35965.html#221109</link>
				<pubDate><![CDATA[Mon, 20 Sep 2010 04:14:02]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Hi quanta,

Đây là một trường hợp phải debug thông qua log, do vậy em rất muốn hỏi các kinh nghiệm cần thiết vì không thể:
- Giả lập được tình huống đó trên thực tế vì thi thoảng mới xẩy ra tình huống đó nhưng đây là hệ thống most-critical nên cần phải giải quyết dứt điểm.
- Khi xuất hiện lỗi đó, average đột ngột tăng lên, hệ thống đờ đẫn ra và không thể nào control được.

Thêm nữa, nếu chỉ cố tăng file-max descriptor lên vô cùng thì em nghĩ chưa chắc đã giải quyết được vấn đề vì hoàn toàn có thể phòi ra một cái lỗi tương tự như đã từng xảy ra.

PS: máy chủ này 28GB RAM, đã cấu hình HugePages
]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221113</guid>
				<link>/hvaonline/posts/list/35965.html#221113</link>
				<pubDate><![CDATA[Mon, 20 Sep 2010 04:25:52]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Nguyên tắc của việc xử lí sự cố là loại trừ tất cả khả năng dẫn đến sự cố. Nếu bạn cứ ngồi đó mà băn khoăn xem thử có nên như thế không trong khi đã xác định được không thiết lập được tình huống thực tế là phi thực tế.
Câu hỏi là có thể tăng giá trị file-max lên được không thì anh Quanta đã trả lời rồi, vậy bạn cứ thử xem thế nào?
Thêm nữa, hệ thống đang chạy là hệ thống gì, kiểm tra xem có thể upgrade lên phiên bản mới không? Phiên bản cũ có gặp lỗi gì critical không? ....
Khi không thể xác định ngay thì cách duy nhất là...mò chứ còn gì nữa :- ) ]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221117</guid>
				<link>/hvaonline/posts/list/35965.html#221117</link>
				<pubDate><![CDATA[Mon, 20 Sep 2010 04:47:05]]> GMT</pubDate>
				<author><![CDATA[ mR.Bi]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>Hi quanta,

Đây là một trường hợp phải debug thông qua log, do vậy em rất muốn hỏi các kinh nghiệm cần thiết vì không thể:
- Giả lập được tình huống đó trên thực tế vì thi thoảng mới xẩy ra tình huống đó nhưng đây là hệ thống most-critical nên cần phải giải quyết dứt điểm.
- Khi xuất hiện lỗi đó, average đột ngột tăng lên, hệ thống đờ đẫn ra và không thể nào control được.
&nbsp;
		</blockquote>
Thế thì nên thiết lập một hệ thống monitor để khi load average chạm ngưỡng nào đó là alert ngay để còn kịp gõ command chứ để đến khi nó vọt lên vài trăm và <i>"không thể nào control được"</i> thì bó tay.
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
Thêm nữa, nếu chỉ cố tăng file-max descriptor lên vô cùng thì em nghĩ chưa chắc đã giải quyết được vấn đề vì hoàn toàn có thể phòi ra một cái lỗi tương tự như đã từng xảy ra.
&nbsp;
		</blockquote>
Thì mình đã nói là dựa vào kết quả lsof để mà tăng rồi mà, có ai nói tăng lên vô cùng đâu.
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
PS: máy chủ này 28GB RAM, đã cấu hình HugePages
&nbsp;
		</blockquote>
Nếu vậy thì trên lý thuyết bạn có thể tăng file-max lên thành 65536 * 28.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221118</guid>
				<link>/hvaonline/posts/list/35965.html#221118</link>
				<pubDate><![CDATA[Mon, 20 Sep 2010 04:56:38]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote><p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>Hi quanta,

Đây là một trường hợp phải debug thông qua log, do vậy em rất muốn hỏi các kinh nghiệm cần thiết vì không thể:
- Giả lập được tình huống đó trên thực tế vì thi thoảng mới xẩy ra tình huống đó nhưng đây là hệ thống most-critical nên cần phải giải quyết dứt điểm.
- Khi xuất hiện lỗi đó, average đột ngột tăng lên, hệ thống đờ đẫn ra và không thể nào control được.
&nbsp;
		</blockquote>
Thế thì nên thiết lập một hệ thống monitor để khi load average chạm ngưỡng nào đó là alert ngay để còn kịp gõ command chứ để đến khi nó vọt lên vài trăm và <i>"không thể nào control được"</i> thì bó tay.
&nbsp;
		</blockquote>

Đây là một ví dụ khi hệ thống gặp sự cố, output của lệnh #sar -a

<br>
			<div align="center" class="limitview"><img src='http://img291.imageshack.us/img291/7811/vaichuong.png' border="0" onload="maxImg(this, 500px);" /></div>

Tần suất xuất hiện lỗi ngày càng ]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221189</guid>
				<link>/hvaonline/posts/list/35965.html#221189</link>
				<pubDate><![CDATA[Tue, 21 Sep 2010 03:03:37]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Bạn đang dùng distro nào, sar phiên bản bao nhiêu vậy? sysstat version 7.0.2 trên CentOS của mình không có -a option. Hơn nữa, bạn không đưa tên cột mình cũng chẳng biết đằng nào mà lần.

PS: vậy là bạn vẫn gõ được command đấy chứ nhỉ?]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221191</guid>
				<link>/hvaonline/posts/list/35965.html#221191</link>
				<pubDate><![CDATA[Tue, 21 Sep 2010 03:47:22]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Output của sar -u

OS: RHEL 4.6 x64

PS: Gõ command sau khi restart]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221193</guid>
				<link>/hvaonline/posts/list/35965.html#221193</link>
				<pubDate><![CDATA[Tue, 21 Sep 2010 04:21:50]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Còn tên mấy cái cột? Tóm lại bạn đã thử tăng file-max chưa, có giải quyết được vấn đề không? Bạn có biện pháp để phát hiện ngay khi nó chớm bị chưa? Restart lại server rồi mà %system vẫn còn khủng thế kia hả bạn?]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221195</guid>
				<link>/hvaonline/posts/list/35965.html#221195</link>
				<pubDate><![CDATA[Tue, 21 Sep 2010 05:01:13]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;user@xxxxsrv ~&#93;$ uname -ra
Linux db09srv.ho.fpt.vn 2.6.9-67.0.22.ELlargesmp #1 SMP Fri Jul 11 10:59:18 EDT 2008 x86_64 x86_64 x86_64 GNU/Linux</pre>
		</div>
&nbsp;
		</blockquote>
Hình như bạn K4i này là người quen  :P 
Theo mình giờ phải thu nhỏ phạm vi nghi ngờ vào. Xem những ứng dụng chuyên biệt nào đang chạy (ví dụ như server này chỉ chạy db oracle thôi chẳng hạn), tìm xem có bug nào của ứng dụng này đẻ ra cái lỗi đó không?
Nếu vẫn không được thì phải mò:
-Log output của top và lsof ra file 1s 1 lần. Nhớ đặt rotate log không lại teo. Đành phải trâu bò tí vậy chứ biết sao :|
]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221493</guid>
				<link>/hvaonline/posts/list/35965.html#221493</link>
				<pubDate><![CDATA[Sun, 26 Sep 2010 00:21:15]]> GMT</pubDate>
				<author><![CDATA[ giobuon]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ kernel 2.6.9 là quá cũ rùi, nên sử dụng kernel từ 2.6.20 trở lên
có thể bạn đang xài ext2/3 có giới hạn số file ở một thư mục
nếu vậy có thể chuyển sang ext4 nó tốt hơn]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#221494</guid>
				<link>/hvaonline/posts/list/35965.html#221494</link>
				<pubDate><![CDATA[Sun, 26 Sep 2010 00:33:48]]> GMT</pubDate>
				<author><![CDATA[ panfider]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Đợt rồi lu bu quá, hôm nay update topic này phát.

1. Lỗi vẫn lặp. Sau lần cuối cùng lỗi này xuất hiện mình đã tăng tham số lên gấp đôi (65530 x 2). Chưa thấy hiện tượng gì xảy ra

2. 
<p></p>
		<cite class="blockquote">giobuon wrote:</cite><br>
		<blockquote><p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>&#91;user@xxxxsrv ~&#93;$ uname -ra
Linux db09srv.ho.fpt.vn 2.6.9-67.0.22.ELlargesmp #1 SMP Fri Jul 11 10:59:18 EDT 2008 x86_64 x86_64 x86_64 GNU/Linux</pre>
		</div>
&nbsp;
		</blockquote>
Hình như bạn K4i này là người quen  :P 
Theo mình giờ phải thu nhỏ phạm vi nghi ngờ vào. Xem những ứng dụng chuyên biệt nào đang chạy (ví dụ như server này chỉ chạy db oracle thôi chẳng hạn), tìm xem có bug nào của ứng dụng này đẻ ra cái lỗi đó không?
Nếu vẫn không được thì phải mò:
-Log output của top và lsof ra file 1s 1 lần. Nhớ đặt rotate log không lại teo. Đành phải trâu bò tí vậy chứ biết sao :|
&nbsp;
		</blockquote>

Bạn là người thứ hai biết con server này chạy Oracle :P. Nếu là người quen PM mình nhá :D. Top thì vẫn treo ở terminal suốt, có tắt đâu. Output của lsof trung bình cỡ khoảng 20k.

3. <blockquote>
ernel 2.6.9 là quá cũ rùi, nên sử dụng kernel từ 2.6.20 trở lên 
có thể bạn đang xài ext2/3 có giới hạn số file ở một thư mục 
nếu vậy có thể chuyển sang ext4 nó tốt hơn&nbsp;
		</blockquote>
Ô cứ nói thay là thay được đó bạn. Có những thứ không dám nghĩ đến việc thay đấy...]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#222441</guid>
				<link>/hvaonline/posts/list/35965.html#222441</link>
				<pubDate><![CDATA[Fri, 8 Oct 2010 23:52:44]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ Có thể là bug của Oracle. Bạn vào Metalink search thử 5861703 xem.]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#222456</guid>
				<link>/hvaonline/posts/list/35965.html#222456</link>
				<pubDate><![CDATA[Sat, 9 Oct 2010 04:48:52]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">quanta wrote:</cite><br>
		<blockquote>Có thể là bug của Oracle. Bạn vào Metalink search thử 5861703 xem.&nbsp;
		</blockquote>

Doc ID 5861703, this bug is fixed in 10.2.0.4. 

<span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>system@PROD1&gt; select version from v$instance;

VERSION
-----------------
10.2.0.4.0</pre>
		</div>

@quanta: FYI]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#222459</guid>
				<link>/hvaonline/posts/list/35965.html#222459</link>
				<pubDate><![CDATA[Sat, 9 Oct 2010 04:58:37]]> GMT</pubDate>
				<author><![CDATA[ K4i]]></author>
			</item>
			<item>
				<title>Về giới hạn của tham số file-max của kernel</title>
				<description><![CDATA[ <p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>
1. Lỗi vẫn lặp. Sau lần cuối cùng lỗi này xuất hiện mình đã tăng tham số lên gấp đôi (65530 x 2). Chưa thấy hiện tượng gì xảy ra.
&nbsp;
		</blockquote>
Lúc này thông báo là <i>"file-max limit 65536 reached"</i> hay 131072?
<p></p>
		<cite class="blockquote">K4i wrote:</cite><br>
		<blockquote>Output của lsof trung bình cỡ khoảng 20k.&nbsp;
		</blockquote>
Bạn tìm xem process nào mở nhiều fd nhất, là bao nhiêu, có liên quan đến Oracle không?



]]></description>
				<guid isPermaLink="true">/hvaonline/posts/list/35965.html#222463</guid>
				<link>/hvaonline/posts/list/35965.html#222463</link>
				<pubDate><![CDATA[Sat, 9 Oct 2010 05:22:01]]> GMT</pubDate>
				<author><![CDATA[ quanta]]></author>
			</item>
	</channel>
</rss>
